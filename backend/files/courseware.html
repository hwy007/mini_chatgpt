<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700,700italic&subset=latin,cyrillic-ext,cyrillic,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; --title-bar-height: 20px; }
.mac-os-11 { --title-bar-height: 28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
h1, h2, h3, h4, h5 { white-space: pre-wrap; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
thead, tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
svg { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; border-color: transparent !important; padding-top: 0px !important; padding-bottom: 0px !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  #write > p:nth-child(1) { margin-top: 0px; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
  figure { overflow-x: visible; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.reversefootnote { font-family: ui-monospace, sans-serif; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex: 2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; overflow-wrap: anywhere; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }
mjx-container { break-inside: avoid; }
.md-alert.md-alert-note { border-left-color: rgb(9, 105, 218); }
.md-alert.md-alert-important { border-left-color: rgb(130, 80, 223); }
.md-alert.md-alert-warning { border-left-color: rgb(154, 103, 0); }
.md-alert.md-alert-tip { border-left-color: rgb(31, 136, 61); }
.md-alert.md-alert-caution { border-left-color: rgb(207, 34, 46); }
.md-alert { padding: 0px 1em; margin-bottom: 16px; color: inherit; border-left: 0.25em solid rgb(0, 0, 0); }
.md-alert-text-note { color: rgb(9, 105, 218); }
.md-alert-text-important { color: rgb(130, 80, 223); }
.md-alert-text-warning { color: rgb(154, 103, 0); }
.md-alert-text-tip { color: rgb(31, 136, 61); }
.md-alert-text-caution { color: rgb(207, 34, 46); }
.md-alert-text { font-size: 0.9rem; font-weight: 700; }
.md-alert-text svg { fill: currentcolor; position: relative; top: 0.125em; margin-right: 1ch; overflow: visible; }
.md-alert-text-container::after { content: attr(data-text); text-transform: capitalize; pointer-events: none; margin-right: 1ch; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


/* meyer reset -- http://meyerweb.com/eric/tools/css/reset/ , v2.0 | 20110126 | License: none (public domain) */

@include-when-export url(https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700,700italic&subset=latin,cyrillic-ext,cyrillic,latin-ext);

/* =========== */

/* pt-serif-regular - latin */
/* pt-serif-italic - latin */
/* pt-serif-700 - latin */
/* pt-serif-700italic - latin */
:root {
	--active-file-bg-color: #dadada;
	--active-file-bg-color: rgba(32, 43, 51, 0.63);
	--active-file-text-color: white;
	--bg-color: #f3f2ee;
	--text-color: #1f0909;
	--control-text-color: #444;
	--rawblock-edit-panel-bd: #e5e5e5;

	--select-text-bg-color: rgba(32, 43, 51, 0.63);
  --select-text-font-color: white;
}

pre {
	--select-text-bg-color: #36284e;
	--select-text-font-color: #fff;
}

html {
	font-size: 16px;
	-webkit-font-smoothing: antialiased;
}

html, body {
	background-color: #f3f2ee;
	font-family: "PT Serif", 'Times New Roman', Times, serif;
	color: #1f0909;
	line-height: 1.5em;
}

/*#write {
	overflow-x: auto;
    max-width: initial;
	padding-left: calc(50% - 17em);
    padding-right: calc(50% - 17em);
}

@media (max-width: 36em) {
 	#write {
 		padding-left: 1em;
    	padding-right: 1em;
 	}
}*/

#write {
	max-width: 40em;
}

@media only screen and (min-width: 1400px) {
	#write {
			max-width: 914px;
	}
}

ol li {
	list-style-type: decimal;
	list-style-position: outside;
}
ul li {
	list-style-type: disc;
	list-style-position: outside;
}

ol,
ul {
	list-style: none;
}

blockquote,
q {
	quotes: none;
}
blockquote:before,
blockquote:after,
q:before,
q:after {
	content: '';
	content: none;
}
table {
	border-collapse: collapse;
	border-spacing: 0;
}
/* styles */

/* ====== */

/* headings */

h1,
h2,
h3,
h4,
h5,
h6 {
	font-weight: bold;
}
h1 {
	font-size: 1.875em;
	/*30 / 16*/
	line-height: 1.6em;
	/* 48 / 30*/
	margin-top: 2em;
}
h2,
h3 {
	font-size: 1.3125em;
	/*21 / 16*/
	line-height: 1.15;
	/*24 / 21*/
	margin-top: 2.285714em;
	/*48 / 21*/
	margin-bottom: 1.15em;
	/*24 / 21*/
}
h3 {
	font-weight: normal;
}
h4 {
	font-size: 1.125em;
	/*18 / 16*/
	margin-top: 2.67em;
	/*48 / 18*/
}
h5,
h6 {
	font-size: 1em;
	/*16*/
}
h1 {
	border-bottom: 1px solid;
	margin-bottom: 1.875em;
	padding-bottom: 0.8125em;
}
/* links */

a {
	text-decoration: none;
	color: #065588;
}
a:hover,
a:active {
	text-decoration: underline;
}
/* block spacing */

p,
blockquote,
.md-fences {
	margin-bottom: 1.5em;
}
h1,
h2,
h3,
h4,
h5,
h6 {
	margin-bottom: 1.5em;
}
/* blockquote */

blockquote {
	font-style: italic;
	border-left: 5px solid;
	margin-left: 2em;
	padding-left: 1em;
}
/* lists */

ul,
ol {
	margin: 0 0 1.5em 1.5em;
}
/* tables */
.md-meta,.md-before, .md-after {
	color:#999;
}

table {
	margin-bottom: 1.5em;
	/*24 / 16*/
	font-size: 1em;
	/* width: 100%; */
}
thead th,
tfoot th {
	padding: .25em .25em .25em .4em;
	text-transform: uppercase;
}
th {
	text-align: left;
}
td {
	vertical-align: top;
	padding: .25em .25em .25em .4em;
}

code,
.md-fences {
	background-color: #dadada;
}

code {
	padding-left: 2px;
	padding-right: 2px;
}

.md-fences {
	margin-left: 2em;
	margin-bottom: 3em;
	padding-left: 1ch;
	padding-right: 1ch;
}

pre,
code,
tt {
	font-size: .875em;
	line-height: 1.714285em;
}
/* some fixes */

h1 {
	line-height: 1.3em;
	font-weight: normal;
	margin-bottom: 0.5em;
}

p + ul,
p + ol{
	margin-top: .5em;
}

h3 + ul,
h4 + ul,
h5 + ul,
h6 + ul,
h3 + ol,
h4 + ol,
h5 + ol,
h6 + ol {
	margin-top: .5em;
}

li > ul,
li > ol {
	margin-top: inherit;
	margin-bottom: 0;
}

li ol>li {
	list-style-type: lower-alpha;
}

li li ol>li{
	list-style-type: lower-roman;
}

h2,
h3 {
	margin-bottom: .75em;
}
hr {
	border-top: none;
	border-right: none;
	border-bottom: 1px solid;
	border-left: none;
}
h1 {
	border-color: #c5c5c5;
}
blockquote {
	border-color: #bababa;
	color: #656565;
}

blockquote ul,
blockquote ol {
	margin-left:0;
}

.ty-table-edit {
	background-color: transparent;
}
thead {
	background-color: #dadada;
}
tr:nth-child(even) {
	background: #e8e7e7;
}
hr {
	border-color: #c5c5c5;
}
.task-list{
	padding-left: 1rem;
}

.md-task-list-item {
	padding-left: 1.5rem;
	list-style-type: none;
}

.md-task-list-item > input:before {
	content: '\221A';
	display: inline-block;
	width: 1.25rem;
  	height: 1.6rem;
	vertical-align: middle;
	text-align: center;
	color: #ddd;
	background-color: #F3F2EE;
}

.md-task-list-item > input:checked:before,
.md-task-list-item > input[checked]:before{
	color: inherit;
}

#write pre.md-meta-block {
	min-height: 1.875rem;
	color: #555;
	border: 0px;
	background: transparent;
	margin-top: -4px;
	margin-left: 1em;
	margin-top: 1em;
}

.md-image>.md-meta {
	color: #9B5146;
}

.md-image>.md-meta{
	font-family: Menlo, 'Ubuntu Mono', Consolas, 'Courier New', 'Microsoft Yahei', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', serif;
}


#write>h3.md-focus:before{
	left: -1.5rem;
	color:#999;
	border-color:#999;
}
#write>h4.md-focus:before{
	left: -1.5rem;
	top: .25rem;
	color:#999;
	border-color:#999;
}
#write>h5.md-focus:before{
	left: -1.5rem;
	top: .0.3125rem;
	color:#999;
	border-color:#999;
}
#write>h6.md-focus:before{
	left: -1.5rem;
	top: 0.3125rem;
	color:#999;
	border-color:#999;
}

.md-toc:focus .md-toc-content{
	margin-top: 19px;
}

.md-toc-content:empty:before{
	color: #065588;
}
.md-toc-item {
	color: #065588;
}
#write div.md-toc-tooltip {
	background-color: #f3f2ee;
}

#typora-sidebar {
	background-color: #f3f2ee;
	-webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.375);
  	box-shadow: 0 6px 12px rgba(0, 0, 0, 0.375);
}

.pin-outline #typora-sidebar {
	background: inherit;
	box-shadow: none;
	border-right: 1px dashed;
}

.pin-outline #typora-sidebar:hover .outline-title-wrapper {
	border-left:1px dashed;
}

.outline-item:hover {
  background-color: #dadada;
  border-left: 28px solid #dadada;
  border-right: 18px solid #dadada;
}

.typora-node .outline-item:hover {
  	border-right: 28px solid #dadada;
}

.outline-expander:before {
  content: "\f0da";
  font-family: FontAwesome;
  font-size:14px;
  top: 1px;
}

.outline-expander:hover:before,
.outline-item-open>.outline-item>.outline-expander:before {
  content: "\f0d7";
}

.modal-content {
	background-color: #f3f2ee;
}

.auto-suggest-container ul li {
	list-style-type: none;
}

/** UI for electron */

.megamenu-menu,
#top-titlebar, #top-titlebar *,
.megamenu-content {
	background: #f3f2ee;
	color: #1f0909;
}

.megamenu-menu-header {
	border-bottom: 1px dashed #202B33;
}

.megamenu-menu {
	box-shadow: none;
	border-right: 1px dashed;
}

header, .context-menu, .megamenu-content, footer {
	font-family: "PT Serif", 'Times New Roman', Times, serif;
    color: #1f0909;
}

#megamenu-back-btn {
	color: #1f0909;
	border-color: #1f0909;
}

.megamenu-menu-header #megamenu-menu-header-title:before {
	color: #1f0909;
}

.megamenu-menu-list li a:hover, .megamenu-menu-list li a.active {
	color: inherit;
	background-color: #e8e7df;
}

.long-btn:hover {
	background-color: #e8e7df;
}

#recent-file-panel tbody tr:nth-child(2n-1) {
    background-color: transparent !important;
}

.megamenu-menu-panel tbody tr:hover td:nth-child(2) {
    color: inherit;
}

.megamenu-menu-panel .btn {
	background-color: #D2D1D1;
}

.btn-default {
	background-color: transparent;
}

.typora-sourceview-on #toggle-sourceview-btn,
.ty-show-word-count #footer-word-count {
	background: #c7c5c5;
}

#typora-quick-open {
    background-color: inherit;
}

.md-diagram-panel {
	margin-top: 8px;
}

.file-list-item-file-name {
	font-weight: initial;
}

.file-list-item-summary {
	opacity: 1;
}

.file-list-item {
	color: #777;
}

.file-list-item.active {
	background-color: inherit;
	color: black;
}

.ty-side-sort-btn.active {
	background-color: inherit;
}

.file-list-item.active .file-list-item-file-name  {
	font-weight: bold;
}

.file-list-item{
    opacity:1 !important;
}

.file-library-node.active>.file-node-background{
	background-color: rgba(32, 43, 51, 0.63);
	background-color: var(--active-file-bg-color);
}

.file-tree-node.active>.file-node-content{
	color: white;
	color: var(--active-file-text-color);
}

.md-task-list-item>input {
	margin-left: -1.7em;
	margin-top: calc(1rem - 12px);
	-webkit-appearance: button;
}

input {
	border: 1px solid #aaa;
}

.megamenu-menu-header #megamenu-menu-header-title,
.megamenu-menu-header:hover, 
.megamenu-menu-header:focus {
	color: inherit;
}

.dropdown-menu .divider {
	border-color: #e5e5e5;
	opacity: 1;
}

/* https://github.com/typora/typora-issues/issues/2046 */
.os-windows-7 strong,
.os-windows-7 strong  {
	font-weight: 760;
}

.ty-preferences .btn-default {
	background: transparent;
}

.ty-preferences .window-header {
	border-bottom: 1px dashed #202B33;
	box-shadow: none;
}

#sidebar-loading-template, #sidebar-loading-template.file-list-item {
	color: #777;
}

.searchpanel-search-option-btn.active {
	background: #777;
	color: white;
}

.export-detail, .light .export-detail, 
.light .export-item.active, 
.light .export-items-list-control {
	background: #e0e0e0;
	border-radius: 2px;
	font-weight: 700;
	color: inherit
}


mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG2"] path[data-c], mjx-container[jax="SVG2"] use[data-c] {
  stroke-width: 3;
}

g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}

.MathJax g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}
mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
							stroke-width: 0;
						}
</style><title>LangChain 1.1 + MCP Agent开发实战</title>
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><p>&nbsp;</p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512091834833.png" alt="1b29bf01197a27bbb67de0c7003311e2" style="zoom:50%;" /></p><h2 id='大模型技术入门与agent开发实战'><span>大模型技术入门与Agent开发实战</span></h2><h1 id='langchain-11-+-mcp-agent开发实战'><span>LangChain 1.1 + MCP Agent开发实战</span></h1><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n5"><a class="md-toc-inner" href="#大模型技术入门与agent开发实战">大模型技术入门与Agent开发实战</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n6"><a class="md-toc-inner" href="#langchain-11-+-mcp-agent开发实战">LangChain 1.1 + MCP Agent开发实战</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1794"><a class="md-toc-inner" href="#一langchain-1x技术生态介绍">一、LangChain 1.x技术生态介绍</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n83"><a class="md-toc-inner" href="#1-langchain-1x全面拥抱-react-agent-开发范式">1. LangChain 1.x：全面拥抱 React Agent 开发范式</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n169"><a class="md-toc-inner" href="#11-演进背景告别api-碎片化时代">1.1 演进背景：告别“API 碎片化”时代</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n96"><a class="md-toc-inner" href="#12-核心范式react-架构的标准化">1.2 核心范式：ReAct 架构的标准化</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n108"><a class="md-toc-inner" href="#13-核心-api-createagent易用性与强大的统一">1.3 核心 API <code>create_agent</code>：易用性与强大的统一</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n168"><a class="md-toc-inner" href="#14-技术价值与趋势对齐">1.4 技术价值与趋势对齐</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n178"><a class="md-toc-inner" href="#2-langchain-1x-系统生态全面重构">2. LangChain 1.x 系统生态全面重构</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n181"><a class="md-toc-inner" href="#21-底层架构升级langgraph-成为新一代-agent-运行时runtime">2.1 底层架构升级：LangGraph 成为新一代 Agent 运行时（Runtime）</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n192"><a class="md-toc-inner" href="#22-架构模式升级deep-agents-与-multi-agent-模板化">2.2 架构模式升级：Deep Agents 与 Multi-Agent 模板化</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n327"><a class="md-toc-inner" href="#23-开发与运维升级langsmith-全生命周期管理与-agent-builder">2.3 开发与运维升级：LangSmith 全生命周期管理与 Agent Builder</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n445"><a class="md-toc-inner" href="#3-langchain-1x-大杀器中间件功能介绍">3. LangChain 1.x 大杀器：中间件功能介绍</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n448"><a class="md-toc-inner" href="#31-诞生背景破解-react-架构的黑盒悖论">3.1 诞生背景：破解 ReAct 架构的“黑盒悖论”</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n464"><a class="md-toc-inner" href="#32-核心机制生命周期钩子-lifecycle-hooks">3.2 核心机制：生命周期钩子 (Lifecycle Hooks)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n481"><a class="md-toc-inner" href="#33-四大核心应用场景">3.3 四大核心应用场景</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n512"><a class="md-toc-inner" href="#34-内置中间件与自定义接口">3.4 内置中间件与自定义接口</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n616"><a class="md-toc-inner" href="#4-langchain-11-版本更新情况介绍">4. LangChain 1.1 版本更新情况介绍</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n619"><a class="md-toc-inner" href="#41-核心变革一生态架构的彻底解耦-decoupling">4.1 核心变革一：生态架构的彻底解耦 (Decoupling)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n631"><a class="md-toc-inner" href="#42-核心变革二工具调用标准化-standardized-tool-calling">4.2 核心变革二：工具调用标准化 (Standardized Tool Calling)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n640"><a class="md-toc-inner" href="#43-核心变革三pydantic-v2-原生支持与性能跃升">4.3 核心变革三：Pydantic V2 原生支持与性能跃升</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n647"><a class="md-toc-inner" href="#44-核心变革四异步与流式优先-async--streaming-first">4.4 核心变革四：异步与流式优先 (Async &amp; Streaming First)</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n660"><a class="md-toc-inner" href="#二langchain-11-+-mcp-+-deepseek-v32企业级项目开发说明">二、LangChain 1.1 + MCP + DeepSeek-V3.2企业级项目开发说明</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n684"><a class="md-toc-inner" href="#1-mini-chatgpt项目演示">1. mini ChatGPT项目演示</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n673"><a class="md-toc-inner" href="#2-mini-chatgpt核心功能点介绍">2. mini ChatGPT核心功能点介绍</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n768"><a class="md-toc-inner" href="#3-项目实战价值从api-调包侠进阶为全栈-ai-产品工程师">3. 项目实战价值：从“API 调包侠”进阶为“全栈 AI 产品工程师”</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n771"><a class="md-toc-inner" href="#31-掌握-2025-年黄金三角技术栈实战">3.1 掌握 2025 年“黄金三角”技术栈实战</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n781"><a class="md-toc-inner" href="#32-沉浸式体验企业级开发标准与-vibe-coding-新范式">3.2 沉浸式体验“企业级开发标准”与 Vibe Coding 新范式</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n788"><a class="md-toc-inner" href="#33-跑通从-0-到-1的全链路产品闭环">3.3 跑通“从 0 到 1”的全链路产品闭环</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n799"><a class="md-toc-inner" href="#34-重塑-ai-时代的产品化思维">3.4 重塑 AI 时代的“产品化思维”</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n856"><a class="md-toc-inner" href="#4-mini-chatgpt-开发思路规划">4. mini ChatGPT 开发思路规划</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n861"><a class="md-toc-inner" href="#41-总体架构蓝图">4.1 总体架构蓝图</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n869"><a class="md-toc-inner" href="#42-阶段一构建核心-agent-内核-the-mvp">4.2 阶段一：构建核心 Agent 内核 (The MVP)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n898"><a class="md-toc-inner" href="#43-阶段二引入-mcp-打造智能体操作系统-the-evolution">4.3 阶段二：引入 MCP 打造智能体操作系统 (The Evolution)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n827"><a class="md-toc-inner" href="#5-参考资料">5. 参考资料</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n966"><a class="md-toc-inner" href="#三mini-chatgpt-第一阶段开发实操">三、mini ChatGPT 第一阶段开发实操</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n971"><a class="md-toc-inner" href="#1-项目初始化与结构规划">1. 项目初始化与结构规划</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n975"><a class="md-toc-inner" href="#2-环境与依赖安装">2. 环境与依赖安装</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1066"><a class="md-toc-inner" href="#3-密钥配置-backendenv">3. 密钥配置 (backend/.env)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1123"><a class="md-toc-inner" href="#4-编写硬编码工具-backendtoolspy">4. 编写“硬编码”工具 (backend/tools.py)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1078"><a class="md-toc-inner" href="#5-构建-agent-内核-backendagentpy">5. 构建 Agent 内核 (backend/agent.py)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1101"><a class="md-toc-inner" href="#6-配置可视化环境-langgraphjson">6. 配置可视化环境 (langgraph.json)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1013"><a class="md-toc-inner" href="#7-启动见证-agent-的思考-实操环节">7. 启动！见证 Agent 的思考 (实操环节)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n39"><a class="md-toc-inner" href="#8-选学基于vide-coding完成前端功能开发">8. 【选学】基于Vide Coding完成前端功能开发</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1231"><a class="md-toc-inner" href="#9mini-chatgpt前端功能开发">9.mini ChatGPT前端功能开发</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1259"><a class="md-toc-inner" href="#10-消息管理模块开发实战-the-memory-system">10. 消息管理模块开发实战 (The Memory System)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1356"><a class="md-toc-inner" href="#101-创建历史管理脚本-backendhistorypy">10.1 创建历史管理脚本 (<code>backend/history.py</code>)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1286"><a class="md-toc-inner" href="#11-借助-fastapi-自定义后端功能接口">11. 借助 FastAPI 自定义后端功能接口</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1291"><a class="md-toc-inner" href="#111-创建后端服务脚本-backendserverpy">11.1 创建后端服务脚本 (<code>backend/server.py</code>)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1315"><a class="md-toc-inner" href="#12启动与验证">12.启动与验证</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1801"><a class="md-toc-inner" href="#四mcpmodel-context-protocol技术回顾">四、MCP（model context protocol）技术回顾</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1807"><a class="md-toc-inner" href="#1智能体开发核心技术---mcp">1.智能体开发核心技术—MCP</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1808"><a class="md-toc-inner" href="#11-function-calling技术回顾">1.1 <strong>Function calling技术回顾</strong></a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1817"><a class="md-toc-inner" href="#12-function-calling公开课介绍">1.2 <strong>Function calling公开课介绍</strong></a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1819"><a class="md-toc-inner" href="#13-function-calling能力从何而来">1.3 <strong>Function calling能力从何而来</strong></a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1831"><a class="md-toc-inner" href="#14-mcp技术本质function-calling的更高层实现">1.4 MCP技术本质：Function calling的更高层实现</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1836"><a class="md-toc-inner" href="#15-mcp技术带来的智能体开发效率革命">1.5 MCP技术带来的智能体开发效率革命</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1844"><a class="md-toc-inner" href="#2-mcp服务器接入示例">2. MCP服务器接入示例</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1858"><a class="md-toc-inner" href="#3-mcp工具标准接入流程">3. MCP工具标准接入流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1869"><a class="md-toc-inner" href="#4-mcp服务器与客户端">4. MCP服务器与客户端</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1870"><a class="md-toc-inner" href="#41-mcp服务器server与客户端client概念介绍">4.1 MCP服务器（server）与客户端（client）概念介绍</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1876"><a class="md-toc-inner" href="#42-mcp服务器集合">4.2 MCP服务器集合</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1892"><a class="md-toc-inner" href="#5-mcp与function-calling技术对比介绍">5. MCP与Function calling技术对比介绍</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1916"><a class="md-toc-inner" href="#6-mcp技术生态">6. MCP技术生态</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1804"><a class="md-toc-inner" href="#五mini-chatgpt-第二阶段开发实操打造智能体操作系统">五、mini ChatGPT 第二阶段开发实操：打造智能体操作系统</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1384"><a class="md-toc-inner" href="#1-架构设计与数据层构建-data-layer">1. 架构设计与数据层构建 (Data Layer)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1389"><a class="md-toc-inner" href="#11-核心概念回顾mcp-的两种连接形态">1.1 核心概念回顾：MCP 的两种连接形态</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1410"><a class="md-toc-inner" href="#12-构建-mcp-工具知识库-mcpregistryjson">1.2 构建 MCP 工具知识库 (<code>mcp_registry.json</code>)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1427"><a class="md-toc-inner" href="#13-设计用户配置存储-mcpconfigjson">1.3 设计用户配置存储 (<code>mcp_config.json</code>)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1477"><a class="md-toc-inner" href="#2-核心业务逻辑开发mcp-管理器-business-logic-layer">2. 核心业务逻辑开发：MCP 管理器 (Business Logic Layer)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1489"><a class="md-toc-inner" href="#21-依赖导入与-pydantic-模型定义">2.1 依赖导入与 Pydantic 模型定义</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1494"><a class="md-toc-inner" href="#22-核心类构建与基础-crud">2.2 核心类构建与基础 CRUD</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1499"><a class="md-toc-inner" href="#23-健壮的连接测试-testtoolconnection">2.3 健壮的连接测试 (<code>test_tool_connection</code>)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1515"><a class="md-toc-inner" href="#24-实现-ai-智能推荐-airecommendtools">2.4 实现 AI 智能推荐 (<code>ai_recommend_tools</code>)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1520"><a class="md-toc-inner" href="#25-运行时配置生成-getactiveconfig">2.5 运行时配置生成 (<code>get_active_config</code>)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1614"><a class="md-toc-inner" href="#3-agent-核心重构实现动态工厂模式-core-refactoring">3. Agent 核心重构：实现动态工厂模式 (Core Refactoring)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1619"><a class="md-toc-inner" href="#31-核心痛点与架构升级">3.1 核心痛点与架构升级</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1635"><a class="md-toc-inner" href="#32-代码重构实战-backendagentpy">3.2 代码重构实战 (<code>backend/agent.py</code>)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1676"><a class="md-toc-inner" href="#4-接口层升级开放-mcp-管理能力-interface-layer">4. 接口层升级：开放 MCP 管理能力 (Interface Layer)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1788"><a class="md-toc-inner" href="#41-定义数据契约pydantic-模型设计">4.1 定义数据契约：Pydantic 模型设计</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1698"><a class="md-toc-inner" href="#42-实现管理接口打造-agent-的控制面板">4.2 实现管理接口：打造 Agent 的“控制面板”</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1711"><a class="md-toc-inner" href="#43-核心重构聊天接口的动态化改造">4.3 核心重构：聊天接口的“动态化”改造</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1722"><a class="md-toc-inner" href="#44-完整代码交付最终版-serverpy">4.4 完整代码交付：最终版 <code>server.py</code></a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1745"><a class="md-toc-inner" href="#5-全链路联调与验收-integration-testing">5. 全链路联调与验收 (Integration Testing)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1549"><a class="md-toc-inner" href="#课程完整介绍">课程完整介绍</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1551"><a class="md-toc-inner" href="#12月新班新增内容">12月新班新增内容</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1553"><a class="md-toc-inner" href="#部分课程成果演示">部分课程成果演示</a></span></p></div><ul><li><p><span>课件领取</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512091835408.png" alt="a76e6238d7b180153150578da261689d" style="zoom:50%;" /></p></li></ul><h2 id='一langchain-1x技术生态介绍'><span>一、LangChain 1.x技术生态介绍</span></h2><h3 id='1-langchain-1x全面拥抱-react-agent-开发范式'><span>1. LangChain 1.x：全面拥抱 React Agent 开发范式</span></h3><blockquote><p><strong><span>核心摘要</span></strong><span>：LangChain 1.x 的发布标志着 AI 开发框架从“链式堆叠（Chains）”向“自主智能体（Agents）”的彻底转型。通过标准化的 </span><code>create_agent</code><span> API，LangChain 统一了过去碎片化的开发接口，确立了 </span><strong><span>ReAct (Reasoning + Acting)</span></strong><span> 作为大模型应用开发的各种事实标准。</span></p></blockquote><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101751609.png" alt="image-20251210175117544" style="zoom:50%;" /></p><h4 id='11-演进背景告别api-碎片化时代'><span>1.1 演进背景：告别“API 碎片化”时代</span></h4><p><span>	</span><span>在 LangChain 0.x 时代，开发者面临着极高的认知负担。为了适配不同的模型能力和场景，官方提供了十几种不同的 Agent 构造函数（如 </span><code>initialize_agent</code><span>、</span><code>create_structured_chat_agent</code><span>、</span><code>create_openai_functions_agent</code><span> 等）。</span></p><p><span>这种“烟囱式”的设计导致了两个核心痛点：</span></p><ol><li><p><strong><span>选型困难</span></strong><span>：开发者不知道在什么场景下该用哪种 Agent。</span></p></li><li><p><strong><span>维护成本高</span></strong><span>：每种 Agent 底层的 Prompt 策略和解析逻辑都不尽相同，难以统一管理。</span></p></li></ol><ul><li><p><span>LangChain 1.x 的核心变革：</span></p></li></ul><p><span>	</span><span>官方废弃了大量冗余接口，将核心能力收敛至标准化的 create_agent API（以及更底层的 LangGraph 构建方式）。这不仅仅是代码层面的重构，更是对 “大模型原生能力” 的信任——现代大模型已经具备了强大的原生工具调用（Tool Calling）能力，框架层不再需要编写复杂的 Prompt Hacks 来“教”模型怎么调用工具。</span></p><h4 id='12-核心范式react-架构的标准化'><span>1.2 核心范式：ReAct 架构的标准化</span></h4><p><span>LangChain 1.x 全面拥抱的 </span><strong><span>ReAct (Reasoning + Acting)</span></strong><span> 范式，是目前构建通用智能体的最佳实践。</span></p><ul><li><p><strong><span>Reasoning (推理/思考)</span></strong><span>：模型根据当前任务，进行思维链（CoT）推导，规划下一步该做什么。</span></p></li><li><p><strong><span>Acting (行动/执行)</span></strong><span>：模型生成具体的工具调用指令（如查询数据库、调用 API）。</span></p></li><li><p><strong><span>Observation (观察/反馈)</span></strong><span>：框架执行工具，并将结果（Output）回传给模型。</span></p></li><li><p><strong><span>Loop (循环)</span></strong><span>：模型根据反馈结果，决定是继续思考、继续行动，还是输出最终答案。</span></p></li></ul><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101744436.png" alt="img" style="zoom:50%;" /></p><p><span>LangChain 1.x 将这一复杂的</span><strong><span>“认知闭环”</span></strong><span>封装在了 </span><code>create_agent</code><span> 内部，使得开发者只需关注</span><strong><span>“模型选型”</span></strong><span>和</span><strong><span>“工具定义”</span></strong><span>，而无需手写复杂的循环逻辑。</span></p><ul><li><p><span>DeepSeek-V3.2 ReAct推理范式</span></p></li></ul><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101747339.png" alt="0023e2a5-5b4f-4c67-bf47-487db3702623" style="zoom:50%;" /></p><h4 id='13-核心-api-createagent易用性与强大的统一'><span>1.3 核心 API </span><code>create_agent</code><span>：易用性与强大的统一</span></h4><p><span>	</span><code>create_agent</code><span> 是 LangChain 1.x 中构建智能体的“万能钥匙”。它能够自动适配不同模型的底层特性（如 OpenAI 风格的 Function Calling 或 DeepSeek 的 JSON Mode），对外提供统一的开发体验。并且调用简单，仅需几行代码即可完成一个简易的Agent搭建：</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101748957.png" alt="image-20251210174839899" style="zoom:50%;" /></p><p><span>此外，LangChain 1.0中还新增了支持多模态的全新消息格式、简化了包的命名以及添加中间件等功能。</span></p><h4 id='14-技术价值与趋势对齐'><span>1.4 技术价值与趋势对齐</span></h4><p><span>LangChain 1.x 的这一升级，完美契合了当下大模型技术发展的三个主流趋势：</span></p><ol><li><p><strong><span>多步工具调用 (Multi-step Tool Use)</span></strong><span>：现代业务场景（如自动化订票、复杂数据分析）往往需要 Agent 连续调用多个工具。ReAct 范式天然支持这种</span><strong><span>“规划-执行-再规划”</span></strong><span>的复杂链路。</span></p></li><li><p><strong><span>模型能力原生化</span></strong><span>：随着 DeepSeek-V3、Qwen 2.5 等开源模型对 Tool Calling 的支持越来越好，LangChain 1.x 通过做减法，让模型本身的智能得以最大化释放，减少了框架层的干扰（Less Middleware, More Intelligence）。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101749040.png" alt="image-20251210174929967" style="zoom:50%;" /></p></li><li><p><strong><span>图（Graph）架构的铺垫</span></strong><span>：虽然 </span><code>create_agent</code><span> 提供了高层封装，但 LangChain 1.x 底层已全面引入图论理念。这为后续升级到 </span><strong><span>LangGraph</span></strong><span>（实现更复杂的状态机和多智能体协作）打下了坚实基础。</span></p></li></ol><h3 id='2-langchain-1x-系统生态全面重构'><span>2. LangChain 1.x 系统生态全面重构</span></h3><blockquote><p><strong><span>核心摘要</span></strong><span>：LangChain 1.x 不再仅仅是一个 Python 库，而是一套完整的</span><strong><span>企业级 Agent 操作系统</span></strong><span>。最终形成了以 </span><strong><span>LangGraph 为内核、LangChain为核心开发工具、Deep Agents 为模版、LangSmith 为运维控制台</span></strong><span>的铁三角生态。</span></p></blockquote><h4 id='21-底层架构升级langgraph-成为新一代-agent-运行时runtime'><span>2.1 底层架构升级：LangGraph 成为新一代 Agent 运行时（Runtime）</span></h4><p><span>	</span><span>在 LangChain 0.x 时代，核心抽象是 </span><code>Chain</code><span>（链）。链本质上是有向无环图（DAG），它像瀑布一样，数据单向流动，一旦开始就很难回头。这对于简单的问答够用，但对于需要</span><strong><span>循环（Loop）、反思（Reflection）、记忆（Memory）</span></strong><span>的复杂 Agent 来说，链的架构捉襟见肘。</span></p><p><span>	</span><span>而在LangChain 1.0发布时官方正式确立 LangGraph 为 Agent 开发的底层架构。LangChain 库本身退居为“组件库”（提供模型接口、工具封装），而 LangGraph 接管了“大脑”的编排工作。</span></p><ul><li><p><strong><span>从 DAG 到 Cyclic Graph（循环图）</span></strong><span>：LangGraph 允许开发者定义“节点（Node）”和“边（Edge）”，最关键的是支持</span><strong><span>循环</span></strong><span>。Agent 可以思考 </span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.181ex" role="img" focusable="false" viewBox="0 -511 1000 522" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.025ex;"><defs><path id="MJX-3-TEX-N-2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="2192" xlink:href="#MJX-3-TEX-N-2192"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">→</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">\rightarrow</script><span> 执行 </span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.181ex" role="img" focusable="false" viewBox="0 -511 1000 522" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.025ex;"><defs><path id="MJX-3-TEX-N-2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="2192" xlink:href="#MJX-3-TEX-N-2192"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">→</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">\rightarrow</script><span> 发现错误 </span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.181ex" role="img" focusable="false" viewBox="0 -511 1000 522" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.025ex;"><defs><path id="MJX-3-TEX-N-2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="2192" xlink:href="#MJX-3-TEX-N-2192"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">→</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">\rightarrow</script><span> </span><strong><span>回到思考步骤重试</span></strong><span>。这种循环能力是构建高可靠性 Agent 的基石。</span></p></li><li><p><strong><span>State Management（状态管理）</span></strong><span>：LangGraph 引入了全局 </span><code>State</code><span>（状态机）概念。所有的上下文、记忆、中间变量都存储在 State 中，在不同节点间流转。这解决了以往 Agent 记忆管理混乱的问题。</span></p></li><li><p><strong><span>Human-in-the-loop（人机协同）</span></strong><span>：LangGraph 原生支持在图的执行过程中“暂停”，等待人类审批或输入后再继续。这对于金融、医疗等高风险场景的企业级 Agent 至关重要。</span></p></li></ul><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101801935.png" alt="image-20251210180136880" style="zoom:50%;" /></p><p><span>而需要注意的是，LangChain目前主推的create_agent本质上也是一个图结构，只不过可以通过create_agent这个更高层的接口进行调用。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101804764.png" alt="image-20251210180440718" style="zoom:50%;" /></p><h4 id='22-架构模式升级deep-agents-与-multi-agent-模板化'><span>2.2 架构模式升级：Deep Agents 与 Multi-Agent 模板化</span></h4><p><span>	</span><span>而随着单体 Agent 能力遇到瓶颈，</span><strong><span>Multi-Agent（多智能体协作）</span></strong><span> 成为解决复杂问题的必经之路。LangChain 1.x 引入了 </span><strong><span>Deep Agents</span></strong><span> 理念及一系列标准化的 Multi-Agent 架构模板。</span></p><ul><li><p><strong><span>Deep Agents 概念</span></strong><span>：它指代那些具有深层推理能力、能够自主拆解复杂任务的 Agent 系统。它们不再是简单的指令执行者，而是具备特定角色（Role）的专家。</span></p></li><li><p><strong><span>标准化协作模式</span></strong><span>：LangChain 1.x 提供了开箱即用的 Multi-Agent 模板（基于 LangGraph 实现），企业无需从零设计复杂的通信协议：</span></p><ul><li><p><strong><span>Supervisor Pattern（主管模式）</span></strong><span>：一个“主管 Agent”负责派活，指挥底下的“代码 Agent”、“搜索 Agent”协同工作。</span></p></li><li><p><strong><span>Hierarchical Teams（层级团队模式）</span></strong><span>：模拟公司组织架构，部门与部门之间进行任务交接。</span></p></li><li><p><strong><span>Network Pattern（网络模式）</span></strong><span>：Agent 之间地位平等，通过广播或点对点通信协作。</span></p></li></ul></li></ul><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101805400.png" alt="image-20251210180539330" style="zoom:50%;" /></p><ul><li><p><span>LangGraph、LangChain、DeepAgents三者关系：</span></p></li></ul><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101806928.png" alt="image-20251210180611859" style="zoom:50%;" /></p><h4 id='23-开发与运维升级langsmith-全生命周期管理与-agent-builder'><span>2.3 开发与运维升级：LangSmith 全生命周期管理与 Agent Builder</span></h4><p><span>如果说 LangGraph 是引擎，那么 </span><strong><span>LangSmith</span></strong><span> 就是这台法拉利的仪表盘和控制台。在 1.x 生态中，LangSmith 的地位被空前拔高，它不仅负责运维，更开始介入“无代码开发”。</span></p><ul><li><p><strong><span>DevOps 基础设施（监控与调试）</span></strong><span>：</span></p><ul><li><p><strong><span>可视化 Tracing</span></strong><span>：在 Agent 开发中，一次任务可能包含几十次 LLM 调用和工具执行。LangSmith 能将这些复杂的调用链以“全链路树状图”的形式展示出来，让开发者一眼看出 Agent 在哪一步“变笨了”或“死循环了”。</span></p></li><li><p><strong><span>Dataset Evaluation（数据集评测）</span></strong><span>：企业上线 Agent 前，必须进行回归测试。LangSmith 允许开发者上传“金标准”问答对，自动评估 Agent 的准确率、召回率。</span></p></li></ul><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101808285.png" alt="image-20250624190228537" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101808438.png" alt="image-20251028175752261 (1)" style="zoom:50%;" /></p></li><li><p><strong><span>重磅新功能：Agent Builder（AI 编写 AI）</span></strong></p><ul><li><p><strong><span>背景</span></strong><span>：为了进一步降低 Agent 开发门槛，LangChain 推出了 </span><strong><span>Agent Builder</span></strong><span>（目前处于 Public Beta 阶段）。</span></p></li><li><p><strong><span>核心逻辑</span></strong><span>：这是一个</span><strong><span>“Text-to-Agent”</span></strong><span>的开发环境。开发者无需写 Python 代码，只需用自然语言描述：“我需要一个能查阅 Google 新闻并撰写简报的助手，遇到付费墙要自动跳过”。</span></p></li><li><p><strong><span>底层原理</span></strong><span>：Agent Builder 会自动理解需求，生成基于 </span><strong><span>LangGraph</span></strong><span> 的标准架构代码。</span></p></li><li><p><strong><span>价值</span></strong><span>：</span></p><ol><li><p><strong><span>快速原型（Rapid Prototyping）</span></strong><span>：产品经理可以在 5 分钟内生成一个可运行的 Agent 原型。</span></p></li><li><p><strong><span>代码导出（Code Export）</span></strong><span>：不同于其他低代码平台的封闭性，Agent Builder 生成的 Agent 可以直接</span><strong><span>导出为 Python 代码</span></strong><span>。工程师可以在此基础上进行二次开发和私有化部署。</span></p></li></ol></li></ul><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101809726.png" alt="image-20251210180908653" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101809463.png" alt="image-20251210180920383" style="zoom:50%;" /></p></li></ul><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101809102.png" alt="image-20251210180935031" style="zoom:46%;" /></p><h3 id='3-langchain-1x-大杀器中间件功能介绍'><span>3. LangChain 1.x 大杀器：中间件功能介绍</span></h3><blockquote><p><strong><span>核心摘要</span></strong><span>：如果说 ReAct 范式赋予了 Agent “自主思考”的能力，那么中间件（Middleware）系统则赋予了开发者</span><strong><span>“上帝视角”的控制权</span></strong><span>。它通过一套标准化的</span><strong><span>钩子（Hooks）机制</span></strong><span>，允许开发者在 Agent 思考、行动、反馈的每一个关键生命周期节点插入自定义逻辑，从而将“黑盒”变成“白盒”。</span></p></blockquote><h4 id='31-诞生背景破解-react-架构的黑盒悖论'><span>3.1 诞生背景：破解 ReAct 架构的“黑盒悖论”</span></h4><p><span>在 LangChain 1.0 之前，运行一个 Agent（尤其是 ReAct 类型的 Agent）往往是一种“发射后不管”的体验。一旦调用 </span><code>agent.invoke()</code><span>，模型就开始自主循环：思考 </span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.181ex" role="img" focusable="false" viewBox="0 -511 1000 522" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.025ex;"><defs><path id="MJX-3-TEX-N-2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="2192" xlink:href="#MJX-3-TEX-N-2192"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">→</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">\rightarrow</script><span> 调工具 </span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.181ex" role="img" focusable="false" viewBox="0 -511 1000 522" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.025ex;"><defs><path id="MJX-3-TEX-N-2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="2192" xlink:href="#MJX-3-TEX-N-2192"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">→</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">\rightarrow</script><span> 观察 </span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.181ex" role="img" focusable="false" viewBox="0 -511 1000 522" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.025ex;"><defs><path id="MJX-3-TEX-N-2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="2192" xlink:href="#MJX-3-TEX-N-2192"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">→</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">\rightarrow</script><span> 再思考。</span></p><p><span>在这个过程中，开发者面临三大痛点：</span></p><ol><li><p><strong><span>过程不可见</span></strong><span>：不知道模型为什么选错了工具，也不知道中间产生了什么幻觉。</span></p></li><li><p><strong><span>状态不可改</span></strong><span>：无法在模型调用工具前临时修改参数（例如：强制将“明天”替换为具体日期）。</span></p></li><li><p><strong><span>风险不可控</span></strong><span>：无法在模型执行高危操作（如删除数据库）前进行拦截或人工审批。</span></p></li></ol><p><span>正是为了解决这些问题，LangChain 1.0 引入了中间件系统。这并非 LangChain 独创，而是工业级 Agent 框架的共识：</span></p><ul><li><p><strong><span>Google ADK (Agent Development Kit)</span></strong><span>：提供了类似的生命周期回调，允许在规划（Planning）和执行（Execution）阶段注入逻辑。</span></p></li><li><p><strong><span>阿里 AgentScope</span></strong><span>：内置了强大的 </span><code>Hook</code><span> 系统，支持在 </span><code>reply</code><span>（回复）和 </span><code>act</code><span>（行动）前后挂载自定义函数，用于多智能体间的消息拦截与修改。</span></p></li></ul><h4 id='32-核心机制生命周期钩子-lifecycle-hooks'><span>3.2 核心机制：生命周期钩子 (Lifecycle Hooks)</span></h4><p><span>LangChain 1.0 的中间件本质上是一系列</span><strong><span>拦截器</span></strong><span>，它们按顺序执行，像洋葱皮一样包裹着 Agent 的核心逻辑。核心钩子包括：</span></p><ol><li><p><strong><code>before_agent</code></strong><span>：在 Agent 启动初期执行。常用于初始化用户画像、加载长期记忆或设置全局 Session ID。</span></p></li><li><p><strong><code>before_model</code><span> (关键)</span></strong><span>：在将 Prompt 发送给大模型</span><strong><span>之前</span></strong><span>触发。</span></p><ul><li><p><em><span>作用</span></em><span>：修改 Prompt（如注入动态上下文）、检查输入敏感词、甚至直接拦截请求返回缓存结果。</span></p></li></ul></li><li><p><strong><code>after_model</code></strong><span>：在大模型返回 Response </span><strong><span>之后</span></strong><span>，但在解析工具调用</span><strong><span>之前</span></strong><span>触发。</span></p><ul><li><p><em><span>作用</span></em><span>：修正模型的输出格式错误、记录 Token 消耗、检测模型是否输出了违禁内容。</span></p></li></ul></li><li><p><strong><code>before_tools</code><span> / </span><code>after_tools</code></strong><span>：在工具执行的前后触发。这是实现“人机协同（Human-in-the-loop）”的最佳位置。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101744285.png" alt="img" style="zoom:75%;" /></p></li></ol><h4 id='33-四大核心应用场景'><span>3.3 四大核心应用场景</span></h4><p><span>中间件的引入，让 Agent 开发从“写 Prompt”升级为“治理系统”。其核心能力可归纳为 </span><strong><span>M.M.C.E</span></strong><span>：</span></p><ul><li><p><strong><span>1. Monitor (监控与观测)</span></strong></p><ul><li><p><strong><span>全链路追踪</span></strong><span>：自动将每一次思考和工具调用的输入输出上报到 LangSmith 或 Datadog。</span></p></li><li><p><strong><span>成本计算</span></strong><span>：实时计算当前会话消耗的 Token 数，超出预算通过中间件强制终止。</span></p></li></ul></li><li><p><strong><span>2. Modify (动态修正)</span></strong></p><ul><li><p><strong><span>上下文压缩</span></strong><span>：当对话历史过长时，</span><code>SummarizationMiddleware</code><span> 可自动触发摘要，防止 Context Window 溢出。</span></p></li><li><p><strong><span>Prompt 注入</span></strong><span>：根据用户当前的地理位置或时间，在 </span><code>before_model</code><span> 阶段动态向 System Prompt 注入 &quot;Current Time: 2025-12-10&quot;。</span></p></li></ul></li><li><p><strong><span>3. Control (流程控制)</span></strong></p><ul><li><p><strong><span>Human-in-the-Loop (HITL)</span></strong><span>：在执行关键工具（如 </span><code>transfer_money</code><span>）前，通过中间件挂起（Suspend）Agent，发送审批请求给人类管理员，获批后恢复运行。</span></p></li><li><p><strong><span>重试与回退</span></strong><span>：当检测到工具调用报错时，自动切换备用模型或重试，而无需修改 Agent 核心代码。</span></p></li></ul></li><li><p><strong><span>4. Enforce (安全与合规)</span></strong></p><ul><li><p><strong><span>PII 过滤</span></strong><span>：自动检测并掩盖用户输入中的手机号、身份证等敏感信息（Redaction）。</span></p></li><li><p><strong><span>输出护栏</span></strong><span>：强制检查模型输出是否包含竞争对手名称或不合规建议。</span></p></li></ul></li></ul><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101814578.png" alt="Gemini_Generated_Image_fl7nbrfl7nbrfl7n" style="zoom:50%;" /></p><h4 id='34-内置中间件与自定义接口'><span>3.4 内置中间件与自定义接口</span></h4><p><span>LangChain 1.0 官方内置了一批生产就绪的中间件，开发者可以开箱即用：</span></p><figure class='table-figure'><table><thead><tr><th><strong><span>内置中间件</span></strong></th><th><strong><span>功能描述</span></strong></th></tr></thead><tbody><tr><td><strong><code>HumanInTheLoopMiddleware</code></strong></td><td><span>在特定工具调用前暂停，等待人工反馈。</span></td></tr><tr><td><strong><code>SummarizationMiddleware</code></strong></td><td><span>自动管理上下文窗口，对超长历史进行摘要。</span></td></tr><tr><td><strong><code>PIIMiddleware</code></strong></td><td><span>敏感信息（PII）过滤与脱敏。</span></td></tr><tr><td><strong><code>RateLimiter</code></strong></td><td><span>限制 API 调用频率，防止超额。</span></td></tr></tbody></table></figure><p><span>此外LangChain 1.x还提供了强大的自定义中间件开发接口（Developer API），LangChain 提供了极简的</span><strong><span>装饰器（Decorator）</span></strong><span>风格接口，让开发者像写 Flask 路由一样定义中间件：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain</span>.<span class="cm-property">middleware</span> <span class="cm-keyword">import</span> <span class="cm-variable">before_model</span>, <span class="cm-variable">after_tools</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 定义一个自定义中间件：防止模型“摸鱼”</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@before_model</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">anti_lazy_middleware</span>(<span class="cm-variable">state</span>, <span class="cm-variable">config</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 检查 System Prompt，强制注入激励语</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">state</span>[<span class="cm-string">"messages"</span>][<span class="cm-number">0</span>].<span class="cm-property">content</span> <span class="cm-operator">+=</span> <span class="cm-string">"\n请深呼吸，这对我很重要，请一步步思考。"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">state</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 定义一个工具审计中间件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@after_tools</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">audit_log_middleware</span>(<span class="cm-variable">tool_output</span>, <span class="cm-variable">tool_name</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"审计日志: 工具 </span>{<span class="cm-variable">tool_name</span>}<span class="cm-string"> 执行完毕，结果长度: </span>{<span class="cm-builtin">len</span>(<span class="cm-builtin">str</span>(<span class="cm-variable">tool_output</span>))}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">tool_output</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 395px;"></div><div class="CodeMirror-gutters" style="display: none; height: 395px;"></div></div></div></pre><h3 id='4-langchain-11-版本更新情况介绍'><span>4. LangChain 1.1 版本更新情况介绍</span></h3><blockquote><p><strong><span>技术背景</span></strong><span>：如果说 LangChain 1.0的发布标志着它从“实验性玩具”走向了“稳定 API”，那么 1.1 阶段则标志着它完成了</span><strong><span>企业级中间件</span></strong><span>的下一块拼图——</span><strong><span>生态解耦与标准化</span></strong><span>。</span></p></blockquote><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101825038.png" alt="image-20251210182539965" style="zoom:50%;" /></p><h4 id='41-核心变革一生态架构的彻底解耦-decoupling'><span>4.1 核心变革一：生态架构的彻底解耦 (Decoupling)</span></h4><p><span>在早期版本中，LangChain 是一个臃肿的“单体应用”，安装一个 </span><code>langchain</code><span> 包会附带上百个不必要的依赖（如 numpy, pandas 等）。1.1 版本完成了彻底的</span><strong><span>模块化拆分</span></strong><span>，这对于企业级应用的安全性和体积控制至关重要。</span></p><ul><li><p><strong><code>langchain-core</code><span> (内核)</span></strong><span>：仅包含最基础的抽象（如 </span><code>LCEL</code><span>, </span><code>Runnables</code><span>, </span><code>Messages</code><span>）。它没有第三方依赖，极其轻量，定义了所有 Agent 的标准接口。</span></p></li><li><p><strong><code>langchain-community</code><span> (社区)</span></strong><span>：包含了数千种第三方工具的集成（如 Wikipedia, DuckDuckGo）。</span></p></li><li><p><strong><code>langchain-partners</code><span> (合作伙伴)</span></strong><span>：这是最大的变化。OpenAI、DeepSeek、Google 等主流厂商的代码被拆分为独立的包（如 </span><code>langchain-deepseek</code><span>, </span><code>langchain-openai</code><span>）。</span></p><ul><li><p><strong><span>企业价值</span></strong><span>：当 OpenAI 更新 API 时，你只需要升级 </span><code>langchain-openai</code><span>，而不用升级整个 </span><code>langchain</code><span>，极大降低了生产环境的</span><strong><span>回归测试风险（Regression Risk）</span></strong><span>。</span></p></li></ul></li></ul><h4 id='42-核心变革二工具调用标准化-standardized-tool-calling'><span>4.2 核心变革二：工具调用标准化 (Standardized Tool Calling)</span></h4><p><span>在 1.0 之前，调用 OpenAI 的 Function Calling 和 Anthropic 的 Tool Use 需要完全不同的代码逻辑。1.1 版本引入了统一的 </span><strong><span>Tool Calling API</span></strong><span>，彻底抹平了模型厂商之间的差异。</span></p><ul><li><p><strong><code>.bind_tools()</code><span> 接口</span></strong><span>：无论底层是 GPT-5 还是 DeepSeek V3，开发者只需调用 </span><code>model.bind_tools(tools)</code><span>，框架会自动将 Python 函数转换为模型特定的 JSON Schema（如 OpenAI 的 JSON 结构或 XML 结构）。</span></p></li><li><p><strong><code>tool_calls</code><span> 属性</span></strong><span>：模型返回的工具调用请求被统一封装在 </span><code>AIMessage.tool_calls</code><span> 属性中，开发者不再需要手动解析原始的 JSON 字符串。</span></p></li><li><p><strong><code>create_tool_calling_agent</code></strong><span>：这是我们在课程中使用的核心 API，它取代了旧版专用的 </span><code>create_openai_tools_agent</code><span>，使得 Agent 代码具备了</span><strong><span>模型无关性（Model Agnostic）</span></strong><span>——今天用 GPT-4，明天换 DeepSeek，代码几乎不用改。</span></p></li></ul><h4 id='43-核心变革三pydantic-v2-原生支持与性能跃升'><span>4.3 核心变革三：Pydantic V2 原生支持与性能跃升</span></h4><p><span>LangChain 1.1 阶段完成了底层数据验证引擎从 Pydantic V1 到 </span><strong><span>Pydantic V2</span></strong><span> 的全量迁移。</span></p><ul><li><p><strong><span>Rust 内核加速</span></strong><span>：Pydantic V2 的核心逻辑由 Rust 重写，这使得 Agent 在处理大量数据结构验证（如解析复杂的 JSON 输出）时，性能提升了 </span><strong><span>5-10 倍</span></strong><span>。</span></p></li><li><p><strong><span>严格模式</span></strong><span>：引入了更严格的类型检查机制。在企业级开发中，这意味着许多潜在的类型错误（Type Errors）在代码编写阶段就能被 IDE 捕获，而不是等到生产环境运行时才报错。</span></p></li></ul><h4 id='44-核心变革四异步与流式优先-async--streaming-first'><span>4.4 核心变革四：异步与流式优先 (Async &amp; Streaming First)</span></h4><p><span>为了适配 Agent 复杂的交互场景，1.1 版本对异步事件循环进行了重构，推出了 </span><strong><code>astream_events</code><span> (v2)</span></strong><span> API。</span></p><ul><li><p><strong><span>细粒度事件流</span></strong><span>：旧版的 </span><code>stream</code><span> 只能吐出最终的文本 Token。而新的 </span><code>astream_events</code><span>（我们在实战中使用的 API）可以实时推送</span><strong><span>工具调用开始（on_tool_start）、工具执行结束（on_tool_end）、中间思考过程</span></strong><span>等细粒度事件。</span></p></li><li><p><strong><span>前端体验革命</span></strong><span>：这使得前端可以精确地渲染出“正在思考...”、“正在搜索...”、“搜索完成”等状态，而不是让用户对着空白屏幕傻等。</span></p></li></ul><h2 id='二langchain-11-+-mcp-+-deepseek-v32企业级项目开发说明'><span>二、LangChain 1.1 + MCP + DeepSeek-V3.2企业级项目开发说明</span></h2><h3 id='1-mini-chatgpt项目演示'><span>1. mini ChatGPT项目演示</span></h3><ul><li><p><span>mini ChatGPT项目介绍：mini ChatGPT不仅仅是一个聊天机器人，它是一个</span><strong><span>基于 MCP 协议的可扩展智能体操作系统 (Agent OS)</span></strong><span>。它复刻了 ChatGPT 核心的“插件化”架构，允许用户像安装手机 APP 一样，动态地为 AI 挂载各种工具（如 12306 查票、本地数据库操作、高德地图等），实现从“对话”到“办事”的质变。</span></p></li></ul><video src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/5669e323f6d870b5240a76470253e6f8_raw.mp4"></video><h3 id='2-mini-chatgpt核心功能点介绍'><span>2. mini ChatGPT核心功能点介绍</span></h3><ul><li><p><span>毫秒级流式打印</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101903169.png" alt="image-20251210190305054" style="zoom:50%;" /></p></li><li><p><span>多步、多工具调用，边思考边调用工具，确保性能稳定性</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101904771.png" alt="image-20251210190416666" style="zoom:50%;" /></p></li><li><p><span>持久化记忆存储、对话&amp;记忆自由切换</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101904169.png" alt="image-20251210190440019" style="zoom:50%;" /></p></li><li><p><span>一键添加MCP工具</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101905568.png" alt="image-20251210190502401" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101906499.png" alt="image-20251210190657387" style="zoom:50%;" /></p></li><li><p><span>启发式添加MCP工具</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101907486.png" alt="image-20251210190739371" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101907486.png" alt="image-20251210190752349" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101908203.png" alt="image-20251210190831075" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101910664.png" alt="81e1d2e51015305e07aea4c6a5b6fd0b" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101909617.png" alt="image-20251210190954497" style="zoom:50%;" /></p></li><li><p><span>开启学习模式</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101911637.png" alt="image-20251210191111500" style="zoom:50%;" /></p></li></ul><h3 id='3-项目实战价值从api-调包侠进阶为全栈-ai-产品工程师'><span>3. 项目实战价值：从“API 调包侠”进阶为“全栈 AI 产品工程师”</span></h3><blockquote><p><strong><span>核心理念</span></strong><span>：在 AI 编程工具（AI Coding）日益强大的今天，单纯掌握 API 调用已不再是护城河。本项目将带你跳出“写代码”的单一视角，以</span><strong><span>“产品 + 架构 + 全栈”</span></strong><span>的上帝视角，完整复盘一个工业级 Agent 产品的诞生过程。</span></p></blockquote><h4 id='31-掌握-2025-年黄金三角技术栈实战'><span>3.1 掌握 2025 年“黄金三角”技术栈实战</span></h4><p><span>我们不教过时的技术。本项目精选了当前最具商业落地价值的技术组合：</span></p><ul><li><p><strong><span>LangChain 1.1 (LangGraph)</span></strong><span>：掌握最新的图（Graph）编排架构，而非旧版的链式结构。</span></p></li><li><p><strong><span>Model Context Protocol (MCP)</span></strong><span>：实战未来 3-5 年的通用连接标准，学会如何让 AI 连接万物。</span></p></li><li><p><span>DeepSeek-V3.2：深度体验国产最强开源模型的推理能力，掌握在低成本下实现高性能 Agent 的秘诀。</span></p><p><span>这套组合被称为 Agent 开发的</span><strong><span>“黄金三角”</span></strong><span>，掌握它意味着你具备了构建复杂企业级应用的能力。</span></p></li></ul><h4 id='32-沉浸式体验企业级开发标准与-vibe-coding-新范式'><span>3.2 沉浸式体验“企业级开发标准”与 Vibe Coding 新范式</span></h4><p><span>拒绝“面条式代码（Spaghetti Code）”，我们完全遵循大厂的工程化标准：</span></p><ul><li><p><strong><span>后端模块化架构</span></strong><span>：我们将后端严格拆分为 </span><code>Server</code><span>（接入层）、</span><code>Manager</code><span>（业务逻辑层）、</span><code>Agent</code><span>（核心工厂层）与 </span><code>History</code><span>（持久层）。你将学会如何写出高内聚、低耦合、易维护的代码。</span></p></li><li><p><strong><span>前端 Vibe Coding 开发</span></strong><span>：在前端开发环节，我们将演示</span><strong><span>“AI 辅助编程（Vibe Coding）”</span></strong><span>的新范式——你不需要精通 React/Vue 的每一个细节，只需充当“产品经理 + 技术验收官”，指挥 AI 完成 UI 代码的编写。这是未来全栈开发的主流形态。</span></p></li></ul><h4 id='33-跑通从-0-到-1的全链路产品闭环'><span>3.3 跑通“从 0 到 1”的全链路产品闭环</span></h4><p><span>许多开发者只懂写函数，不懂做产品。本项目将带你完整执行一次标准的产品开发生命周期（SDLC）：</span></p><ul><li><p><strong><span>Step 1 产品设计</span></strong><span>：从需求出发，规划“MCP 商店”、“流式对话”、“动态配置”等核心功能点。</span></p></li><li><p><strong><span>Step 2 架构/模块规划</span></strong><span>：设计数据流向，定义 </span><code>mcp_registry.json</code><span> 数据结构，规划前后端交互逻辑。</span></p></li><li><p><strong><span>Step 3 核心开发与测试</span></strong><span>：分阶段完成后端接口编写，并进行单元测试（如 MCP 连接测试）。</span></p></li><li><p><strong><span>Step 4 前后端联调</span></strong><span>：定义清晰的 API 契约（Interface Contract），打通 SSE 流式数据链条，完成最终交付。</span></p></li></ul><h4 id='34-重塑-ai-时代的产品化思维'><span>3.4 重塑 AI 时代的“产品化思维”</span></h4><p><span>在这个项目中，你学到的不仅是技术，更是一种思维方式的升级：</span></p><ul><li><p><strong><span>从“技术思维”到“产品思维”</span></strong><span>：不只是关注“这个接口怎么写”，更关注“用户在点击测试连接时，需要什么样的反馈才能安心”。</span></p></li><li><p><strong><span>从“单点突破”到“系统观”</span></strong><span>：理解一个 Agent 系统是如何通过文件系统、网络协议、大模型推理和前端交互精密咬合在一起的。</span></p></li></ul><p><span>这是一份非常符合教学心理学和工程化思维的开发规划。</span></p><p><span>对于初学者来说，如果一上来就面对 MCP 管理器、动态工厂、流式协议、历史记录等所有概念，认知负荷过重，容易“劝退”。</span></p><p><strong><span>“分而治之，迭代演进”</span></strong><span> 正是工业级软件开发的核心心法。通过将后端拆分为 </span><strong><span>MVP（最小可行性产品）阶段</span></strong><span> 和 </span><strong><span>Pro（增强版）阶段</span></strong><span>，不仅降低了学习门槛，还完美模拟了真实产品的迭代过程。</span></p><p><span>以下是为您编写的详细课件内容：</span></p><h3 id='4-mini-chatgpt-开发思路规划'><span>4. mini ChatGPT 开发思路规划</span></h3><blockquote><p><span>核心理念：复杂系统是由简单系统演化而来的。在本次实战中，我们将拒绝“填鸭式”教学，而是模拟真实的互联网大厂开发流程，采用 “MVP（最小可行性产品） </span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.181ex" role="img" focusable="false" viewBox="0 -511 1000 522" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.025ex;"><defs><path id="MJX-3-TEX-N-2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="2192" xlink:href="#MJX-3-TEX-N-2192"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">→</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">\rightarrow</script><span> Scale（架构升级）” 的两阶段迭代策略。</span></p><p><span>我们保持前端 UI/交互逻辑不变（一次到位），重点演示后端架构是如何从一个简单的对话系统，进化为支持 MCP 的智能体操作系统。</span></p></blockquote><h4 id='41-总体架构蓝图'><span>4.1 总体架构蓝图</span></h4><p><span>我们的后端开发将分为两个里程碑：</span></p><ul><li><p><strong><span>阶段一（Core Kernel）</span></strong><span>：构建一个具备“思考-行动-反馈”闭环的</span><strong><span>标准 Agent</span></strong><span>。它拥有固定的“左膀右臂”（天气查询、联网搜索），能够记忆上下文，并以流式打字机的效果与用户对话。</span></p></li><li><p><strong><span>阶段二（Agent OS）</span></strong><span>：对 Agent 进行“手术式”升级，引入 </span><strong><span>MCP 协议</span></strong><span>。实现工具的</span><strong><span>动态热插拔</span></strong><span>，让 Agent 从“硬编码工具”进化为可以安装 APP 的“智能终端”。</span></p></li></ul><h4 id='42-阶段一构建核心-agent-内核-the-mvp'><span>4.2 阶段一：构建核心 Agent 内核 (The MVP)</span></h4><p><span>在这一阶段，我们的目标是跑通 FastAPI + LangChain + DeepSeek 的核心链路。我们将暂时忽略 MCP 的复杂性，专注于解决以下 4 个核心工程问题：</span></p><ul><li><p><strong><span>1. 基础服务搭建</span></strong><span>：</span></p><ul><li><p><span>使用 </span><strong><span>FastAPI</span></strong><span> 搭建 Web 服务器，配置 CORS 跨域，打通前后端连接的“第一公里”。</span></p></li></ul></li><li><p><strong><span>2. 核心大脑构建 (Hardcoded Tools)</span></strong><span>：</span></p><ul><li><p><span>基于 </span><code>create_agent</code><span> API，创建一个标准的 ReAct Agent。</span></p></li><li><p><strong><span>关键点</span></strong><span>：此时我们的工具（Tools）是</span><strong><span>“硬编码”</span></strong><span>在代码里的。我们将手动编写 </span><code>get_weather</code><span>（查天气）和 </span><code>tavily_search</code><span>（联网搜索）两个 Python 函数，并绑定给 DeepSeek 模型。</span></p></li></ul></li><li><p><strong><span>3. 沉浸式流式传输 (SSE)</span></strong><span>：</span></p><ul><li><p><span>这是用户体验的关键。我们将攻克 </span><strong><span>Server-Sent Events</span></strong><span> 协议，实现后端 </span><code>astream_events</code><span> 到前端打字机效果的透传。</span></p></li></ul></li><li><p><strong><span>4. 记忆持久化 (Memory)</span></strong><span>：</span></p><ul><li><p><span>实现基于 JSON 文件的简单数据库，让 Agent 能够记住用户的上一句话（Session Management）。</span></p></li></ul></li></ul><blockquote><p><strong><span>阶段一交付物</span></strong><span>：一个类似 ChatGPT 网页版的、能够联网、能够查天气、能够流式对话的基础机器人。</span></p></blockquote><h4 id='43-阶段二引入-mcp-打造智能体操作系统-the-evolution'><span>4.3 阶段二：引入 MCP 打造智能体操作系统 (The Evolution)</span></h4><p><span>在阶段一的基础上，我们将面临一个新的痛点：“每次想给 Agent 加新功能（比如查数据库、查车票），都需要修改代码并重启服务器，太麻烦了！”这正是引入 MCP 的最佳时机。在这一阶段，我们将对后端进行重构，由“静态”转向“动态”：</span></p><ul><li><p><strong><span>1. 引入 MCP 管理器 (Manager Layer)</span></strong><span>：</span></p><ul><li><p><span>开发 </span><code>mcp_manager.py</code><span>，实现工具的</span><strong><span>注册、安装、测试、开关</span></strong><span>。这相当于给 Agent 装了一个“应用商店”。</span></p></li></ul></li><li><p><strong><span>2. 实现动态 Agent 工厂 (Dynamic Factory)</span></strong><span>：</span></p><ul><li><p><span>改造 </span><code>agent.py</code><span>。不再使用写死的工具列表，而是改为</span><strong><span>“每次对话前动态读取配置”</span></strong><span>。</span></p></li><li><p><strong><span>核心逻辑</span></strong><span>：用户在前端勾选了什么工具，Agent 在下一秒的对话中就立刻拥有什么能力，无需重启。</span></p></li></ul></li><li><p><strong><span>3. 混合连接架构 (Hybrid Connection)</span></strong><span>：</span></p><ul><li><p><span>实现 </span><strong><span>StdIO（本地进程）</span></strong><span> 和 </span><strong><span>SSE（远程服务）</span></strong><span> 的统一接入，让 Agent 既能操作你的本地文件，又能调用云端的 12306 接口。</span></p></li></ul></li><li><p><strong><span>4. 完善管理接口</span></strong><span>：</span></p><ul><li><p><span>新增 </span><code>/mcp/install</code><span>、</span><code>/mcp/search_ai</code><span> 等管理接口，让用户可以通过前端 UI 来管理自己的 AI 助手。</span></p></li></ul></li></ul><blockquote><p><strong><span>阶段二交付物</span></strong><span>：一个完整的、可扩展的、支持动态插件的工业级 Agent 操作系统（即我们最终的 Mini ChatGPT）。</span></p></blockquote><h3 id='5-参考资料'><span>5. 参考资料</span></h3><ul><li><p><span>《LangChain 1.0快速入门教程》</span></p></li><li><p><span>《从零到一MCP服务器开发实战》</span></p></li><li><p><span>《DeepSeek-V3.2 + LangChain 1.0技术开发入门》</span></p></li></ul><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101814182.png" alt="fdddd2da2a660b9a17dbae63079ce018" style="zoom:50%;" /></p><h2 id='三mini-chatgpt-第一阶段开发实操'><span>三、mini ChatGPT 第一阶段开发实操</span></h2><blockquote><p><span>实战目标：在本节中，我们将不急于编写 Web 后端，而是利用 LangGraph Studio 可视化开发环境，快速构建并调试出我们的第一个“Agent 内核”。</span></p><p><span>核心收益：你将亲眼看到 Agent 是如何“思考”的，它是如何决定调用天气工具，又是如何修正错误的。所见即所得。</span></p></blockquote><h3 id='1-项目初始化与结构规划'><span>1. 项目初始化与结构规划</span></h3><p><span>	</span><span>首先，我们需要建立一个符合工业级标准的目录结构。请在你的工作区创建一个名为 </span><code>mini_chatgpt</code><span> 的文件夹，并按照以下结构创建文件：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="tex"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="tex"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mini_chatgpt/backend/</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── .env &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  # <span class="cm-bracket">[</span>密钥<span class="cm-bracket">]</span> 存放 API Key</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── requirements.txt &nbsp; &nbsp;  # <span class="cm-bracket">[</span>依赖<span class="cm-bracket">]</span> 项目依赖清单</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── langgraph.json &nbsp; &nbsp; &nbsp;  # <span class="cm-bracket">[</span>配置<span class="cm-bracket">]</span> LangGraph Studio 配置文件</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│── agent.py &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  # <span class="cm-bracket">[</span>核心<span class="cm-bracket">]</span> Agent 逻辑构建</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│── tools.py &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  # <span class="cm-bracket">[</span>工具<span class="cm-bracket">]</span> 硬编码工具定义 (MVP阶段)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 148px;"></div><div class="CodeMirror-gutters" style="display: none; height: 148px;"></div></div></div></pre><h3 id='2-环境与依赖安装'><span>2. 环境与依赖安装</span></h3><ul><li><p><span>创建虚拟环境</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda create <span class="cm-attribute">-n</span> minichatgpt <span class="cm-def">python</span><span class="cm-operator">=</span><span class="cm-number">3</span>.12</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda activate agent_env</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 49px;"></div><div class="CodeMirror-gutters" style="display: none; height: 49px;"></div></div></div></pre><ul><li><p><span>编写 requirements.txt</span></p></li></ul><p><span>为了支持可视化调试，我们需要额外安装 langgraph-cli。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="tex"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="tex"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">langchain&gt;=1.0.0</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">langchain-deepseek</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">langchain-community</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">langgraph</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">langgraph-cli<span class="cm-bracket">[</span>inmem<span class="cm-bracket">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">langchain-tavily</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">python-dotenv</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 173px;"></div><div class="CodeMirror-gutters" style="display: none; height: 173px;"></div></div></div></pre><ul><li><p><strong><span>执行安装命令</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># conda activate minichatgpt</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">pip install <span class="cm-attribute">-r</span> requirements.txt</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 49px;"></div><div class="CodeMirror-gutters" style="display: none; height: 49px;"></div></div></div></pre><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101938878.png" alt="image-20251210193812736" style="zoom:50%;" /></p><h3 id='3-密钥配置-backendenv'><span>3. 密钥配置 (backend/.env)</span></h3><p><span>创建 </span><code>.env</code><span> 文件，填入你的密钥。这是 Agent 连接世界的通行证。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="tex"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="tex"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">DEEPSEEK_API_KEY=sk-xxxxxxx</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">TAVILY_API_KEY=tvly-xxxxxxx</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">OPENWEATHER_API_KEY=xxxxxxx</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 74px;"></div><div class="CodeMirror-gutters" style="display: none; height: 74px;"></div></div></div></pre><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101938261.png" alt="image-20251210193835107" style="zoom:50%;" /></p><h3 id='4-编写硬编码工具-backendtoolspy'><span>4. 编写“硬编码”工具 (backend/tools.py)</span></h3><p><span>在 MVP 阶段，我们先不使用 MCP，而是手动编写两个最基础的 Python 函数工具，让 Agent 具备“感知世界”的能力。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101938986.png" alt="image-20251210193851835" style="zoom:50%;" /></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">os</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">json</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">requests</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">dotenv</span> <span class="cm-keyword">import</span> <span class="cm-variable">load_dotenv</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain_tavily</span> <span class="cm-keyword">import</span> <span class="cm-variable">TavilySearch</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain</span>.<span class="cm-property">tools</span> <span class="cm-keyword">import</span> <span class="cm-variable">tool</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">pydantic</span> <span class="cm-keyword">import</span> <span class="cm-variable">BaseModel</span>, <span class="cm-variable">Field</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1. 加载环境变量 (确保能读取到 API Key)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">load_dotenv</span>(<span class="cm-variable">override</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2. 定义内置搜索工具 (Tavily)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># max_results=5 表示每次搜索返回 5 条最相关的结果</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">search_tool</span> <span class="cm-operator">=</span> <span class="cm-variable">TavilySearch</span>(<span class="cm-variable">max_results</span><span class="cm-operator">=</span><span class="cm-number">5</span>, <span class="cm-variable">topic</span><span class="cm-operator">=</span><span class="cm-string">"general"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 3. 定义自定义工具的参数结构 (Pydantic)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 这是 LangChain 1.0 的最佳实践，用于精确控制模型如何传递参数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">WeatherQuery</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">loc</span>: <span class="cm-builtin">str</span> <span class="cm-operator">=</span> <span class="cm-variable">Field</span>(<span class="cm-variable">description</span><span class="cm-operator">=</span><span class="cm-string">"The location name of the city"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 4. 定义自定义天气工具 (OpenWeatherMap)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@tool</span>(<span class="cm-variable">args_schema</span><span class="cm-operator">=</span><span class="cm-variable">WeatherQuery</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">get_weather</span>(<span class="cm-variable">loc</span>: <span class="cm-builtin">str</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  查询即时天气函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :param loc: 必要参数，字符串类型，用于表示查询天气的具体城市名称。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  注意，中国的城市需要用对应城市的英文名称代替，例如如果需要查询北京市天气，则loc参数需要输入'Beijing'；</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :return: OpenWeather API查询即时天气的结果，返回JSON字符串。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Step 1. 构建请求 URL</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">url</span> <span class="cm-operator">=</span> <span class="cm-string">"https://api.openweathermap.org/data/2.5/weather"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Step 2. 设置查询参数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 从环境变量中安全读取 API Key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">api_key</span> <span class="cm-operator">=</span> <span class="cm-variable">os</span>.<span class="cm-property">getenv</span>(<span class="cm-string">"OPENWEATHER_API_KEY"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-keyword">not</span> <span class="cm-variable">api_key</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">"Error: 缺少 OPENWEATHER_API_KEY，请检查 .env 文件。"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">params</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"q"</span>: <span class="cm-variable">loc</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"appid"</span>: <span class="cm-variable">api_key</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"units"</span>: <span class="cm-string">"metric"</span>, &nbsp; <span class="cm-comment"># 使用摄氏度</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"lang"</span>: <span class="cm-string">"zh_cn"</span> &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 输出中文描述</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># Step 3. 发送 GET 请求</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">response</span> <span class="cm-operator">=</span> <span class="cm-variable">requests</span>.<span class="cm-property">get</span>(<span class="cm-variable">url</span>, <span class="cm-variable">params</span><span class="cm-operator">=</span><span class="cm-variable">params</span>, <span class="cm-variable">timeout</span><span class="cm-operator">=</span><span class="cm-number">5</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># Step 4. 解析响应</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">response</span>.<span class="cm-property">status_code</span> <span class="cm-operator">==</span> <span class="cm-number">200</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">response</span>.<span class="cm-property">json</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 将字典转换为 JSON 字符串返回，方便大模型阅读</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">json</span>.<span class="cm-property">dumps</span>(<span class="cm-variable">data</span>, <span class="cm-variable">ensure_ascii</span><span class="cm-operator">=</span><span class="cm-keyword">False</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">f"查询失败，状态码: </span>{<span class="cm-variable">response</span>.<span class="cm-property">status_code</span>}<span class="cm-string">, 错误信息: </span>{<span class="cm-variable">response</span>.<span class="cm-property">text</span>}<span class="cm-string">"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">Exception</span> <span class="cm-keyword">as</span> <span class="cm-variable">e</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">f"网络请求异常: </span>{<span class="cm-builtin">str</span>(<span class="cm-variable">e</span>)}<span class="cm-string">"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 5. 导出工具列表</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 供 agent.py 统一调用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">get_tools</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> [<span class="cm-variable">search_tool</span>, <span class="cm-variable">get_weather</span>]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1728px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1728px;"></div></div></div></pre><p><span>代码核心功能解释如下：</span></p><p><strong><span>Pydantic 参数定义 (</span><code>class WeatherQuery</code><span>)</span></strong><span>：</span></p><ul><li><p><strong><span>为什么要写这个类？</span></strong><span> 大模型本身是很随意的，它可能把城市参数传成 </span><code>city</code><span>、</span><code>location</code><span> 甚至 </span><code>address</code><span>。</span></p></li><li><p><span>通过继承 </span><code>BaseModel</code><span> 并使用 </span><code>Field</code><span> 描述，我们相当于给大模型下了一道“死命令”：</span><strong><span>“你必须传一个叫 </span><code>loc</code><span> 的参数给我，而且它是字符串”</span></strong><span>。这是保证工具调用成功率的关键。</span></p></li></ul><p><strong><code>@tool</code><span> 装饰器</span></strong><span>：</span></p><ul><li><p><span>这是 LangChain 的魔法糖。它会自动读取函数的文档字符串（Docstring），提取函数的功能描述（&quot;查询即时天气...&quot;）和参数说明。</span></p></li><li><p><strong><span>注意</span></strong><span>：Docstring 写得越详细，模型调用越准确。</span></p></li></ul><p><strong><span>JSON 字符串返回</span></strong><span>：</span></p><ul><li><p><code>return json.dumps(...)</code><span> 是一个技巧。虽然 Python 可以直接返回字典，但对大模型来说，标准的 JSON 字符串是最通用的数据格式，能减少解析歧义。</span></p></li></ul><h3 id='5-构建-agent-内核-backendagentpy'><span>5. 构建 Agent 内核 (backend/agent.py)</span></h3><p><span>这是本节的核心。为了适配 </span><strong><span>LangGraph Studio</span></strong><span> 的可视化功能，我们将使用 LangChain 1.0 原生的 </span><code>create_agent</code><span> 构建图对象。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101939114.png" alt="image-20251210193912972" style="zoom: 50%;" /></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">os</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">dotenv</span> <span class="cm-keyword">import</span> <span class="cm-variable">load_dotenv</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain_deepseek</span> <span class="cm-keyword">import</span> <span class="cm-variable">ChatDeepSeek</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain</span>.<span class="cm-property">agents</span> <span class="cm-keyword">import</span> <span class="cm-variable">create_agent</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">tools</span> <span class="cm-keyword">import</span> <span class="cm-variable">get_tools</span> &nbsp;<span class="cm-comment"># 导入我们在 tools.py 中定义的工具</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1. 加载环境变量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">load_dotenv</span>(<span class="cm-variable">override</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2. 获取工具列表</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">tools</span> <span class="cm-operator">=</span> <span class="cm-variable">get_tools</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 3. 创建模型 (DeepSeek)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># model="deepseek-chat" 对应的是 DeepSeek-V3 版本</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># temperature=0 让模型输出更严谨，适合工具调用场景</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">model</span> <span class="cm-operator">=</span> <span class="cm-variable">ChatDeepSeek</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">model</span><span class="cm-operator">=</span><span class="cm-string">"deepseek-chat"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 4. 定义系统提示词 (System Prompt)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 这是 Agent 的“人设”和“操作手册”</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">prompt</span> <span class="cm-operator">=</span> <span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">你是一名乐于助人的智能助手，擅长根据用户的问题选择合适的工具来查询信息并回答。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">当用户的问题涉及**天气信息**时，你应优先调用`get_weather`工具，查询用户指定城市的实时天气，并在回答中总结查询结果。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">当用户的问题涉及**新闻、事件、实时动态**时，你应优先调用`search_tool`工具，检索相关的最新信息，并在回答中简要概述。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">如果问题既包含天气又包含新闻，请先使用`get_weather`查询天气，再使用`search_tool`查询新闻，最后将结果合并后回复用户。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">所有回答应使用**简体中文**，条理清晰、简洁友好。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 5. 创建智能体 (Agent Graph)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># create_agent 是 LangChain 1.0 的核心工厂函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 它自动完成了以下复杂工作：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#  - 将 Python 工具转换为模型能看懂的 JSON Schema (bind_tools)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#  - 构建 ReAct (思考-行动-观察) 的循环图结构</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#  - 注入 System Prompt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">agent</span> <span class="cm-operator">=</span> <span class="cm-variable">create_agent</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">model</span><span class="cm-operator">=</span><span class="cm-variable">model</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">tools</span><span class="cm-operator">=</span><span class="cm-variable">tools</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">system_prompt</span><span class="cm-operator">=</span><span class="cm-variable">prompt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1185px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1185px;"></div></div></div></pre><p><span>核心代码解释如下：</span></p><ol><li><p><strong><code>create_agent</code><span> API 的魔力</span></strong><span>：</span></p><ul><li><p><span>在旧版本中，我们需要手动写 Prompt 模板、手动解析 OutputParser、手动构建 Chain。</span></p></li><li><p><span>在 </span><strong><span>LangChain 1.0</span></strong><span> 中，</span><code>create_agent</code><span> 帮我们屏蔽了底层所有复杂性。你只需要给它</span><strong><span>“模型 + 工具 + 提示词”</span></strong><span>，它就还你一个可以直接运行的智能体对象。这个对象本质上是一个编译好的 </span><strong><span>LangGraph StateGraph</span></strong><span>。</span></p></li></ul></li><li><p><strong><span>Prompt 的策略性</span></strong><span>：</span></p><ul><li><p><span>我们在 Prompt 中不仅定义了人设，还明确了</span><strong><span>“路由逻辑”</span></strong><span>（什么时候查天气，什么时候查新闻）。这叫做 </span><strong><span>In-Context Learning (上下文学习)</span></strong><span>，虽然 DeepSeek 很聪明，但明确的指令能让它在处理复杂混合任务（如“先查天气再查新闻”）时更加稳定。</span></p></li></ul></li><li><p><strong><span>模块化设计</span></strong><span>：</span></p><ul><li><p><span>我们将工具定义剥离到 </span><code>tools.py</code><span>，</span><code>agent.py</code><span> 只负责组装。这种</span><strong><span>解耦</span></strong><span>是企业级开发的标准动作，方便后续维护和扩展（比如第二阶段引入 MCP）。</span></p></li></ul></li></ol><h3 id='6-配置可视化环境-langgraphjson'><span>6. 配置可视化环境 (langgraph.json)</span></h3><p><span>这是 LangGraph Studio 的入口配置文件。它告诉 CLI 工具去哪里寻找我们定义的 </span><code>graph</code><span> 对象。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101939565.png" alt="image-20251210193942416" style="zoom:50%;" /></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="json"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"dependencies"</span>: [<span class="cm-string">"."</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"graphs"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"agent"</span>: <span class="cm-string">"./agent.py:graph"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"env"</span>: <span class="cm-string">".env"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 173px;"></div><div class="CodeMirror-gutters" style="display: none; height: 173px;"></div></div></div></pre><ul><li><p><strong><span>解释</span></strong><span>：</span></p><ul><li><p><code>&quot;agent&quot;</code><span>: 是我们在可视化界面中看到的图名称。</span></p></li><li><p><code>&quot;./backend/agent.py:graph&quot;</code><span>: 指向文件路径和变量名（即我们在 agent.py 最后定义的 </span><code>graph</code><span> 变量）。</span></p></li></ul></li></ul><h3 id='7-启动见证-agent-的思考-实操环节'><span>7. 启动！见证 Agent 的思考 (实操环节)</span></h3><p><span>现在，激动人心的时刻到了。我们不需要写任何前端代码，直接启动 LangGraph 内置的开发服务器，请在backend目录下运行：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">langgraph dev</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="display: none; height: 25px;"></div></div></div></pre><p><strong><span>预期效果：</span></strong></p><ol><li><p><span>终端会显示 </span><code>LangGraph Studio Web UI: http://127.0.0.1:2024</code><span>。</span></p></li><li><p><span>打开浏览器访问该地址。</span></p></li><li><p><strong><span>你将看到</span></strong><span>：</span></p><ul><li><p><strong><span>左侧</span></strong><span>：一个输入框，你可以输入“北京天气怎么样”。</span></p></li><li><p><strong><span>中间</span></strong><span>：一个漂亮的</span><strong><span>流程图</span></strong><span>！显示 Agent 从 </span><code>Start</code><span> -&gt; </span><code>Agent</code><span> -&gt; </span><code>Tools</code><span> -&gt; </span><code>Agent</code><span> -&gt; </span><code>End</code><span> 的跳转逻辑。</span></p></li><li><p><strong><span>右侧</span></strong><span>：执行日志。你可以清楚地看到 DeepSeek 生成了什么 JSON，工具返回了什么数据。</span></p></li></ul></li></ol><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101940123.png" alt="image-20251210194000971" style="zoom:50%;" /></p><ul><li><p><span>langgraph studio：</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101940734.png" alt="image-20251210194056587" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101941787.png" alt="image-20251210194115617" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101942656.png" alt="image-20251210194236498" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101943925.png" alt="image-20251210194320773" style="zoom:50%;" /></p></li><li><p><span>后端默认API接口：</span><a href='http://127.0.0.1:2024' target='_blank' class='url'>http://127.0.0.1:2024</a></p></li><li><p><span>后端API接口说明：</span><a href='http://127.0.0.1:2024/docs' target='_blank' class='url'>http://127.0.0.1:2024/docs</a></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101942325.png" alt="image-20251210194207164" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101942711.png" alt="image-20251210194215549" style="zoom:50%;" /></p></li></ul><ul><li><p><span>运维端口：</span><a href='https://smith.langchain.com/' target='_blank' class='url'>https://smith.langchain.com/</a></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101944523.png" alt="image-20251210194403376" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101944485.png" alt="image-20251210194420320" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101944425.png" alt="image-20251210194435254" style="zoom:50%;" /></p></li></ul><h3 id='8-选学基于vide-coding完成前端功能开发'><span>8. 【选学】基于Vide Coding完成前端功能开发</span></h3><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101949959.png" alt="image-20251210194919861" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101951932.png" referrerpolicy="no-referrer" alt="image-20251210195145774"></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512091835408.png" alt="a76e6238d7b180153150578da261689d" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512101950159.png" alt="image-20251210195018981" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/ac4f2a592e0453c3089da3643ee3404a.png" alt="b3a518f1a9821408a79363cf694f5172" style="zoom:50%;" /></p><h3 id='9mini-chatgpt前端功能开发'><span>9.mini ChatGPT前端功能开发</span></h3><ul><li><p><span>安装node.js</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512092043570.png" alt="image-20251209204309489" style="zoom:50%;" /></p></li><li><p><span>安装前端依赖</span></p><p><span>再次打开命令行，进入前端项目文件：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> frontend</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="display: none; height: 25px;"></div></div></div></pre><p><span>然后安装相关依赖：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">npm</span> install</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="display: none; height: 25px;"></div></div></div></pre></li><li><p><span>启动前端</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">npm</span> run dev</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="display: none; height: 25px;"></div></div></div></pre><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512092043316.png" alt="image-20251209204343177" style="zoom:50%;" /></p><p><span>在localhost:3000即可访问</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512092044889.png" alt="image-20251209204402734" style="zoom:50%;" /></p></li></ul><h3 id='10-消息管理模块开发实战-the-memory-system'><span>10. 消息管理模块开发实战 (The Memory System)</span></h3><blockquote><p><span>设计理念：</span></p><p><span>一个没有记忆的 Agent 只是一个一次性的问答机。在企业级应用中，我们需要一个</span><strong><span>“记忆宫殿”</span></strong><span>来管理用户的会话上下文。</span></p><p><span>本模块将负责两个核心职责：</span></p><ol><li><p><strong><span>持久化 (Persistence)</span></strong><span>：将对话保存到磁盘，防止服务重启后数据丢失。</span></p></li><li><p><strong><span>上下文窗口控制 (Context Window)</span></strong><span>：大模型的 Context 是有限且昂贵的。我们需要控制每次发给模型的历史记录数量（例如只发最近 50 条），避免 Token 爆炸。</span></p></li></ol></blockquote><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512102005000.png" alt="image-20251210200540826" style="zoom:50%;" /></p><h4 id='101-创建历史管理脚本-backendhistorypy'><span>10.1 创建历史管理脚本 (</span><code>backend/history.py</code><span>)</span></h4><p><span>接下来在 </span><code>backend</code><span> 目录下创建 </span><code>history.py</code><span>。我们将实现一个基于 JSON 文件的轻量级数据库。</span></p><p><strong><span>代码文件：</span><code>./backend/history.py</code></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">os</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">json</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">time</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">uuid</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">typing</span> <span class="cm-keyword">import</span> <span class="cm-variable">List</span>, <span class="cm-variable">Dict</span>, <span class="cm-variable">Optional</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 引入 LangChain 的标准消息对象，用于后续转换</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain_core</span>.<span class="cm-property">messages</span> <span class="cm-keyword">import</span> <span class="cm-variable">messages_from_dict</span>, <span class="cm-variable">messages_to_dict</span>, <span class="cm-variable">HumanMessage</span>, <span class="cm-variable">AIMessage</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 定义历史记录存储目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HISTORY_DIR</span> <span class="cm-operator">=</span> <span class="cm-string">"chat_history"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">INDEX_FILE</span> <span class="cm-operator">=</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">join</span>(<span class="cm-variable">HISTORY_DIR</span>, <span class="cm-string">"index.json"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 初始化目录结构</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-keyword">not</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">exists</span>(<span class="cm-variable">HISTORY_DIR</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">os</span>.<span class="cm-property">makedirs</span>(<span class="cm-variable">HISTORY_DIR</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-keyword">not</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">exists</span>(<span class="cm-variable">INDEX_FILE</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">with</span> <span class="cm-builtin">open</span>(<span class="cm-variable">INDEX_FILE</span>, <span class="cm-string">'w'</span>, <span class="cm-variable">encoding</span><span class="cm-operator">=</span><span class="cm-string">'utf-8'</span>) <span class="cm-keyword">as</span> <span class="cm-variable">f</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">json</span>.<span class="cm-property">dump</span>([], <span class="cm-variable">f</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">HistoryManager</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  负责管理具体的会话消息以及全局的会话列表索引</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">__init__</span>(<span class="cm-variable-2">self</span>, <span class="cm-variable">session_id</span>: <span class="cm-builtin">str</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">self</span>.<span class="cm-property">session_id</span> <span class="cm-operator">=</span> <span class="cm-variable">session_id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 每个会话对应一个独立的 JSON 文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">self</span>.<span class="cm-property">file_path</span> <span class="cm-operator">=</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">join</span>(<span class="cm-variable">HISTORY_DIR</span>, <span class="cm-string">f"</span>{<span class="cm-variable">session_id</span>}<span class="cm-string">.json"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># --- 核心功能 1: 读取消息 (带上下文截断) ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">load_messages</span>(<span class="cm-variable-2">self</span>, <span class="cm-variable">limit</span>: <span class="cm-builtin">int</span> <span class="cm-operator">=</span> <span class="cm-number">50</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp;  加载当前会话的消息对象，供 Agent 思考使用。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp;  :param limit: 限制读取最近的 N 条消息 (Token 优化关键点)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-keyword">not</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">exists</span>(<span class="cm-variable-2">self</span>.<span class="cm-property">file_path</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">with</span> <span class="cm-builtin">open</span>(<span class="cm-variable-2">self</span>.<span class="cm-property">file_path</span>, <span class="cm-string">'r'</span>, <span class="cm-variable">encoding</span><span class="cm-operator">=</span><span class="cm-string">'utf-8'</span>) <span class="cm-keyword">as</span> <span class="cm-variable">f</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">json</span>.<span class="cm-property">load</span>(<span class="cm-variable">f</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 将 JSON 字典转回 LangChain 的 Message 对象 (HumanMessage, AIMessage 等)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">all_messages</span> <span class="cm-operator">=</span> <span class="cm-variable">messages_from_dict</span>(<span class="cm-variable">data</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 核心逻辑：切片操作，只取最后 limit 条</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">all_messages</span>[<span class="cm-operator">-</span><span class="cm-variable">limit</span>:]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">Exception</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># --- 核心功能 2: 写入交互 ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">save_interaction</span>(<span class="cm-variable-2">self</span>, <span class="cm-variable">user_query</span>: <span class="cm-builtin">str</span>, <span class="cm-variable">ai_response</span>: <span class="cm-builtin">str</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"""保存一轮新的对话（User + AI），并更新索引"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 1. 读取旧数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">current_data</span> <span class="cm-operator">=</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">exists</span>(<span class="cm-variable-2">self</span>.<span class="cm-property">file_path</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">with</span> <span class="cm-builtin">open</span>(<span class="cm-variable-2">self</span>.<span class="cm-property">file_path</span>, <span class="cm-string">'r'</span>, <span class="cm-variable">encoding</span><span class="cm-operator">=</span><span class="cm-string">'utf-8'</span>) <span class="cm-keyword">as</span> <span class="cm-variable">f</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">current_data</span> <span class="cm-operator">=</span> <span class="cm-variable">json</span>.<span class="cm-property">load</span>(<span class="cm-variable">f</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">except</span>: <span class="cm-keyword">pass</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 2. 构建新消息对</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">new_messages</span> <span class="cm-operator">=</span> [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">HumanMessage</span>(<span class="cm-variable">content</span><span class="cm-operator">=</span><span class="cm-variable">user_query</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">AIMessage</span>(<span class="cm-variable">content</span><span class="cm-operator">=</span><span class="cm-variable">ai_response</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 3. 追加并保存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># messages_to_dict 将对象序列化为 JSON 可存储的格式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">updated_data</span> <span class="cm-operator">=</span> <span class="cm-variable">current_data</span> <span class="cm-operator">+</span> <span class="cm-variable">messages_to_dict</span>(<span class="cm-variable">new_messages</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">with</span> <span class="cm-builtin">open</span>(<span class="cm-variable-2">self</span>.<span class="cm-property">file_path</span>, <span class="cm-string">'w'</span>, <span class="cm-variable">encoding</span><span class="cm-operator">=</span><span class="cm-string">'utf-8'</span>) <span class="cm-keyword">as</span> <span class="cm-variable">f</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">json</span>.<span class="cm-property">dump</span>(<span class="cm-variable">updated_data</span>, <span class="cm-variable">f</span>, <span class="cm-variable">ensure_ascii</span><span class="cm-operator">=</span><span class="cm-keyword">False</span>, <span class="cm-variable">indent</span><span class="cm-operator">=</span><span class="cm-number">2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 4. 更新全局索引 (侧边栏列表)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">self</span>.<span class="cm-property">_update_index</span>(<span class="cm-variable">user_query</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># --- 辅助功能: 会话列表索引管理 ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">_update_index</span>(<span class="cm-variable-2">self</span>, <span class="cm-variable">first_query</span>: <span class="cm-builtin">str</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"""更新 index.json，如果会话不存在则创建，并自动生成标题"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">with</span> <span class="cm-builtin">open</span>(<span class="cm-variable">INDEX_FILE</span>, <span class="cm-string">'r'</span>, <span class="cm-variable">encoding</span><span class="cm-operator">=</span><span class="cm-string">'utf-8'</span>) <span class="cm-keyword">as</span> <span class="cm-variable">f</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sessions</span> <span class="cm-operator">=</span> <span class="cm-variable">json</span>.<span class="cm-property">load</span>(<span class="cm-variable">f</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 检查当前 session_id 是否已存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">session</span> <span class="cm-operator">=</span> <span class="cm-builtin">next</span>((<span class="cm-variable">s</span> <span class="cm-keyword">for</span> <span class="cm-variable">s</span> <span class="cm-keyword">in</span> <span class="cm-variable">sessions</span> <span class="cm-keyword">if</span> <span class="cm-variable">s</span>[<span class="cm-string">"id"</span>] <span class="cm-operator">==</span> <span class="cm-variable-2">self</span>.<span class="cm-property">session_id</span>), <span class="cm-keyword">None</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">current_timestamp</span> <span class="cm-operator">=</span> <span class="cm-builtin">int</span>(<span class="cm-variable">time</span>.<span class="cm-property">time</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">session</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 老会话：只更新时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">session</span>[<span class="cm-string">"updated_at"</span>] <span class="cm-operator">=</span> <span class="cm-variable">current_timestamp</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 新会话：生成标题（取前20个字）并添加</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">title</span> <span class="cm-operator">=</span> <span class="cm-variable">first_query</span>[:<span class="cm-number">20</span>] <span class="cm-operator">+</span> <span class="cm-string">"..."</span> <span class="cm-keyword">if</span> <span class="cm-builtin">len</span>(<span class="cm-variable">first_query</span>) <span class="cm-operator">&gt;</span> <span class="cm-number">20</span> <span class="cm-keyword">else</span> <span class="cm-variable">first_query</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">new_session</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"id"</span>: <span class="cm-variable-2">self</span>.<span class="cm-property">session_id</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"title"</span>: <span class="cm-variable">title</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"created_at"</span>: <span class="cm-variable">current_timestamp</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"updated_at"</span>: <span class="cm-variable">current_timestamp</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sessions</span>.<span class="cm-property">append</span>(<span class="cm-variable">new_session</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 保存索引</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">with</span> <span class="cm-builtin">open</span>(<span class="cm-variable">INDEX_FILE</span>, <span class="cm-string">'w'</span>, <span class="cm-variable">encoding</span><span class="cm-operator">=</span><span class="cm-string">'utf-8'</span>) <span class="cm-keyword">as</span> <span class="cm-variable">f</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">json</span>.<span class="cm-property">dump</span>(<span class="cm-variable">sessions</span>, <span class="cm-variable">f</span>, <span class="cm-variable">ensure_ascii</span><span class="cm-operator">=</span><span class="cm-keyword">False</span>, <span class="cm-variable">indent</span><span class="cm-operator">=</span><span class="cm-number">2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@staticmethod</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">get_all_sessions</span>() <span class="cm-operator">-&gt;</span> <span class="cm-variable">List</span>[<span class="cm-variable">Dict</span>]:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"""获取所有会话列表（用于前端侧边栏展示）"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-keyword">not</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">exists</span>(<span class="cm-variable">INDEX_FILE</span>): <span class="cm-keyword">return</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">with</span> <span class="cm-builtin">open</span>(<span class="cm-variable">INDEX_FILE</span>, <span class="cm-string">'r'</span>, <span class="cm-variable">encoding</span><span class="cm-operator">=</span><span class="cm-string">'utf-8'</span>) <span class="cm-keyword">as</span> <span class="cm-variable">f</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sessions</span> <span class="cm-operator">=</span> <span class="cm-variable">json</span>.<span class="cm-property">load</span>(<span class="cm-variable">f</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 按时间倒序排列，最近的在上面</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sessions</span>.<span class="cm-property">sort</span>(<span class="cm-variable">key</span><span class="cm-operator">=</span><span class="cm-keyword">lambda</span> <span class="cm-variable">x</span>: <span class="cm-variable">x</span>.<span class="cm-property">get</span>(<span class="cm-string">"updated_at"</span>, <span class="cm-number">0</span>), <span class="cm-variable">reverse</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">sessions</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@staticmethod</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">delete_session</span>(<span class="cm-variable">session_id</span>: <span class="cm-builtin">str</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"""删除会话文件及索引"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 1. 删文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">file_path</span> <span class="cm-operator">=</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">join</span>(<span class="cm-variable">HISTORY_DIR</span>, <span class="cm-string">f"</span>{<span class="cm-variable">session_id</span>}<span class="cm-string">.json"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">exists</span>(<span class="cm-variable">file_path</span>): <span class="cm-variable">os</span>.<span class="cm-property">remove</span>(<span class="cm-variable">file_path</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 2. 删索引</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">with</span> <span class="cm-builtin">open</span>(<span class="cm-variable">INDEX_FILE</span>, <span class="cm-string">'r'</span>, <span class="cm-variable">encoding</span><span class="cm-operator">=</span><span class="cm-string">'utf-8'</span>) <span class="cm-keyword">as</span> <span class="cm-variable">f</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sessions</span> <span class="cm-operator">=</span> <span class="cm-variable">json</span>.<span class="cm-property">load</span>(<span class="cm-variable">f</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sessions</span> <span class="cm-operator">=</span> [<span class="cm-variable">s</span> <span class="cm-keyword">for</span> <span class="cm-variable">s</span> <span class="cm-keyword">in</span> <span class="cm-variable">sessions</span> <span class="cm-keyword">if</span> <span class="cm-variable">s</span>[<span class="cm-string">"id"</span>] <span class="cm-operator">!=</span> <span class="cm-variable">session_id</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">with</span> <span class="cm-builtin">open</span>(<span class="cm-variable">INDEX_FILE</span>, <span class="cm-string">'w'</span>, <span class="cm-variable">encoding</span><span class="cm-operator">=</span><span class="cm-string">'utf-8'</span>) <span class="cm-keyword">as</span> <span class="cm-variable">f</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">json</span>.<span class="cm-property">dump</span>(<span class="cm-variable">sessions</span>, <span class="cm-variable">f</span>, <span class="cm-variable">ensure_ascii</span><span class="cm-operator">=</span><span class="cm-keyword">False</span>, <span class="cm-variable">indent</span><span class="cm-operator">=</span><span class="cm-number">2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">get_full_history</span>(<span class="cm-variable-2">self</span>) <span class="cm-operator">-&gt;</span> <span class="cm-variable">List</span>[<span class="cm-variable">Dict</span>]:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"""获取全量历史（前端展示详情用）"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">exists</span>(<span class="cm-variable-2">self</span>.<span class="cm-property">file_path</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">with</span> <span class="cm-builtin">open</span>(<span class="cm-variable-2">self</span>.<span class="cm-property">file_path</span>, <span class="cm-string">'r'</span>, <span class="cm-variable">encoding</span><span class="cm-operator">=</span><span class="cm-string">'utf-8'</span>) <span class="cm-keyword">as</span> <span class="cm-variable">f</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">json</span>.<span class="cm-property">load</span>(<span class="cm-variable">f</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> []</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 3653px;"></div><div class="CodeMirror-gutters" style="display: none; height: 3653px;"></div></div></div></pre><p><span>代码核心思路解读：</span></p><ol><li><p><strong><span>分层存储</span></strong><span>：我们将具体聊天记录 (</span><code>xyz.json</code><span>) 和会话列表 (</span><code>index.json</code><span>) 分开。</span></p><ul><li><p><strong><span>好处</span></strong><span>：当用户刷新侧边栏时，我们只需要读取很小的 </span><code>index.json</code><span>，而不需要遍历几千个聊天文件，这在高并发场景下能极大地提升性能。</span></p></li></ul></li><li><p><strong><span>消息序列化</span></strong><span>：使用了 LangChain 自带的 </span><code>messages_to_dict</code><span> 和 </span><code>messages_from_dict</code><span>。这是为了保证我们的存储格式与 LangChain 生态完全兼容，方便未来迁移到 PostgreSQL 或 Redis。</span></p></li><li><p><strong><span>Context Window (上下文窗口)</span></strong><span>：注意 </span><code>load_messages(limit=50)</code><span>。在企业开发中，如果不做限制，随着对话变长，Token 消耗会指数级增长，甚至撑爆模型上限。这是一个重要的成本控制策略。</span></p></li></ol><h3 id='11-借助-fastapi-自定义后端功能接口'><span>11. 借助 FastAPI 自定义后端功能接口</span></h3><blockquote><p><span>设计理念：</span></p><p><span>server.py 是整个系统的“神经中枢”。它需要承担 HTTP 请求的路由分发、跨域处理 (CORS) 以及最核心的 SSE (Server-Sent Events) 流式协议转换。我们将使用 Python 界性能最强、最现代化的 Web 框架 —— FastAPI 来实现。</span></p></blockquote><h4 id='111-创建后端服务脚本-backendserverpy'><span>11.1 创建后端服务脚本 (</span><code>backend/server.py</code><span>)</span></h4><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512102005138.png" alt="image-20251210200512946" style="zoom:50%;" /></p><p><span>在 </span><strong><span>阶段一</span></strong><span>，我们只包含基础对话和会话管理接口，暂不包含 MCP 接口。</span></p><p><strong><span>代码文件：</span><code>./backend/server.py</code></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">uvicorn</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">os</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">json</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">asyncio</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">typing</span> <span class="cm-keyword">import</span> <span class="cm-variable">List</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">dotenv</span> <span class="cm-keyword">import</span> <span class="cm-variable">load_dotenv</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">fastapi</span> <span class="cm-keyword">import</span> <span class="cm-variable">FastAPI</span>, <span class="cm-variable">HTTPException</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">fastapi</span>.<span class="cm-property">middleware</span>.<span class="cm-property">cors</span> <span class="cm-keyword">import</span> <span class="cm-variable">CORSMiddleware</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">fastapi</span>.<span class="cm-property">responses</span> <span class="cm-keyword">import</span> <span class="cm-variable">StreamingResponse</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">pydantic</span> <span class="cm-keyword">import</span> <span class="cm-variable">BaseModel</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain_core</span>.<span class="cm-property">messages</span> <span class="cm-keyword">import</span> <span class="cm-variable">HumanMessage</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 导入本地模块</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">history</span> <span class="cm-keyword">import</span> <span class="cm-variable">HistoryManager</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 导入我们在 agent.py 里写的 agent 对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 注意：在阶段一，Agent是静态的，所以直接导入对象即可</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">agent</span> <span class="cm-keyword">import</span> <span class="cm-variable">agent</span> <span class="cm-keyword">as</span> <span class="cm-variable">static_agent</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1. 加载环境变量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">load_dotenv</span>(<span class="cm-variable">override</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2. 初始化 FastAPI 应用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">app</span> <span class="cm-operator">=</span> <span class="cm-variable">FastAPI</span>(<span class="cm-variable">title</span><span class="cm-operator">=</span><span class="cm-string">"Mini ChatGPT Backend"</span>, <span class="cm-variable">version</span><span class="cm-operator">=</span><span class="cm-string">"1.0 (MVP)"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 3. 配置 CORS (跨域资源共享) - 关键！</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 允许前端(通常在 localhost:3000 或 5173) 访问此后端</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">app</span>.<span class="cm-property">add_middleware</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CORSMiddleware</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">allow_origins</span><span class="cm-operator">=</span>[<span class="cm-string">"*"</span>], &nbsp;<span class="cm-comment"># 生产环境建议替换为具体前端域名</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">allow_credentials</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">allow_methods</span><span class="cm-operator">=</span>[<span class="cm-string">"*"</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">allow_headers</span><span class="cm-operator">=</span>[<span class="cm-string">"*"</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-string">f"🚀 Server 初始化完成"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp;  Pydantic 数据模型 (类型安全)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">ChatRequest</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">query</span>: <span class="cm-builtin">str</span> &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 用户的问题</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">session_id</span>: <span class="cm-builtin">str</span> &nbsp;<span class="cm-comment"># 会话 ID</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">SessionItem</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">id</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">title</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">updated_at</span>: <span class="cm-builtin">int</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; API 模块 1: 会话管理</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">get</span>(<span class="cm-string">"/sessions"</span>, <span class="cm-variable">response_model</span><span class="cm-operator">=</span><span class="cm-variable">List</span>[<span class="cm-variable">SessionItem</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">get_sessions</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""获取左侧侧边栏的会话列表"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">HistoryManager</span>.<span class="cm-property">get_all_sessions</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">post</span>(<span class="cm-string">"/sessions"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">create_session</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""创建一个新的空白会话"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">import</span> <span class="cm-variable">uuid</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">import</span> <span class="cm-variable">time</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"id"</span>: <span class="cm-builtin">str</span>(<span class="cm-variable">uuid</span>.<span class="cm-property">uuid4</span>()),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"title"</span>: <span class="cm-string">"新对话"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"updated_at"</span>: <span class="cm-builtin">int</span>(<span class="cm-variable">time</span>.<span class="cm-property">time</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">delete</span>(<span class="cm-string">"/sessions/{session_id}"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">delete_session</span>(<span class="cm-variable">session_id</span>: <span class="cm-builtin">str</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""删除指定会话"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">HistoryManager</span>.<span class="cm-property">delete_session</span>(<span class="cm-variable">session_id</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> {<span class="cm-string">"status"</span>: <span class="cm-string">"success"</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">get</span>(<span class="cm-string">"/history/{session_id}"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">get_history</span>(<span class="cm-variable">session_id</span>: <span class="cm-builtin">str</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""点击侧边栏时，加载该会话的历史消息"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">HistoryManager</span>(<span class="cm-variable">session_id</span>).<span class="cm-property">get_full_history</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; API 模块 2: 核心流式对话 (SSE)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">format_sse</span>(<span class="cm-variable">event_type</span>: <span class="cm-builtin">str</span>, <span class="cm-variable">data</span>: <span class="cm-builtin">dict</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""辅助函数：封装 SSE 消息格式"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ensure_ascii=False 保证中文正常传输</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">f"data: </span>{<span class="cm-variable">json</span>.<span class="cm-property">dumps</span>({<span class="cm-string">'type'</span>: <span class="cm-variable">event_type</span>, <span class="cm-string">'data'</span>: <span class="cm-variable">data</span>}, <span class="cm-variable">ensure_ascii</span><span class="cm-operator">=</span><span class="cm-keyword">False</span>)}<span class="cm-string">\n\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">post</span>(<span class="cm-string">"/chat_stream"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">chat_stream</span>(<span class="cm-variable">request</span>: <span class="cm-variable">ChatRequest</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  核心对话接口：接收用户问题 -&gt; 调用 Agent -&gt; 流式返回结果</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 1. 准备历史上下文</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">history_mgr</span> <span class="cm-operator">=</span> <span class="cm-variable">HistoryManager</span>(<span class="cm-variable">request</span>.<span class="cm-property">session_id</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 读取最近 40 条记录作为短期记忆</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">history_messages</span> <span class="cm-operator">=</span> <span class="cm-variable">history_mgr</span>.<span class="cm-property">load_messages</span>(<span class="cm-variable">limit</span><span class="cm-operator">=</span><span class="cm-number">40</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 拼接当前用户问题</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">input_messages</span> <span class="cm-operator">=</span> <span class="cm-variable">history_messages</span> <span class="cm-operator">+</span> [<span class="cm-variable">HumanMessage</span>(<span class="cm-variable">content</span><span class="cm-operator">=</span><span class="cm-variable">request</span>.<span class="cm-property">query</span>)]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 2. 定义异步生成器 (核心逻辑)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">event_generator</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">final_answer</span> <span class="cm-operator">=</span> <span class="cm-string">""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"🔄 [Server] Session </span>{<span class="cm-variable">request</span>.<span class="cm-property">session_id</span>}<span class="cm-string"> 开始处理: </span>{<span class="cm-variable">request</span>.<span class="cm-property">query</span>[:<span class="cm-number">20</span>]}<span class="cm-string">..."</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 调用 Agent 的 astream_events 方法，监听内部事件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># version="v2" 是 LangChain 推荐的稳定版事件流格式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">async</span> <span class="cm-keyword">for</span> <span class="cm-variable">event</span> <span class="cm-keyword">in</span> <span class="cm-variable">static_agent</span>.<span class="cm-property">astream_events</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {<span class="cm-string">"messages"</span>: <span class="cm-variable">input_messages</span>},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">version</span><span class="cm-operator">=</span><span class="cm-string">"v2"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">kind</span> <span class="cm-operator">=</span> <span class="cm-variable">event</span>[<span class="cm-string">"event"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-variable">event</span>.<span class="cm-property">get</span>(<span class="cm-string">"name"</span>, <span class="cm-string">""</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># --- 情况 A: 模型正在生成文本 (打字机效果) ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">kind</span> <span class="cm-operator">==</span> <span class="cm-string">"on_chat_model_stream"</span> <span class="cm-keyword">or</span> <span class="cm-variable">kind</span> <span class="cm-operator">==</span> <span class="cm-string">"on_llm_stream"</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">chunk</span> <span class="cm-operator">=</span> <span class="cm-variable">event</span>[<span class="cm-string">"data"</span>].<span class="cm-property">get</span>(<span class="cm-string">"chunk"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">content</span> <span class="cm-operator">=</span> <span class="cm-string">""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 兼容不同 chunk 格式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-builtin">hasattr</span>(<span class="cm-variable">chunk</span>, <span class="cm-string">"content"</span>): <span class="cm-variable">content</span> <span class="cm-operator">=</span> <span class="cm-variable">chunk</span>.<span class="cm-property">content</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">elif</span> <span class="cm-builtin">isinstance</span>(<span class="cm-variable">chunk</span>, <span class="cm-builtin">dict</span>): <span class="cm-variable">content</span> <span class="cm-operator">=</span> <span class="cm-variable">chunk</span>.<span class="cm-property">get</span>(<span class="cm-string">"content"</span>, <span class="cm-string">""</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">content</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">final_answer</span> <span class="cm-operator">+=</span> <span class="cm-variable">content</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 推送 token 事件给前端</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">yield</span> <span class="cm-variable">format_sse</span>(<span class="cm-string">"token"</span>, {<span class="cm-string">"content"</span>: <span class="cm-variable">content</span>})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># --- 情况 B: 工具开始调用 (展示 Loading) ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">elif</span> <span class="cm-variable">kind</span> <span class="cm-operator">==</span> <span class="cm-string">"on_tool_start"</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"🛠️ [Tool Start] </span>{<span class="cm-variable">name</span>}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">yield</span> <span class="cm-variable">format_sse</span>(<span class="cm-string">"tool_start"</span>, {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"tool_name"</span>: <span class="cm-variable">name</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"input"</span>: <span class="cm-variable">event</span>[<span class="cm-string">"data"</span>].<span class="cm-property">get</span>(<span class="cm-string">"input"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  })</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># --- 情况 C: 工具调用结束 (展示结果) ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">elif</span> <span class="cm-variable">kind</span> <span class="cm-operator">==</span> <span class="cm-string">"on_tool_end"</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"✅ [Tool End] </span>{<span class="cm-variable">name</span>}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 处理输出数据，防止 JSON 序列化错误</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">raw_output</span> <span class="cm-operator">=</span> <span class="cm-variable">event</span>[<span class="cm-string">"data"</span>].<span class="cm-property">get</span>(<span class="cm-string">"output"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">output_str</span> <span class="cm-operator">=</span> <span class="cm-builtin">str</span>(<span class="cm-variable">raw_output</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-builtin">hasattr</span>(<span class="cm-variable">raw_output</span>, <span class="cm-string">"content"</span>): </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">output_str</span> <span class="cm-operator">=</span> <span class="cm-variable">raw_output</span>.<span class="cm-property">content</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">yield</span> <span class="cm-variable">format_sse</span>(<span class="cm-string">"tool_end"</span>, {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"tool_name"</span>: <span class="cm-variable">name</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"output"</span>: <span class="cm-variable">output_str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  })</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 3. 对话结束，保存完整记录到磁盘</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">final_answer</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">history_mgr</span>.<span class="cm-property">save_interaction</span>(<span class="cm-variable">request</span>.<span class="cm-property">query</span>, <span class="cm-variable">final_answer</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 发送结束信号</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">yield</span> <span class="cm-variable">format_sse</span>(<span class="cm-string">"finish"</span>, {<span class="cm-string">"status"</span>: <span class="cm-string">"success"</span>})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">Exception</span> <span class="cm-keyword">as</span> <span class="cm-variable">e</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">import</span> <span class="cm-variable">traceback</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"❌ [Stream Error] </span>{<span class="cm-variable">traceback</span>.<span class="cm-property">format_exc</span>()}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">yield</span> <span class="cm-variable">format_sse</span>(<span class="cm-string">"error"</span>, {<span class="cm-string">"message"</span>: <span class="cm-builtin">str</span>(<span class="cm-variable">e</span>)})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 返回流式响应，告诉浏览器这是一个 SSE 流</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">StreamingResponse</span>(<span class="cm-variable">event_generator</span>(), <span class="cm-variable">media_type</span><span class="cm-operator">=</span><span class="cm-string">"text/event-stream"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-variable">__name__</span> <span class="cm-operator">==</span> <span class="cm-string">"__main__"</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">"🚀 启动 Server (Port 8002)..."</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">uvicorn</span>.<span class="cm-property">run</span>(<span class="cm-variable">app</span>, <span class="cm-variable">host</span><span class="cm-operator">=</span><span class="cm-string">"0.0.0.0"</span>, <span class="cm-variable">port</span><span class="cm-operator">=</span><span class="cm-number">8002</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 4492px;"></div><div class="CodeMirror-gutters" style="display: none; height: 4492px;"></div></div></div></pre><p><span>代码核心思路介绍：</span></p><ol><li><p><strong><span>Pydantic 类型校验</span></strong><span>：我们定义了 </span><code>ChatRequest</code><span> 类。如果前端传来的数据没有 </span><code>session_id</code><span>，FastAPI 会在入口处直接拒绝请求。这体现了</span><strong><span>“防御性编程”</span></strong><span>的思想。</span></p></li><li><p><strong><span>SSE (Server-Sent Events)</span></strong><span>：</span></p><ul><li><p><span>为什么不用 WebSocket？因为对于 Chat 这种“一问一答（虽然回答很长）”的场景，SSE 比 WebSocket 更轻量、更符合 HTTP 语义，且不需要处理复杂的心跳重连。</span></p></li><li><p><code>format_sse</code><span> 函数非常关键，它定义了前后端的</span><strong><span>“通讯协议”</span></strong><span>。前端只需要监听 </span><code>type</code><span> 是 </span><code>token</code><span> 还是 </span><code>tool_start</code><span>，就能渲染出完全不同的 UI。</span></p></li></ul></li><li><p><strong><span>事件流映射 (Event Mapping)</span></strong><span>：</span></p><ul><li><p><span>Agent 内部会产生几十种事件，我们只关心前端需要的（Token、Tool Start、Tool End）。</span></p></li><li><p><span>我们充当了“翻译官”的角色，把 LangChain 复杂的内部事件翻译成前端能看懂的简单 JSON。</span></p></li></ul></li></ol><h3 id='12启动与验证'><span>12.启动与验证</span></h3><p><span>现在，阶段一的所有代码都完成了。</span></p><ol><li><p><strong><span>启动后端</span></strong><span>：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> backend</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">python server.py</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 49px;"></div><div class="CodeMirror-gutters" style="display: none; height: 49px;"></div></div></div></pre><ul><li><p><span>终端应显示：</span><code>Uvicorn running on http://0.0.0.0:8002</code><span>。</span></p></li></ul></li><li><p><strong><span>测试 (使用 curl)</span></strong><span>：</span></p><p><span>Bash</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-X</span> POST <span class="cm-string">"http://localhost:8002/chat_stream"</span> \</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-attribute">-H</span> <span class="cm-string">"Content-Type: application/json"</span> \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-attribute">-d</span> <span class="cm-string">'{"query": "你好", "session_id": "test_001"}'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 74px;"></div><div class="CodeMirror-gutters" style="display: none; height: 74px;"></div></div></div></pre><ul><li><p><span>如果你看到终端里像流水一样吐出 </span><code>data: {&quot;type&quot;: &quot;token&quot;, ...}</code><span>，说明你的 Mini ChatGPT 核心已经有了心跳！</span></p></li></ul></li></ol><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512102002360.png" alt="image-20251210200226249" style="zoom:50%;" /></p><p><span>同时此时前端也已经能够输入消息看到反馈了：</span>
<img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512102003117.png" alt="image-20251210200259938" style="zoom:50%;" /></p><h2 id='四mcpmodel-context-protocol技术回顾'><span>四、MCP（model context protocol）技术回顾</span></h2><h3 id='1智能体开发核心技术---mcp'><span>1.智能体开发核心技术—MCP</span></h3><h4 id='11-function-calling技术回顾'><span>1.1 </span><strong><span>Function calling技术回顾</span></strong></h4><p><span>	</span><span>如何快速开发一款智能体应用，最关键的技术难点就在于如何让大模型高效稳定的接入一些外部工具。而在MCP技术诞生之前，最主流的方法，是借助Function calling技术来打通大模型和外部工具之间的联系，换而言之，也就是借助Function calling，来让大模型灵活的调用外部工具。</span></p><p><span>	</span><span>例如一个典型的Function calling示例，我们希望让大模型能够调用一些天气API查询即时天气，此时我们就需要创建一个查询天气的外部函数，负责调用天气API来查询天气，同时将外部函数的说明传递给大模型，使其能够根据用户意图，在必要的时候向外部函数发起调用请求。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250318202029130.png" alt="image-20250318202029130" style="zoom:33%;" /></p><blockquote><p><span>Function calling最早由OpenAI与2023年6月13号正式提出，该项技术的名字也由此命名：</span><a href='https://openai.com/index/function-calling-and-other-api-updates/' target='_blank' class='url'>https://openai.com/index/function-calling-and-other-api-updates/</a></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250422153118206.png" alt="image-20250422153118206" style="zoom:33%;" /></p><p><span>此外，Function calling也被称作tool use、tool call等技术。</span></p></blockquote><p><span>	</span><span>毫无疑问，Function calling的诞生意义重大，这项技术目前也成为大模型调用外部工具的基本技术范式，哪怕是MCP盛行的今天，底层仍然是Function calling执行流程。</span></p><h4 id='12-function-calling公开课介绍'><span>1.2 </span><strong><span>Function calling公开课介绍</span></strong></h4><p><span>	</span><span>而对于大模型开发者来说，无论是采用何种Agent开发框架或MCP技术，掌握Function calling的实现流程和底层原理至关重要，具体Function calling实现原理可以参考公开课《智能体从何而来？深度详解大模型调用工具底层原理》：</span><a href='https://www.bilibili.com/video/BV1w6dBYxELA/' target='_blank' class='url'>https://www.bilibili.com/video/BV1w6dBYxELA/</a><span>，而关于DeepSeek模型Function calling实现流程，可以参考公开课《DeepSeek智能体开发实战，从零手搓Mini Manus！》：</span><a href='https://www.bilibili.com/video/BV1L3ZDYDEnE/' target='_blank' class='url'>https://www.bilibili.com/video/BV1L3ZDYDEnE/</a><span>。</span></p><h4 id='13-function-calling能力从何而来'><span>1.3 </span><strong><span>Function calling能力从何而来</span></strong></h4><p><span>	</span><span>不过为了更好的学习本期公开课，需要重点强调的是关于大模型的Function calling的能力如何而来。我们都知道，对于当前大模型来说，有些模型有Function calling能力，如DeepSeek-V3模型，而有些模型没有，如DeepSeek-R1模型：</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250422154443869.png" alt="image-20250422154443869" style="zoom: 33%;" /></p><p><span>甚至对于DeepSeek-V3-0324模型来说，还支持工具的并联、串联调用甚至是自动debug：</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250422154552824.png" alt="image-20250422154552824" style="zoom: 50%;" /></p><blockquote><p><span>具体代码实现流程可参考公开课《DeepSeek智能体开发实战，从零手搓Mini Manus！》：</span><a href='https://www.bilibili.com/video/BV1L3ZDYDEnE/' target='_blank' class='url'>https://www.bilibili.com/video/BV1L3ZDYDEnE/</a><span>。</span></p></blockquote><p><span>那模型是如何具备Function calling能力的呢？答案是通过模型训练。对于DeepSeek-V3模型来说，由于在训练阶段（指令微调阶段）就带入了大量的类似如下的工具调用对话数据进行训练，因此能够识别外部工具并发起对外部工具调用的请求。而类似的，R1模型的训练过程没有工具调用数据，因此就不具备Function calling能力。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250422154737842.png" alt="image-20250422154737842" style="zoom: 50%;" /></p><blockquote><p><span>更多关于Function calling原理，可以参考公开课《智能体从何而来？深度详解大模型调用工具底层原理》：</span><a href='https://www.bilibili.com/video/BV1w6dBYxELA/' target='_blank' class='url'>https://www.bilibili.com/video/BV1w6dBYxELA/</a><span>，</span></p></blockquote><p><span>而Function calling的能力，是大模型顺利开启MCP功能的基础。</span></p><h4 id='14-mcp技术本质function-calling的更高层实现'><span>1.4 MCP技术本质：Function calling的更高层实现</span></h4><p><span>	</span><span>而近一段时间大火的MCP技术，其实就可以将其理解为Function calling技术的更高层封装和实现。传统的Function calling技术要求围绕不同的外部工具API单独创建一个外部函数，类似一把锁单独配一把钥匙，而一个智能体又往往涉及到多个外部工具设计，因此开发工作量很大。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250318185821214.png" alt="image-20250318185821214" style="zoom: 33%;" /></p><p><span>而MCP技术，全称为Model Context Protocol，模型上下文协议，是一种开发者共同遵守的协议，在这个协议框架下，大家围绕某个API开发的外部工具就能够共用，从而大幅减少重复造轮子的时间。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250318185810201.png" alt="image-20250318185810201" style="zoom: 33%;" /></p><h4 id='15-mcp技术带来的智能体开发效率革命'><span>1.5 MCP技术带来的智能体开发效率革命</span></h4><p><span>	</span><span>举个例子，在我们开设的《大模型原理与实战课程》：</span><a href='https://whakv.xetslk.com/s/3p66pN' target='_blank' class='url'>https://whakv.xetslk.com/s/3p66pN</a><span>系列课程中，2023年的第一期课程里曾经讲解过一个Agent实战项目，</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250422155926009.png" alt="image-20250422155926009" style="zoom:15%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250422155951977.png" alt="image-20250422155951977" style="zoom: 57%;" /></p><p><span>其中涉及关于大模型对话长短期记忆存储和管理相关功能实现时，光是编写消息类（Messages）对象的各种操作方法以及围绕本地文件夹的各类操作，如创建、删除、写入文档、清空对话、统计文本长度等，就写了300多行代码：</span></p><video src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/452c6c9140ae5c41827d619c7f830241_raw.mp4"></video><p><span>而现在，借助MCP技术，采用别人已经开发好的Filesystem工具，仅需几行代码，导入工具配置即可实现完全相同的功能。由此Agent开发效率大幅提高，而这就是MCP技术搭建起来的协作体系的力量。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250422160858753.png" alt="image-20250422160858753" style="zoom:50%;" /></p><h3 id='2-mcp服务器接入示例'><span>2. MCP服务器接入示例</span></h3><p><span>	</span><span>而在MCP技术大爆发的今天，接入一个MCP工具也是非常简单，以下是一个将高德地图导航MCP（服务器）接入Cherry Studio（客户端）的示例：</span></p><video src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/2025-04-14%2014-29-22.mp4"></video><blockquote><p><span>我们可以暂时把MCP服务器视作MCP工具。</span></p></blockquote><p><span>我们能看到，现在如果想要接入一个MCP工具，我们只需要在支持MCP功能的客户端中写入相关配置即可。例如我们只需要在Cherry Studio的MCP配置文档中写入如下字段：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="json"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"amap-maps"</span>: {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"isActive"</span>: <span class="cm-atom">true</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"command"</span>: <span class="cm-string">"npx"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"args"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"-y"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"@amap/amap-maps-mcp-server"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"env"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"AMAP_MAPS_API_KEY"</span>: <span class="cm-string">"YOUR_API_KRY"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"name"</span>: <span class="cm-string">"amap-maps"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 296px;"></div><div class="CodeMirror-gutters" style="display: none; height: 296px;"></div></div></div></pre><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250422162450429.png" referrerpolicy="no-referrer" alt="image-20250422162450429"></p><p><span>即可让大模型自动关联高德MCP工具（服务器），而一个高德MCP服务器的API有几十种之多：</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250422162541456.png" alt="image-20250422162541456" style="zoom:50%;" /></p><p><span>可以说是覆盖了出行生活的放方面。而当一个大模型接入高德MCP服务器后，就能瞬间化身出行规划智能体。</span></p><blockquote><p><span>更多客户端接入服务器方法，详见公开课《零门槛接入MCP！Cursor、阿里云百炼、Open-WebUI、Cherry Studio接入10大最热门MCP工具》：</span><a href='https://www.bilibili.com/video/BV1dCo7YdEgK/' target='_blank' class='url'>https://www.bilibili.com/video/BV1dCo7YdEgK/</a></p></blockquote><p><span>而要知道的是，如果没有MCP工具，我们需要单独围绕这些API将其封装为一个个外部函数，再据此创建一个出行规划智能体，其工作量可想而知。</span></p><h3 id='3-mcp工具标准接入流程'><span>3. MCP工具标准接入流程</span></h3><p><span>	</span><span>在上述示例中，我们不难发现，一个MCP服务器标准接入流程是通过写入一个配置文件来完成的。而在支持MCP功能的客户端（如Cherry Studio）中写入MCP工具的配置，其本质就是先将指定的MCP工具下载到本地，然后在有需要的时候对其进行调用。例如高德MCP配置文件如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="json"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"amap-maps"</span>: {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"isActive"</span>: <span class="cm-atom">true</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"command"</span>: <span class="cm-string">"npx"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"args"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"-y"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"@amap/amap-maps-mcp-server"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"env"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"AMAP_MAPS_API_KEY"</span>: <span class="cm-string">"YOUR_API_KRY"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"name"</span>: <span class="cm-string">"amap-maps"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 296px;"></div><div class="CodeMirror-gutters" style="display: none; height: 296px;"></div></div></div></pre><p><span>代表的含义就是我们需要先使用如下命令：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">npx <span class="cm-attribute">-y</span> @amap/amap-maps-mcp-server</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="display: none; height: 25px;"></div></div></div></pre><p><span>对这个库</span><code>@amap/amap-maps-mcp-server</code><span>进行下载，然后在本地运行，当有必要的时候调用这个库里面的函数执行相关功能。</span></p><p><span>	</span><span>而这个</span><code>@amap/amap-maps-mcp-server</code><span>库是一个托管在</span><a href='https://www.npmjs.com/' target='_blank' class='url'>https://www.npmjs.com/</a><span>上的库，</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250422163303357.png" alt="image-20250422163303357" style="zoom:33%;" /></p><p><span>可以使用npx命令进行下载。搜索库名即可看到这个库的完整代码，</span><a href='https://www.npmjs.com/package/@amap/amap-maps-mcp-server' target='_blank' class='url'>https://www.npmjs.com/package/@amap/amap-maps-mcp-server</a><span>：</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250422163336824.png" style="zoom: 33%;" /></p><p><span>而这种通过配置文件来进行MCP工具下载的方式，最早由Claude（MCP技术的提出者）提出并被广泛接纳。</span></p><h3 id='4-mcp服务器与客户端'><span>4. MCP服务器与客户端</span></h3><h4 id='41-mcp服务器server与客户端client概念介绍'><span>4.1 MCP服务器（server）与客户端（client）概念介绍</span></h4><p><span>	</span><span>在上面的示例中，Cherry Studio是一个支持MCP功能的客户端，而接入的高德MCP是一个MCP服务器，这里的客户端和服务器又是什么意思呢？</span></p><p><span>	</span><span>这其实是MCP技术体系中对于大模型和外部工具的另一种划分方式，也就是说在MCP技术体系中，会将外部工具运行脚本称作服务器，而接入这些外部工具的大模型运行环境称作客户端。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250318202116026.png" alt="image-20250318202116026" style="zoom:50%;" /></p><p><span>一个客户端可以接入多个不同类型的服务器的，但要求是都可以遵循MCP通信协议。简单理解就是MCP服务器的输出内容是一种标准格式的内容，只能被MCP客户端所识别。在客户端和服务器都遵循MCP协议的时候，客户端就能够像Function calling中大模型调用外部工具一样，调用MCP服务器里面的工具。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250318153131024.png" alt="image-20250318153131024" style="zoom:50%;" /></p><h4 id='42-mcp服务器集合'><span>4.2 MCP服务器集合</span></h4><p><span>	</span><span>暂时抛开底层原理不谈，在MCP技术爆发的这几个月，市面上已经诞生了成百上千的MCP服务器，甚至还出现了大量的MCP服务器集合网站：</span></p><ul><li><p><span>MCP官方服务器合集：</span><a href='https://github.com/modelcontextprotocol/servers' target='_blank' class='url'>https://github.com/modelcontextprotocol/servers</a></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250318195013063.png" alt="image-20250318195013063" style="zoom:50%;" /></p></li><li><p><span>MCP Github热门导航：</span><a href='https://github.com/punkpeye/awesome-mcp-servers' target='_blank' class='url'>https://github.com/punkpeye/awesome-mcp-servers</a></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250318195101093.png" alt="image-20250318195101093" style="zoom:50%;" /></p></li><li><p><span>Smithery：</span><a href='https://smithery.ai/' target='_blank' class='url'>https://smithery.ai/</a></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250410160659176.png" alt="image-20250410160659176" style="zoom:50%;" /></p></li><li><p><span>MCP导航：</span><a href='https://mcp.so/' target='_blank' class='url'>https://mcp.so/</a></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250318195025102.png" alt="image-20250318195025102" style="zoom:50%;" /></p></li></ul><p><span>在实际进行智能体开发过程中，我们可以参考这些网站上的MCP工具，并有选择的对其进行调用。但需要注意的是，无论这些网站的组织形式多么花样百出，但实际上当我们本地调用MCP工具的时候，都是通过uvx或者npx将对应的库下载到本地，然后再进行运行。</span></p><h3 id='5-mcp与function-calling技术对比介绍'><span>5. MCP与Function calling技术对比介绍</span></h3><p><span>	</span><span>此外，我们还需要补充一点的是关于Function calling和MCP技术的关系。通过在MCP运行过程的抓包可知，MCP底层实际上仍然是借助大模型原生的Function calling来完成外部工具调用，只不过进行了更高层的封装。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250422164758122.png" alt="image-20250422164758122" style="zoom:50%;" /></p><p><span>实际上MCP客户端对MCP服务器上的工具调用流程如下：</span></p><ul><li><p><strong><span>Step 1. 建立和服务器的通信</span></strong><span>；</span></p></li><li><p><strong><span>Step 2. 查询服务器上总共有多少个外部工具；</span></strong></p></li><li><p><strong><span>Step 3. 将外部工具组成列表，带入到当前对话中；</span></strong></p></li><li><p><strong><span>Step 4. 借助Function calling进行外部工具调用。</span></strong></p></li></ul><p><span>也就是说，如果模型本身不支持Function calling，那么是无法顺利开启MCP功能的。</span></p><p><span>	</span><span>不过这里也有例外，那就是Open-WebUI和cline作为MCP客户端时，可以使用不具备Function calling功能的DeepSeek-R1模型进行MCP工具调用，这是为何呢？</span></p><p><span>	</span><span>原因非常简单，那就是这些客户端内置了一些提示词模板，借助提示让大模型输出类似Function call message（调用外部工具的信息）的内容，然后开启Function calling，从而能够调用MCP工具。举个例子，对于cline来说会通过一段非常长的提示词，引导模型输出Function call message：</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250422165507170.png" alt="image-20250422165507170" style="zoom:50%;" /></p><blockquote><p><span>cline项目官网：</span><a href='https://github.com/cline/cline' target='_blank' class='url'>https://github.com/cline/cline</a></p></blockquote><p><span>我们可以将其精简为如下形式：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">system_message</span> <span class="cm-operator">=</span> (</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"You are a helpful assistant with access to these tools:\n\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">f"</span>{<span class="cm-variable">tools_description</span>}<span class="cm-string">\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"Choose the appropriate tool based on the user's question. "</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"If no tool is needed, reply directly.\n\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"IMPORTANT: When you need to use a tool, you must ONLY respond with "</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"the exact JSON object format below, nothing else:\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"{\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">' &nbsp;  "tool": "tool-name",\n'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">' &nbsp;  "arguments": {\n'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">' &nbsp; &nbsp; &nbsp;  "argument-name": "value"\n'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">" &nbsp;  }\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"}\n\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"After receiving a tool's response:\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"1. Transform the raw data into a natural, conversational response\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"2. Keep responses concise but informative\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"3. Focus on the most relevant information\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"4. Use appropriate context from the user's question\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"5. Avoid simply repeating the raw data\n\n"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"Please use only the tools that are explicitly defined above."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 642px;"></div><div class="CodeMirror-gutters" style="display: none; height: 642px;"></div></div></div></pre><p><span>翻译如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="markdown" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="markdown"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">你是一个乐于助人的助手，可以使用以下工具：</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">```</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{tools_description}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">```</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">请根据用户的问题选择合适的工具。<span class="cm-trailing-space-a"> </span><span class="cm-trailing-space-new-line">&nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">如果不需要使用工具，请直接回复。</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">重要提示：如果需要使用工具，<span class="cm-strong">**你必须仅以以下精确的 JSON 对象格式进行回复，不要添加其他内容**</span>：</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">```json</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">"tool": "工具名称",</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">"arguments": {</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">"参数名称": "参数值"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">```</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">在收到工具返回的结果后：</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-block-start cm-variable-2">1. </span><span class="cm-variable-2">将原始数据转化为自然、对话式的回答</span><span class="cm-variable-2 cm-trailing-space-a"> </span><span class="cm-variable-2 cm-trailing-space-new-line">&nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-block-start cm-variable-2">2. </span><span class="cm-variable-2">保持回答简洁但富有信息量</span><span class="cm-variable-2 cm-trailing-space-a"> </span><span class="cm-variable-2 cm-trailing-space-new-line">&nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-block-start cm-variable-2">3. </span><span class="cm-variable-2">聚焦于最相关的信息</span><span class="cm-variable-2 cm-trailing-space-a"> </span><span class="cm-variable-2 cm-trailing-space-new-line">&nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-block-start cm-variable-2">4. </span><span class="cm-variable-2">使用用户问题中的相关上下文</span><span class="cm-variable-2 cm-trailing-space-a"> </span><span class="cm-variable-2 cm-trailing-space-new-line">&nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-block-start cm-variable-2">5. </span><span class="cm-variable-2">避免直接照搬原始数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">请<span class="cm-strong">**只使用上述明确定义的工具**</span>。</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 740px;"></div><div class="CodeMirror-gutters" style="display: none; height: 740px;"></div></div></div></pre><p><span>在这些提示词引导下，一些不具备Function calling的大模型，也能顺利使用MCP工具。不过需要注意的是，借助提示词开启的MCP功能，毕竟不如模型原生能力稳定，因此如果希望搭建企业级应用的Agent，最好还是使用具备Function calling功能的大模型。</span></p><h3 id='6-mcp技术生态'><span>6. MCP技术生态</span></h3><p><span>	</span><span>最后需要介绍当前MCP完整的技术生态。MCP技术发展至今，已经不再是简单的“协议”，而是一个包含了协议、开发工具和现成的已经开发好的MCP工具所共同组成的完整技术生态。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/image-20250416155146454.png" alt="image-20250416155146454" style="zoom:50%;" /></p><p><span>其中：</span></p><ul><li><p><strong><span>MCP协议：</span></strong><span>指的是“虚”的规范，例如大模型和工具调度规范、服务器客户端的通信规范等，遵循这些协议的对象就是MCP服务器或客户端；</span></p></li><li><p><strong><span>MCP开发工具：</span></strong><span>包含多种语言的SDK，也就是开发工具包，开发人员能够使用这些SDK快速完成MCP的服务器和客户端开发；</span></p></li><li><p><strong><span>MCP服务器生态：</span></strong><span>开源的MCP服务器，是基于MCP协议的庞大的技术生态，智能体开发人员可以直接使用开源的MCP工具来加快开发进程。</span></p></li></ul><p>&nbsp;</p><p>&nbsp;</p><h2 id='五mini-chatgpt-第二阶段开发实操打造智能体操作系统'><span>五、mini ChatGPT 第二阶段开发实操：打造智能体操作系统</span></h2><blockquote><p><span>在第一阶段，我们成功构建了一个“能对话、能查天气”的 AI 助手，但它的能力是被</span><strong><span>硬编码（Hardcoded）</span></strong><span>在代码里的。每次想要增加新功能（比如查股票、操作数据库），都需要修改 tools.py 并重启服务。</span></p><p><span>在第二阶段，我们将引入 </span><strong><span>MCP (Model Context Protocol)</span></strong><span>，对系统进行“基因重组”，将其升级为一个 </span><strong><span>Agent OS（智能体操作系统）</span></strong><span>。</span></p></blockquote><p><strong><span>核心交付标准 (Requirements)：</span></strong></p><ol><li><p><strong><span>能力热插拔 (Hot-Swapping)</span></strong><span>：用户在前端勾选某个工具，Agent 在毫秒级内即可获得该能力，</span><strong><span>无需重启后端服务</span></strong><span>。</span></p></li><li><p><strong><span>混合连接架构 (Hybrid Connectivity)</span></strong><span>：</span></p><ul><li><p><strong><span>本地安全连接 (StdIO)</span></strong><span>：支持连接本地 Python 脚本或数据库，确保敏感数据不出域。</span></p></li><li><p><strong><span>远程云服务 (SSE)</span></strong><span>：支持连接互联网上的标准 MCP 服务（如高德地图、12306）。</span></p></li></ul></li><li><p><strong><span>零代码配置 (No-Code Config)</span></strong><span>：普通用户可以通过前端界面填写 API Key 或文件路径来配置工具，无需接触 Python 代码。</span></p></li><li><p><strong><span>跨平台兼容 (Cross-Platform)</span></strong><span>：后端需自动处理 Windows/Mac/Linux 的路径差异，确保配置文件的可移植性。</span></p></li></ol><h3 id='1-架构设计与数据层构建-data-layer'><span>1. 架构设计与数据层构建 (Data Layer)</span></h3><blockquote><p><span>设计理念：任何复杂的系统，都是数据先行。在编写逻辑代码之前，我们需要先定义好</span><strong><span>“应用商店（Registry）”和“用户配置（Config）”</span></strong><span>的数据结构。这两个 JSON 文件将是整个系统的基石。</span></p></blockquote><h4 id='11-核心概念回顾mcp-的两种连接形态'><span>1.1 核心概念回顾：MCP 的两种连接形态</span></h4><p><span>在设计数据结构前，必须明确 MCP 的两种核心传输协议，因为配置文件的写法完全不同：</span></p><ul><li><p><strong><span>StdIO (Standard Input/Output)</span></strong><span>：</span></p><ul><li><p><strong><span>原理</span></strong><span>：Agent 直接启动一个子进程（Subprocess）。</span></p></li><li><p><strong><span>场景</span></strong><span>：本地工具（如 </span><code>mcp-server-time</code><span>, </span><code>sqlite</code><span>）。</span></p></li><li><p><strong><span>配置核心</span></strong><span>：需要 </span><code>command</code><span>（执行什么命令，如 python）和 </span><code>args</code><span>（参数）。</span></p></li></ul></li><li><p><strong><span>SSE (Server-Sent Events)</span></strong><span>：</span></p><ul><li><p><strong><span>原理</span></strong><span>：Agent 通过 HTTP 长连接与远程服务器通信。</span></p></li><li><p><strong><span>场景</span></strong><span>：云端服务（如阿里云百炼 MCP）。</span></p></li><li><p><strong><span>配置核心</span></strong><span>：需要 </span><code>url</code><span>（服务器地址）和 </span><code>headers</code><span>（鉴权信息）。</span></p></li></ul></li></ul><h4 id='12-构建-mcp-工具知识库-mcpregistryjson'><span>1.2 构建 MCP 工具知识库 (</span><code>mcp_registry.json</code><span>)</span></h4><p><span>这是我们的“应用商店”数据源。它是一个</span><strong><span>只读</span></strong><span>的 JSON 列表，定义了系统预置了哪些工具，以及它们的默认配置模板。</span></p><p><strong><span>操作</span></strong><span>：请在 </span><code>mini_chatgpt/backend/</code><span> 目录下创建 </span><code>mcp_registry.json</code><span>。</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512102010284.png" alt="image-20251210201051085" style="zoom:50%;" /></p><p><strong><span>代码内容：</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="json" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"name"</span>: <span class="cm-string">"time"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"category"</span>: <span class="cm-string">"Utility"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"description"</span>: <span class="cm-string">"提供精确的当前时间查询和时区转换功能。"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"type"</span>: <span class="cm-string">"stdio"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"default_config"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"command"</span>: <span class="cm-string">"python"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"args"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"-m"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"mcp_server_time"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"name"</span>: <span class="cm-string">"sqlite"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"category"</span>: <span class="cm-string">"Database"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"description"</span>: <span class="cm-string">"本地 SQLite 数据库工具。支持查看表结构和执行 SQL 查询。"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"type"</span>: <span class="cm-string">"stdio"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"default_config"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"command"</span>: <span class="cm-string">"python"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"args"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"-m"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"mcp_server_sqlite"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"--db-path"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"./test.db"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"name"</span>: <span class="cm-string">"amap-maps"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"category"</span>: <span class="cm-string">"Geo/Travel"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"description"</span>: <span class="cm-string">"高德地图官方 MCP。提供地点搜索、路径规划、天气查询等服务。"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"type"</span>: <span class="cm-string">"sse"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"default_config"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"url"</span>: <span class="cm-string">"https://dashscope.aliyuncs.com/api/v1/mcps/amap-maps/sse"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"headers"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"Authorization"</span>: <span class="cm-string">"Bearer 你的阿里百炼API-Key"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1111px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1111px;"></div></div></div></pre><p><span>josn文档功能解读：</span></p><ul><li><p><strong><code>type</code></strong><span>: 明确区分了 </span><code>stdio</code><span> 和 </span><code>sse</code><span>，这是后续 </span><code>MCPManager</code><span> 决定如何启动客户端的关键依据。</span></p></li><li><p><strong><code>default_config</code></strong><span>: 这是一个</span><strong><span>模板</span></strong><span>。</span></p><ul><li><p><span>对于 </span><code>time</code><span>，模板里写的是 </span><code>python</code><span>，我们在后续代码中会将其动态替换为 </span><code>sys.executable</code><span>（当前环境的 Python），从而实现跨平台。</span></p></li><li><p><span>对于 </span><code>amap-maps</code><span>，模板里留了 </span><code>&quot;Bearer 你的API-Key&quot;</code><span>，提示用户在安装时需要填入自己的密钥。</span></p></li></ul></li></ul><h4 id='13-设计用户配置存储-mcpconfigjson'><span>1.3 设计用户配置存储 (</span><code>mcp_config.json</code><span>)</span></h4><p><span>这是用户的</span><strong><span>个性化存档</span></strong><span>。它记录了用户到底安装了哪些工具、是否激活、以及具体的配置参数（如真实的 API Key）。</span></p><p><span>操作：在 mini_chatgpt/backend/ 目录下创建 mcp_config.json。(注意：在实际运行中，这个文件通常由程序自动生成，但为了测试，我们可以先手动创建一个初始版本)</span></p><p><strong><span>代码内容：</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="json" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"tools"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"time"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"type"</span>: <span class="cm-string">"stdio"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"description"</span>: <span class="cm-string">"提供精确的当前时间查询和时区转换功能。"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"active"</span>: <span class="cm-atom">true</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"config"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"command"</span>: <span class="cm-string">"python"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"args"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"-m"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"mcp_server_time"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 395px;"></div><div class="CodeMirror-gutters" style="display: none; height: 395px;"></div></div></div></pre><p><span>json文件解读：</span></p><ul><li><p><strong><code>active</code></strong><span>: 这是一个布尔值开关。</span></p><ul><li><p><code>true</code><span>: Agent 在启动时会加载这个工具。</span></p></li><li><p><code>false</code><span>: 即使配置存在，Agent 也会忽略它。这实现了“软删除”或“临时禁用”的功能。</span></p></li></ul></li><li><p><strong><code>config</code></strong><span>: 这里存储的是</span><strong><span>最终执行时</span></strong><span>的参数。</span></p><ul><li><p><strong><span>思考题</span></strong><span>：这里的 </span><code>command</code><span> 写的是 </span><code>python</code><span>，但在 Windows 和 Mac 上，Python 的绝对路径是不同的。如果我们把绝对路径写死在这里（例如 </span><code>C:\Python312\python.exe</code><span>），把文件发给别人就跑不起来了。</span></p></li><li><p><strong><span>伏笔</span></strong><span>：我们在接下来的 </span><code>MCPManager</code><span> 开发中，会编写一个</span><strong><span>“路径自适应”</span></strong><span>逻辑，在读取配置的瞬间，把这里的 </span><code>python</code><span> 动态替换为当前环境的绝对路径。这就是工业级开发的细节！</span></p></li></ul></li></ul><h3 id='2-核心业务逻辑开发mcp-管理器-business-logic-layer'><span>2. 核心业务逻辑开发：MCP 管理器 (Business Logic Layer)</span></h3><blockquote><p><span>开发目标：编写 backend/mcp_manager.py。我们将在这个文件中实现三大核心能力：</span></p><ol><li><p><strong><span>全生命周期管理</span></strong><span>：工具的增删改查与状态切换。</span></p></li><li><p><strong><span>智能容错机制</span></strong><span>：处理用户乱填配置（嵌套 JSON）和环境差异（Windows/Mac 路径）的自动纠错。</span></p></li><li><p><strong><span>AI 驱动推荐</span></strong><span>：集成 DeepSeek 模型，实现“说人话，找工具”。</span></p></li></ol></blockquote><h4 id='21-依赖导入与-pydantic-模型定义'><span>2.1 依赖导入与 Pydantic 模型定义</span></h4><p><span>首先，我们需要定义 AI 推荐返回的数据结构。在 LangChain 1.0 中，使用 </span><strong><span>Pydantic</span></strong><span> 定义结构化输出是标准范式。</span></p><p><strong><span>代码片段 (mcp_manager.py 头部)：</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">json</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">os</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">sys</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">asyncio</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">typing</span> <span class="cm-keyword">import</span> <span class="cm-variable">List</span>, <span class="cm-variable">Dict</span>, <span class="cm-variable">Tuple</span>, <span class="cm-variable">Optional</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">dotenv</span> <span class="cm-keyword">import</span> <span class="cm-variable">load_dotenv</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1. 核心依赖</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">pydantic</span> <span class="cm-keyword">import</span> <span class="cm-variable">BaseModel</span>, <span class="cm-variable">Field</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain_deepseek</span> <span class="cm-keyword">import</span> <span class="cm-variable">ChatDeepSeek</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain_core</span>.<span class="cm-property">prompts</span> <span class="cm-keyword">import</span> <span class="cm-variable">ChatPromptTemplate</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># MCP 官方客户端 (用于测试连接)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain_mcp_adapters</span>.<span class="cm-property">client</span> <span class="cm-keyword">import</span> <span class="cm-variable">MultiServerMCPClient</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">load_dotenv</span>(<span class="cm-variable">override</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">REGISTRY_FILE</span> <span class="cm-operator">=</span> <span class="cm-string">"mcp_registry.json"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">CONFIG_FILE</span> <span class="cm-operator">=</span> <span class="cm-string">"mcp_config.json"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Pydantic 模型: 定义 AI 推荐的输出格式 ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">ToolRecommendation</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""单个工具推荐"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">name</span>: <span class="cm-builtin">str</span> <span class="cm-operator">=</span> <span class="cm-variable">Field</span>(<span class="cm-variable">description</span><span class="cm-operator">=</span><span class="cm-string">"工具名称，必须与知识库一致"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">reason</span>: <span class="cm-builtin">str</span> <span class="cm-operator">=</span> <span class="cm-variable">Field</span>(<span class="cm-variable">description</span><span class="cm-operator">=</span><span class="cm-string">"推荐理由"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">RecommendationList</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""推荐列表容器"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">recommendations</span>: <span class="cm-variable">List</span>[<span class="cm-variable">ToolRecommendation</span>]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 716px;"></div><div class="CodeMirror-gutters" style="display: none; height: 716px;"></div></div></div></pre><h4 id='22-核心类构建与基础-crud'><span>2.2 核心类构建与基础 CRUD</span></h4><p><span>接下来是 </span><code>MCPManager</code><span> 的初始化和基础读写功能。这里的关键点在于</span><strong><span>列表读取时的格式化</span></strong><span>。</span></p><p><strong><span>代码片段 (MCPManager 类基础)：</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">MCPManager</span>:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">__init__</span>(<span class="cm-variable-2">self</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 初始化时加载配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">self</span>.<span class="cm-property">config</span> <span class="cm-operator">=</span> <span class="cm-variable-2">self</span>.<span class="cm-property">_load_config</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">self</span>.<span class="cm-property">registry</span> <span class="cm-operator">=</span> <span class="cm-variable-2">self</span>.<span class="cm-property">_load_registry</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 初始化 DeepSeek (低温度，保证推荐稳定)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">self</span>.<span class="cm-property">llm</span> <span class="cm-operator">=</span> <span class="cm-variable">ChatDeepSeek</span>(<span class="cm-variable">model</span><span class="cm-operator">=</span><span class="cm-string">"deepseek-chat"</span>, <span class="cm-variable">temperature</span><span class="cm-operator">=</span><span class="cm-number">0.1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ... (省略 _load_config / _save_config 的标准文件读写代码，与之前一致) ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># --- 核心功能: 获取安装列表 (带前端优化) ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">list_installed_tools</span>(<span class="cm-variable-2">self</span>) <span class="cm-operator">-&gt;</span> <span class="cm-variable">List</span>[<span class="cm-variable">Dict</span>]:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp;  列出已安装工具。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp;  关键点：额外返回 config_json 字符串，供前端编辑器直接显示。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 每次读取前强制刷新，防止多进程数据不一致</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">self</span>.<span class="cm-property">config</span> <span class="cm-operator">=</span> <span class="cm-variable-2">self</span>.<span class="cm-property">_load_config</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">results</span> <span class="cm-operator">=</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">name</span>, <span class="cm-variable">data</span> <span class="cm-keyword">in</span> <span class="cm-variable-2">self</span>.<span class="cm-property">config</span>.<span class="cm-property">get</span>(<span class="cm-string">"tools"</span>, {}).<span class="cm-property">items</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">raw_config</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span>.<span class="cm-property">get</span>(<span class="cm-string">"config"</span>, {})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">results</span>.<span class="cm-property">append</span>({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"name"</span>: <span class="cm-variable">name</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"description"</span>: <span class="cm-variable">data</span>.<span class="cm-property">get</span>(<span class="cm-string">"description"</span>, <span class="cm-string">""</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"active"</span>: <span class="cm-variable">data</span>.<span class="cm-property">get</span>(<span class="cm-string">"active"</span>, <span class="cm-keyword">True</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"type"</span>: <span class="cm-variable">data</span>.<span class="cm-property">get</span>(<span class="cm-string">"type"</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"config"</span>: <span class="cm-variable">raw_config</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># [前端适配] 将字典转为格式化的 JSON 字符串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"config_json"</span>: <span class="cm-variable">json</span>.<span class="cm-property">dumps</span>(<span class="cm-variable">raw_config</span>, <span class="cm-variable">ensure_ascii</span><span class="cm-operator">=</span><span class="cm-keyword">False</span>, <span class="cm-variable">indent</span><span class="cm-operator">=</span><span class="cm-number">2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  })</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">results</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 888px;"></div><div class="CodeMirror-gutters" style="display: none; height: 888px;"></div></div></div></pre><h4 id='23-健壮的连接测试-testtoolconnection'><span>2.3 健壮的连接测试 (</span><code>test_tool_connection</code><span>)</span></h4><p><span>这是本节的</span><strong><span>“高光时刻”</span></strong><span>。我们要解决两个让无数开发者头疼的问题：</span></p><ol><li><p><strong><span>用户乱填</span></strong><span>：直接把阿里百炼的文档复制粘贴进去（导致 JSON 嵌套）。</span></p></li><li><p><strong><span>环境差异</span></strong><span>：Windows 写的配置传给 Mac，路径报错。</span></p></li></ol><p><strong><span>代码片段 (test_tool_connection)：</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.2949px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">test_tool_connection</span>(<span class="cm-variable-2">self</span>, <span class="cm-variable">name</span>: <span class="cm-builtin">str</span>, <span class="cm-builtin">type</span>: <span class="cm-builtin">str</span>, <span class="cm-variable">config_dict</span>: <span class="cm-variable">Dict</span>) <span class="cm-operator">-&gt;</span> <span class="cm-variable">Tuple</span>[<span class="cm-builtin">bool</span>, <span class="cm-builtin">str</span>]:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp;  测试连接：包含 [智能拆包] + [路径自适应] + [超时熔断] 三重保障</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"🧪 [Debug] 收到测试请求: </span>{<span class="cm-variable">name</span>}<span class="cm-string">, Type: </span>{<span class="cm-builtin">type</span>}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># --- 第一重保障: 智能拆包 (Anti-Stupidity) ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 针对用户粘贴了包含 "type" 和 "config" 的嵌套 JSON 的情况</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">real_config</span> <span class="cm-operator">=</span> <span class="cm-variable">config_dict</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">real_type</span> <span class="cm-operator">=</span> <span class="cm-builtin">type</span>.<span class="cm-property">strip</span>().<span class="cm-property">lower</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-builtin">isinstance</span>(<span class="cm-variable">config_dict</span>, <span class="cm-builtin">dict</span>) <span class="cm-keyword">and</span> <span class="cm-string">"config"</span> <span class="cm-keyword">in</span> <span class="cm-variable">config_dict</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"📦 [Auto-Fix] 检测到嵌套配置，正在自动清洗..."</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 提取内部真实的 type 和 config</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-string">"type"</span> <span class="cm-keyword">in</span> <span class="cm-variable">config_dict</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">real_type</span> <span class="cm-operator">=</span> <span class="cm-variable">config_dict</span>[<span class="cm-string">"type"</span>].<span class="cm-property">strip</span>().<span class="cm-property">lower</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">real_config</span> <span class="cm-operator">=</span> <span class="cm-variable">config_dict</span>[<span class="cm-string">"config"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># --- 第二重保障: 跨平台路径修正 (Cross-Platform) ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 针对本地工具 (stdio)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">real_type</span> <span class="cm-operator">==</span> <span class="cm-string">"stdio"</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">args</span> <span class="cm-operator">=</span> <span class="cm-variable">real_config</span>.<span class="cm-property">get</span>(<span class="cm-string">"args"</span>, [])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cmd</span> <span class="cm-operator">=</span> <span class="cm-builtin">str</span>(<span class="cm-variable">real_config</span>.<span class="cm-property">get</span>(<span class="cm-string">"command"</span>, <span class="cm-string">""</span>)).<span class="cm-property">lower</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 如果是 Python 模块调用 (-m)，强制使用当前环境解释器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-string">"-m"</span> <span class="cm-keyword">in</span> <span class="cm-variable">args</span> <span class="cm-keyword">or</span> <span class="cm-string">"python"</span> <span class="cm-keyword">in</span> <span class="cm-variable">cmd</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">current_python</span> <span class="cm-operator">=</span> <span class="cm-variable">sys</span>.<span class="cm-property">executable</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"🔄 [Auto-Fix] 路径修正: </span>{<span class="cm-variable">current_python</span>}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">real_config</span>[<span class="cm-string">"command"</span>] <span class="cm-operator">=</span> <span class="cm-variable">current_python</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># --- 构造客户端配置 ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">client_config</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"transport"</span>: <span class="cm-variable">real_type</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">**</span><span class="cm-variable">real_config</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># --- 第三重保障: 超时熔断 (Timeout) ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 实例化客户端 (LangChain MCP Adapter)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">client</span> <span class="cm-operator">=</span> <span class="cm-variable">MultiServerMCPClient</span>(<span class="cm-variable">client_config</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 强制 5秒超时，防止错误的 SSE 地址导致后端无限卡死</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">tools</span> <span class="cm-operator">=</span> <span class="cm-keyword">await</span> <span class="cm-variable">asyncio</span>.<span class="cm-property">wait_for</span>(<span class="cm-variable">client</span>.<span class="cm-property">get_tools</span>(), <span class="cm-variable">timeout</span><span class="cm-operator">=</span><span class="cm-number">5.0</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">tool_names</span> <span class="cm-operator">=</span> [<span class="cm-variable">t</span>.<span class="cm-property">name</span> <span class="cm-keyword">for</span> <span class="cm-variable">t</span> <span class="cm-keyword">in</span> <span class="cm-variable">tools</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">True</span>, <span class="cm-string">f"✅ 连接成功！发现 </span>{<span class="cm-builtin">len</span>(<span class="cm-variable">tools</span>)}<span class="cm-string"> 个工具: </span>{<span class="cm-string">', '</span>.<span class="cm-property">join</span>(<span class="cm-variable">tool_names</span>[:<span class="cm-number">3</span>])}<span class="cm-string">..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">asyncio</span>.<span class="cm-property">TimeoutError</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">False</span>, <span class="cm-string">"❌ 连接超时 (5s)。请检查网络或 URL。"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">Exception</span> <span class="cm-keyword">as</span> <span class="cm-variable">e</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">False</span>, <span class="cm-string">f"❌ 连接错误: </span>{<span class="cm-builtin">str</span>(<span class="cm-variable">e</span>)}<span class="cm-string">"</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1530px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1530px;"></div></div></div></pre><p><span>代码解读</span></p><ul><li><p><strong><span>为什么要“智能拆包”？</span></strong><span> 用户不懂什么是“标准格式”，他们只会复制粘贴。后端多写 5 行代码，能减少 90% 的用户配置报错，这就是产品思维。</span></p></li><li><p><strong><code>sys.executable</code><span> 的妙用</span></strong><span>：这行代码让你的配置文件具备了“流动性”。无论你在谁的电脑上跑，它永远指向“当前正在干活的那个 Python”，彻底消灭 </span><code>File not found</code><span>。</span></p></li></ul><h4 id='24-实现-ai-智能推荐-airecommendtools'><span>2.4 实现 AI 智能推荐 (</span><code>ai_recommend_tools</code><span>)</span></h4><p><span>利用 LangChain 1.0 的 </span><code>with_structured_output</code><span> 能力，让 DeepSeek 变成专业的“工具导购员”。</span></p><p><strong><span>代码片段：</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.2949px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">ai_recommend_tools</span>(<span class="cm-variable-2">self</span>, <span class="cm-variable">user_query</span>: <span class="cm-builtin">str</span>) <span class="cm-operator">-&gt;</span> <span class="cm-variable">List</span>[<span class="cm-variable">Dict</span>]:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"""根据用户需求推荐工具"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 1. 压缩知识库 (只取关键字段，省 Token)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">registry_text</span> <span class="cm-operator">=</span> <span class="cm-variable">json</span>.<span class="cm-property">dumps</span>([</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {<span class="cm-string">"name"</span>: <span class="cm-variable">t</span>[<span class="cm-string">"name"</span>], <span class="cm-string">"desc"</span>: <span class="cm-variable">t</span>[<span class="cm-string">"description"</span>]} </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">t</span> <span class="cm-keyword">in</span> <span class="cm-variable-2">self</span>.<span class="cm-property">registry</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ], <span class="cm-variable">ensure_ascii</span><span class="cm-operator">=</span><span class="cm-keyword">False</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 2. 编写 Prompt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">prompt</span> <span class="cm-operator">=</span> <span class="cm-variable">ChatPromptTemplate</span>.<span class="cm-property">from_template</span>(<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp;  用户需求："{query}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp;  工具库：{registry}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp;  请挑选最合适的工具（最多3个）。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp;  """</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 3. 结构化输出 (LangChain 1.0 核心特性)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 这一步自动完成了 JSON Schema 的生成和解析</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">chain</span> <span class="cm-operator">=</span> <span class="cm-variable">prompt</span> <span class="cm-operator">|</span> <span class="cm-variable-2">self</span>.<span class="cm-property">llm</span>.<span class="cm-property">with_structured_output</span>(<span class="cm-variable">RecommendationList</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">res</span> <span class="cm-operator">=</span> <span class="cm-keyword">await</span> <span class="cm-variable">chain</span>.<span class="cm-property">ainvoke</span>({<span class="cm-string">"query"</span>: <span class="cm-variable">user_query</span>, <span class="cm-string">"registry"</span>: <span class="cm-variable">registry_text</span>})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 4. 数据回填 (将推荐结果与 registry 里的详细配置合并)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">final_results</span> <span class="cm-operator">=</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">item</span> <span class="cm-keyword">in</span> <span class="cm-variable">res</span>.<span class="cm-property">recommendations</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">original</span> <span class="cm-operator">=</span> <span class="cm-builtin">next</span>((<span class="cm-variable">t</span> <span class="cm-keyword">for</span> <span class="cm-variable">t</span> <span class="cm-keyword">in</span> <span class="cm-variable-2">self</span>.<span class="cm-property">registry</span> <span class="cm-keyword">if</span> <span class="cm-variable">t</span>[<span class="cm-string">"name"</span>] <span class="cm-operator">==</span> <span class="cm-variable">item</span>.<span class="cm-property">name</span>), <span class="cm-keyword">None</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">original</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">final_results</span>.<span class="cm-property">append</span>({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">**</span><span class="cm-variable">original</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"recommend_reason"</span>: <span class="cm-variable">item</span>.<span class="cm-property">reason</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"installed"</span>: <span class="cm-variable">item</span>.<span class="cm-property">name</span> <span class="cm-keyword">in</span> <span class="cm-variable-2">self</span>.<span class="cm-property">config</span>.<span class="cm-property">get</span>(<span class="cm-string">"tools"</span>, {})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  })</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">final_results</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">Exception</span> <span class="cm-keyword">as</span> <span class="cm-variable">e</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"推荐失败: </span>{<span class="cm-variable">e</span>}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> []</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1012px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1012px;"></div></div></div></pre><h4 id='25-运行时配置生成-getactiveconfig'><span>2.5 运行时配置生成 (</span><code>get_active_config</code><span>)</span></h4><p><span>最后，我们需要一个方法，把存在磁盘里的配置，变成 </span><code>agent.py</code><span> 能用的配置字典。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">get_active_config</span>(<span class="cm-variable-2">self</span>) <span class="cm-operator">-&gt;</span> <span class="cm-variable">Dict</span>:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"""生成给 Agent 使用的运行时配置"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 每次调用都重读文件，确保 Agent 拿到最新状态</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">self</span>.<span class="cm-property">config</span> <span class="cm-operator">=</span> <span class="cm-variable-2">self</span>.<span class="cm-property">_load_config</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">final_config</span> <span class="cm-operator">=</span> {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">name</span>, <span class="cm-variable">data</span> <span class="cm-keyword">in</span> <span class="cm-variable-2">self</span>.<span class="cm-property">config</span>.<span class="cm-property">get</span>(<span class="cm-string">"tools"</span>, {}).<span class="cm-property">items</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">data</span>.<span class="cm-property">get</span>(<span class="cm-string">"active"</span>, <span class="cm-keyword">True</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cfg</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span>[<span class="cm-string">"config"</span>].<span class="cm-property">copy</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 再次应用路径修正逻辑，确保运行时不出错</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">data</span>[<span class="cm-string">"type"</span>] <span class="cm-operator">==</span> <span class="cm-string">"stdio"</span> <span class="cm-keyword">and</span> <span class="cm-string">"-m"</span> <span class="cm-keyword">in</span> <span class="cm-variable">cfg</span>.<span class="cm-property">get</span>(<span class="cm-string">"args"</span>, []):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cfg</span>[<span class="cm-string">"command"</span>] <span class="cm-operator">=</span> <span class="cm-variable">sys</span>.<span class="cm-property">executable</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">final_config</span>[<span class="cm-variable">name</span>] <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"transport"</span>: <span class="cm-variable">data</span>[<span class="cm-string">"type"</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">**</span><span class="cm-variable">cfg</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">final_config</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 494px;"></div><div class="CodeMirror-gutters" style="display: none; height: 494px;"></div></div></div></pre><h3 id='3-agent-核心重构实现动态工厂模式-core-refactoring'><span>3. Agent 核心重构：实现动态工厂模式 (Core Refactoring)</span></h3><blockquote><p><span>开发目标：推翻第一阶段“写死”的 agent.py，引入设计模式中的</span><strong><span>“工厂模式（Factory Pattern）”</span></strong><span>。</span></p><p><span>我们要实现的目标是：每次用户发起对话时，Agent 都会“睁开眼”看一看自己现在装备了哪些 MCP 工具，然后动态组装自己的大脑和手脚。</span></p></blockquote><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512102017379.png" alt="image-20251210201706159" style="zoom:50%;" /></p><h4 id='31-核心痛点与架构升级'><span>3.1 核心痛点与架构升级</span></h4><p><span>在第一阶段，我们的 Agent 初始化代码是静态写在文件顶部的：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 旧代码 (Static)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">tools</span> <span class="cm-operator">=</span> <span class="cm-variable">get_tools</span>() <span class="cm-comment"># 程序启动时执行一次，之后永远不变</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">agent</span> <span class="cm-operator">=</span> <span class="cm-variable">create_agent</span>(<span class="cm-operator">...</span>, <span class="cm-variable">tools</span><span class="cm-operator">=</span><span class="cm-variable">tools</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 74px;"></div><div class="CodeMirror-gutters" style="display: none; height: 74px;"></div></div></div></pre><p><span>这意味着：如果你在运行过程中通过 API 安装了一个新工具（比如 12306 查票），Agent 根本不知道，除非重启服务器。</span></p><p><span>解决方案：动态工厂函数</span></p><p><span>我们将编写一个异步函数 build_dynamic_agent()。每次调用它时，它都会：</span></p><ol><li><p><span>去 </span><code>MCPManager</code><span> 查询最新激活的工具列表。</span></p></li><li><p><span>尝试连接这些工具（握手）。</span></p></li><li><p><strong><span>动态生成 System Prompt</span></strong><span>（告诉模型：“你现在拥有查询火车票的能力...”）。</span></p></li><li><p><span>返回一个新的、装备齐全的 Agent 实例。</span></p></li></ol><h4 id='32-代码重构实战-backendagentpy'><span>3.2 代码重构实战 (</span><code>backend/agent.py</code><span>)</span></h4><p><span>请使用以下代码</span><strong><span>完全覆盖</span></strong><span>原本的 </span><code>backend/agent.py</code><span>。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">asyncio</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">typing</span> <span class="cm-keyword">import</span> <span class="cm-variable">List</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1. 引入 LangChain 和 DeepSeek 组件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain_deepseek</span> <span class="cm-keyword">import</span> <span class="cm-variable">ChatDeepSeek</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain</span>.<span class="cm-property">agents</span> <span class="cm-keyword">import</span> <span class="cm-variable">create_agent</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain_core</span>.<span class="cm-property">tools</span> <span class="cm-keyword">import</span> <span class="cm-variable">BaseTool</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2. 引入 MCP 官方适配器 (连接的核心)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain_mcp_adapters</span>.<span class="cm-property">client</span> <span class="cm-keyword">import</span> <span class="cm-variable">MultiServerMCPClient</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 3. 引入本地模块</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">tools</span> <span class="cm-keyword">import</span> <span class="cm-variable">get_tools</span> <span class="cm-keyword">as</span> <span class="cm-variable">get_builtin_tools</span> &nbsp;<span class="cm-comment"># 始终存在的内置工具</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">mcp_manager</span> <span class="cm-keyword">import</span> <span class="cm-variable">MCPManager</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 全局实例化 Manager</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 注意：这里只是实例化管理类，并不读取具体配置，配置是在函数内动态读取的</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">mgr</span> <span class="cm-operator">=</span> <span class="cm-variable">MCPManager</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">build_dynamic_agent</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  [核心工厂函数]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  每次对话前调用。动态组装【内置工具】+【已激活 MCP 工具】，并生成动态 Prompt。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Step 1: 收集所有工具 (Tools Assembly)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 1.1 获取内置工具 (Weather, Tavily) - 这些永远在线</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">tools</span>: <span class="cm-variable">List</span>[<span class="cm-variable">BaseTool</span>] <span class="cm-operator">=</span> <span class="cm-variable">get_builtin_tools</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 1.2 获取当前激活的 MCP 配置 (从 mcp_config.json 读取)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># mgr.get_active_config() 内部会强制重读文件，确保配置最新</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mcp_config</span> <span class="cm-operator">=</span> <span class="cm-variable">mgr</span>.<span class="cm-property">get_active_config</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mcp_tools</span>: <span class="cm-variable">List</span>[<span class="cm-variable">BaseTool</span>] <span class="cm-operator">=</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 1.3 动态挂载 MCP 工具</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">mcp_config</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 建立连接客户端</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># MultiServerMCPClient 会根据 config 自动处理 StdIO/SSE 连接</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">client</span> <span class="cm-operator">=</span> <span class="cm-variable">MultiServerMCPClient</span>(<span class="cm-variable">mcp_config</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 获取工具列表 (增加 3秒 超时控制，防止某个工具卡死拖累整个 Agent)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># wait_for 是生产环境必须的，防止“一粒老鼠屎坏了一锅粥”</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mcp_tools</span> <span class="cm-operator">=</span> <span class="cm-keyword">await</span> <span class="cm-variable">asyncio</span>.<span class="cm-property">wait_for</span>(<span class="cm-variable">client</span>.<span class="cm-property">get_tools</span>(), <span class="cm-variable">timeout</span><span class="cm-operator">=</span><span class="cm-number">3.0</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"🔌 [Agent Factory] 已动态挂载 </span>{<span class="cm-builtin">len</span>(<span class="cm-variable">mcp_tools</span>)}<span class="cm-string"> 个 MCP 工具"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">asyncio</span>.<span class="cm-property">TimeoutError</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"⚠️ [Agent Factory] MCP 挂载超时 (3s)，将降级运行，仅使用内置工具。"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">Exception</span> <span class="cm-keyword">as</span> <span class="cm-variable">e</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"⚠️ [Agent Factory] MCP 挂载失败: </span>{<span class="cm-variable">e</span>}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 合并工具列表：内置 + 外挂</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">all_tools</span> <span class="cm-operator">=</span> <span class="cm-variable">tools</span> <span class="cm-operator">+</span> <span class="cm-variable">mcp_tools</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Step 2: 动态构建系统提示词 (Dynamic Prompting)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 2.1 生成工具清单字符串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 让模型明确知道自己现在能干什么，这比单纯 bind_tools 更有效</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">tool_descriptions</span> <span class="cm-operator">=</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">t</span> <span class="cm-keyword">in</span> <span class="cm-variable">all_tools</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 提取工具名和第一行描述</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">desc</span> <span class="cm-operator">=</span> <span class="cm-variable">t</span>.<span class="cm-property">description</span>.<span class="cm-property">split</span>(<span class="cm-string">'\n'</span>)[<span class="cm-number">0</span>] <span class="cm-keyword">if</span> <span class="cm-variable">t</span>.<span class="cm-property">description</span> <span class="cm-keyword">else</span> <span class="cm-string">"无描述"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">tool_descriptions</span>.<span class="cm-property">append</span>(<span class="cm-string">f"- **</span>{<span class="cm-variable">t</span>.<span class="cm-property">name</span>}<span class="cm-string">**: </span>{<span class="cm-variable">desc</span>}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">tools_str</span> <span class="cm-operator">=</span> <span class="cm-string">"\n"</span>.<span class="cm-property">join</span>(<span class="cm-variable">tool_descriptions</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 2.2 编写动态 Prompt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 采用 ReAct 标准结构，并注入工具清单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">system_prompt</span> <span class="cm-operator">=</span> <span class="cm-string">f"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  你是一个功能强大的全能 AI 智能体。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  ### 🛠️ 你当前拥有的工具能力：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp;</span>{<span class="cm-variable">tools_str</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  ### 🧠 思考与行动指南：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  1. **优先使用工具**：如果用户的请求可以通过上述工具解决，请务必调用工具。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  2. **内置工具规则**：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp; - 查询天气 -&gt; 必须使用 `get_weather`。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp; - 搜索新闻/实时信息 -&gt; 必须使用 `search_tool` (Tavily)。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  3. **MCP 工具规则**：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &nbsp; - 请仔细阅读工具列表。如果用户请求涉及数据库、文件操作或特定服务（如地图），请调用对应的 MCP 工具。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  4. **语言**：始终使用简体中文回答用户。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  现在，请根据用户的输入，灵活选择工具开始工作。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Step 3: 创建并返回 Agent 实例</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 显式开启 streaming=True，适配 Mac/Linux 环境</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">model</span> <span class="cm-operator">=</span> <span class="cm-variable">ChatDeepSeek</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">model</span><span class="cm-operator">=</span><span class="cm-string">"deepseek-chat"</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">temperature</span><span class="cm-operator">=</span><span class="cm-number">0</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">streaming</span><span class="cm-operator">=</span><span class="cm-keyword">True</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># create_agent 内部会将 all_tools 绑定到模型 (bind_tools)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">agent</span> <span class="cm-operator">=</span> <span class="cm-variable">create_agent</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">model</span><span class="cm-operator">=</span><span class="cm-variable">model</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">tools</span><span class="cm-operator">=</span><span class="cm-variable">all_tools</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">system_prompt</span><span class="cm-operator">=</span><span class="cm-variable">system_prompt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">agent</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 3011px;"></div><div class="CodeMirror-gutters" style="display: none; height: 3011px;"></div></div></div></pre><p><span>代码解释：</span></p><p><strong><span>1. 为什么要用 </span><code>asyncio.wait_for</code><span>？（生产环境生存法则）</span></strong></p><ul><li><p><strong><span>场景</span></strong><span>：你配置了一个远程 MCP 工具（如高德地图），但公司网络突然断了，或者对方服务器挂了。</span></p></li><li><p><strong><span>后果</span></strong><span>：如果没有超时控制，</span><code>client.get_tools()</code><span> 可能会无限期挂起（Hang），导致前端用户看到聊天框一直转圈，没有任何反应。</span></p></li><li><p><strong><span>策略</span></strong><span>：设置 3 秒超时。连不上就</span><strong><span>“断臂求生”</span></strong><span>（降级运行），至少让基础聊天和天气功能还能用，而不是整个系统瘫痪。</span></p></li></ul><p><strong><span>2. 动态 Prompt 的价值 (Context Awareness)</span></strong></p><ul><li><p><span>我们不仅把工具传给了 </span><code>bind_tools</code><span>（让模型在底层 API 层面知道工具），还在 System Prompt 里用自然语言列了一遍清单。</span></p></li><li><p><strong><span>原理</span></strong><span>：DeepSeek 这类模型具有极强的 Context 学习能力。当你明确告诉它“你现在拥有 </span><code>sqlite_query</code><span> 工具”时，它在进行复杂任务规划时（Reasoning）会更倾向于使用该工具，从而提高工具调用的</span><strong><span>召回率（Recall）</span></strong><span>。</span></p></li></ul><p><strong><span>3. 混合工具链 (Hybrid Toolchain)</span></strong></p><ul><li><p><code>all_tools = tools + mcp_tools</code></p></li><li><p><span>这行代码体现了架构的</span><strong><span>分层思想</span></strong><span>：基础能力（天气/搜索）是</span><strong><span>基建</span></strong><span>，雷打不动；MCP 能力是</span><strong><span>插件</span></strong><span>，随需而变。这为企业定制化开发提供了极大的灵活性。</span></p></li></ul><h3 id='4-接口层升级开放-mcp-管理能力-interface-layer'><span>4. 接口层升级：开放 MCP 管理能力 (Interface Layer)</span></h3><blockquote><p><span>开发目标：目前我们的 server.py 还停留在 MVP 阶段，它只认识“聊天”这一个指令。</span></p><p><span>在本节中，我们将把 server.py 升级为全功能的 Agent 操作系统网关。我们需要实现两类新接口：</span></p><ol><li><p><strong><span>控制面（Control Plane）</span></strong><span>：用于管理 MCP 工具的安装、测试、搜索和开关。</span></p></li><li><p><strong><span>数据面（Data Plane）</span></strong><span>：改造聊天接口，使其支持动态 Agent 的实时加载。</span></p></li></ol></blockquote><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512102020832.png" alt="image-20251210202015595" style="zoom:50%;" /></p><h4 id='41-定义数据契约pydantic-模型设计'><span>4.1 定义数据契约：Pydantic 模型设计</span></h4><p><span>在企业级 API 开发中，</span><strong><span>“契约先行”</span></strong><span>是铁律。我们需要先定义前端传给我们的数据长什么样。这不仅能自动生成 Swagger 文档，还能防止前端传错参数导致后端崩溃。</span></p><p><span>请在 </span><code>server.py</code><span> 的头部（Pydantic 模型区域）</span><strong><span>追加</span></strong><span>以下定义：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># server.py (追加代码)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- MCP 管理相关的数据模型 ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">MCPSearchRequest</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""用户输入的自然语言需求"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">query</span>: <span class="cm-builtin">str</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">MCPInstallRequest</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""安装/修改单个工具的请求体"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">name</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">description</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">type</span>: <span class="cm-builtin">str</span> &nbsp; &nbsp; &nbsp; <span class="cm-comment"># "stdio" 或 "sse"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">config</span>: <span class="cm-builtin">dict</span> &nbsp; &nbsp;<span class="cm-comment"># 包含 command, args, url, headers 等核心参数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">MCPBatchInstallRequest</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""批量安装请求体 (用于 AI 推荐后的批量采纳)"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">tools</span>: <span class="cm-variable">List</span>[<span class="cm-variable">MCPInstallRequest</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">MCPToggleRequest</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""开关状态请求体"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">active</span>: <span class="cm-builtin">bool</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">MCPTestRequest</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""连接测试请求体 (不保存，仅运行)"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">name</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">type</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">config</span>: <span class="cm-builtin">dict</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 716px;"></div><div class="CodeMirror-gutters" style="display: none; height: 716px;"></div></div></div></pre><p><span>代码解读：</span></p><ul><li><p><strong><span>为什么需要 </span><code>MCPTestRequest</code><span>？</span></strong><span> 注意它和 </span><code>MCPInstallRequest</code><span> 结构几乎一样，但业务语义不同。测试请求是</span><strong><span>无状态</span></strong><span>的（不写入磁盘），而安装请求是</span><strong><span>有状态</span></strong><span>的（写入磁盘）。区分定义有助于未来扩展（比如测试请求可能需要额外的超时参数）。</span></p></li><li><p><strong><code>config: dict</code><span> 的灵活性</span></strong><span>：我们没有把 </span><code>config</code><span> 里的字段（如 url, command）写死，而是用 </span><code>dict</code><span>。这是为了兼容 MCP 协议的未来扩展，无论以后 MCP 推出什么新连接方式，这个接口都不用改。</span></p></li></ul><h4 id='42-实现管理接口打造-agent-的控制面板'><span>4.2 实现管理接口：打造 Agent 的“控制面板”</span></h4><p><span>接下来，我们需要将 </span><code>MCPManager</code><span> 的功能映射为 HTTP 接口。</span></p><p><strong><span>修改动作</span></strong><span>：</span></p><ol><li><p><span>在 </span><code>server.py</code><span> 顶部导入 </span><code>MCPManager</code><span>。</span></p></li><li><p><span>实例化一个全局的 </span><code>mcp_manager</code><span>。</span></p></li><li><p><span>添加一系列路由函数。</span></p></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># server.py (新增导入与实例)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">mcp_manager</span> <span class="cm-keyword">import</span> <span class="cm-variable">MCPManager</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 初始化全局管理器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">mcp_manager</span> <span class="cm-operator">=</span> <span class="cm-variable">MCPManager</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ... (API 定义区域) ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; API 模块 2: MCP 工具管理</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">get</span>(<span class="cm-string">"/mcp/list"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">list_installed_mcp</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  [查询] 获取当前已安装的所有工具</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  前端页面加载时调用，用于渲染'我的工具'列表</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">mcp_manager</span>.<span class="cm-property">list_installed_tools</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">post</span>(<span class="cm-string">"/mcp/search_ai"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">search_mcp_ai</span>(<span class="cm-variable">req</span>: <span class="cm-variable">MCPSearchRequest</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  [智能] AI 推荐工具</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  连接 DeepSeek 模型，分析用户需求并查阅 Registry</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">await</span> <span class="cm-variable">mcp_manager</span>.<span class="cm-property">ai_recommend_tools</span>(<span class="cm-variable">req</span>.<span class="cm-property">query</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">post</span>(<span class="cm-string">"/mcp/install"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">install_mcp_tool</span>(<span class="cm-variable">req</span>: <span class="cm-variable">MCPInstallRequest</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  [写入] 安装或更新单个工具</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  包含智能拆包与路径修正逻辑</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mcp_manager</span>.<span class="cm-property">save_tool</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span><span class="cm-operator">=</span><span class="cm-variable">req</span>.<span class="cm-property">name</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">description</span><span class="cm-operator">=</span><span class="cm-variable">req</span>.<span class="cm-property">description</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">type</span><span class="cm-operator">=</span><span class="cm-variable">req</span>.<span class="cm-property">type</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">config_dict</span><span class="cm-operator">=</span><span class="cm-variable">req</span>.<span class="cm-property">config</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> {<span class="cm-string">"status"</span>: <span class="cm-string">"success"</span>, <span class="cm-string">"message"</span>: <span class="cm-string">f"工具 </span>{<span class="cm-variable">req</span>.<span class="cm-property">name</span>}<span class="cm-string"> 已保存"</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">Exception</span> <span class="cm-keyword">as</span> <span class="cm-variable">e</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">raise</span> <span class="cm-variable">HTTPException</span>(<span class="cm-variable">status_code</span><span class="cm-operator">=</span><span class="cm-number">500</span>, <span class="cm-variable">detail</span><span class="cm-operator">=</span><span class="cm-builtin">str</span>(<span class="cm-variable">e</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">post</span>(<span class="cm-string">"/mcp/install_batch"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">install_mcp_batch</span>(<span class="cm-variable">req</span>: <span class="cm-variable">MCPBatchInstallRequest</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  [批量写入] 一键安装多个工具</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">tool</span> <span class="cm-keyword">in</span> <span class="cm-variable">req</span>.<span class="cm-property">tools</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mcp_manager</span>.<span class="cm-property">save_tool</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span><span class="cm-operator">=</span><span class="cm-variable">tool</span>.<span class="cm-property">name</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">description</span><span class="cm-operator">=</span><span class="cm-variable">tool</span>.<span class="cm-property">description</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">type</span><span class="cm-operator">=</span><span class="cm-variable">tool</span>.<span class="cm-property">type</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">config_dict</span><span class="cm-operator">=</span><span class="cm-variable">tool</span>.<span class="cm-property">config</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">+=</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> {<span class="cm-string">"status"</span>: <span class="cm-string">"success"</span>, <span class="cm-string">"message"</span>: <span class="cm-string">f"已批量添加 </span>{<span class="cm-variable">count</span>}<span class="cm-string"> 个工具"</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">post</span>(<span class="cm-string">"/mcp/test_connection"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">test_mcp_connection</span>(<span class="cm-variable">req</span>: <span class="cm-variable">MCPTestRequest</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  [测试] 连接试运行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  这是用户体验最关键的一环，确保'先测后存'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">success</span>, <span class="cm-variable">msg</span> <span class="cm-operator">=</span> <span class="cm-keyword">await</span> <span class="cm-variable">mcp_manager</span>.<span class="cm-property">test_tool_connection</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span><span class="cm-operator">=</span><span class="cm-variable">req</span>.<span class="cm-property">name</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">type</span><span class="cm-operator">=</span><span class="cm-variable">req</span>.<span class="cm-property">type</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">config_dict</span><span class="cm-operator">=</span><span class="cm-variable">req</span>.<span class="cm-property">config</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> {<span class="cm-string">"success"</span>: <span class="cm-variable">success</span>, <span class="cm-string">"message"</span>: <span class="cm-variable">msg</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">post</span>(<span class="cm-string">"/mcp/toggle/{tool_name}"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">toggle_mcp</span>(<span class="cm-variable">tool_name</span>: <span class="cm-builtin">str</span>, <span class="cm-variable">req</span>: <span class="cm-variable">MCPToggleRequest</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  [状态] 激活或禁用工具</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mcp_manager</span>.<span class="cm-property">toggle_tool</span>(<span class="cm-variable">tool_name</span>, <span class="cm-variable">req</span>.<span class="cm-property">active</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> {<span class="cm-string">"status"</span>: <span class="cm-string">"success"</span>, <span class="cm-string">"active"</span>: <span class="cm-variable">req</span>.<span class="cm-property">active</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">delete</span>(<span class="cm-string">"/mcp/{tool_name}"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">uninstall_mcp</span>(<span class="cm-variable">tool_name</span>: <span class="cm-builtin">str</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  [删除] 卸载工具</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mcp_manager</span>.<span class="cm-property">delete_tool</span>(<span class="cm-variable">tool_name</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> {<span class="cm-string">"status"</span>: <span class="cm-string">"success"</span>}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 2246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 2246px;"></div></div></div></pre><h4 id='43-核心重构聊天接口的动态化改造'><span>4.3 核心重构：聊天接口的“动态化”改造</span></h4><p><span>这是本次升级的</span><strong><span>心脏手术</span></strong><span>。我们要废弃原来那个静态的 </span><code>static_agent</code><span>，改为在每次请求时调用 </span><code>build_dynamic_agent()</code><span> 工厂。</span></p><p><strong><span>修改步骤</span></strong><span>：</span></p><ol><li><p><strong><span>修改导入</span></strong><span>：将 </span><code>from agent import agent</code><span> 改为 </span><code>from agent import build_dynamic_agent</code><span>。</span></p></li><li><p><strong><span>重写 </span><code>chat_stream</code></strong><span>：引入异步构建逻辑。</span></p></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># server.py (核心重构部分)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1. 导入修正</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">agent</span> <span class="cm-keyword">import</span> <span class="cm-variable">build_dynamic_agent</span> &nbsp;<span class="cm-comment"># &lt;--- 关键修改</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">post</span>(<span class="cm-string">"/chat_stream"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">chat_stream</span>(<span class="cm-variable">request</span>: <span class="cm-variable">ChatRequest</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  核心对话接口 (动态版)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  每次请求都会重新组装 Agent，从而让新安装的 MCP 工具即时生效。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ... (历史记录加载逻辑不变) ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 🚀 核心变化: 动态构建 Agent</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 调用工厂函数，读取 mcp_config.json，连接所有工具</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 如果某个工具连不上，工厂内部会自动降级，保证这里不崩</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">current_agent</span> <span class="cm-operator">=</span> <span class="cm-keyword">await</span> <span class="cm-variable">build_dynamic_agent</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">Exception</span> <span class="cm-keyword">as</span> <span class="cm-variable">e</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 如果连工厂都崩了（极端情况），返回错误流给前端</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"❌ Agent 构建失败: </span>{<span class="cm-variable">e</span>}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">error_gen</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">yield</span> <span class="cm-variable">format_sse</span>(<span class="cm-string">"error"</span>, {<span class="cm-string">"message"</span>: <span class="cm-string">f"Agent 初始化失败: </span>{<span class="cm-builtin">str</span>(<span class="cm-variable">e</span>)}<span class="cm-string">"</span>})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">yield</span> <span class="cm-variable">format_sse</span>(<span class="cm-string">"finish"</span>, {<span class="cm-string">"status"</span>: <span class="cm-string">"error"</span>})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">StreamingResponse</span>(<span class="cm-variable">error_gen</span>(), <span class="cm-variable">media_type</span><span class="cm-operator">=</span><span class="cm-string">"text/event-stream"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ... (后续的 event_generator 逻辑与之前基本一致) ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 记得加上我们之前修复的 format_sse 序列化补丁</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 814px;"></div><div class="CodeMirror-gutters" style="display: none; height: 814px;"></div></div></div></pre><h4 id='44-完整代码交付最终版-serverpy'><span>4.4 完整代码交付：最终版 </span><code>server.py</code></h4><p><span>为了方便大家核对代码，这里提供了融合上述所有修改的</span><strong><span>最终完整版 </span><code>server.py</code></strong><span>。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.3398px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># server.py</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">uvicorn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">os</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">json</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">asyncio</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">typing</span> <span class="cm-keyword">import</span> <span class="cm-variable">List</span>, <span class="cm-variable">Dict</span>, <span class="cm-variable">Optional</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">dotenv</span> <span class="cm-keyword">import</span> <span class="cm-variable">load_dotenv</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">fastapi</span> <span class="cm-keyword">import</span> <span class="cm-variable">FastAPI</span>, <span class="cm-variable">HTTPException</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">fastapi</span>.<span class="cm-property">middleware</span>.<span class="cm-property">cors</span> <span class="cm-keyword">import</span> <span class="cm-variable">CORSMiddleware</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">fastapi</span>.<span class="cm-property">responses</span> <span class="cm-keyword">import</span> <span class="cm-variable">StreamingResponse</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">pydantic</span> <span class="cm-keyword">import</span> <span class="cm-variable">BaseModel</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain_core</span>.<span class="cm-property">messages</span> <span class="cm-keyword">import</span> <span class="cm-variable">HumanMessage</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">fastapi</span>.<span class="cm-property">responses</span> <span class="cm-keyword">import</span> <span class="cm-variable">FileResponse</span> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- 导入本地模块 ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 请确保 agent.py 中有 build_agent_with_mcp 函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 请确保 history.py, mcp_manager.py 文件存在且最新</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">history</span> <span class="cm-keyword">import</span> <span class="cm-variable">HistoryManager</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">mcp_manager</span> <span class="cm-keyword">import</span> <span class="cm-variable">MCPManager</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">agent</span> <span class="cm-keyword">import</span> <span class="cm-variable">build_dynamic_agent</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1. 加载环境变量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">load_dotenv</span>(<span class="cm-variable">override</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2. 初始化 FastAPI</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">app</span> <span class="cm-operator">=</span> <span class="cm-variable">FastAPI</span>(<span class="cm-variable">title</span><span class="cm-operator">=</span><span class="cm-string">"Creative Agent Backend"</span>, <span class="cm-variable">version</span><span class="cm-operator">=</span><span class="cm-string">"4.0 (MCP Edition)"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 3. 配置跨域 (CORS) - 允许前端所有访问</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">app</span>.<span class="cm-property">add_middleware</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CORSMiddleware</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">allow_origins</span><span class="cm-operator">=</span>[<span class="cm-string">"*"</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">allow_credentials</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">allow_methods</span><span class="cm-operator">=</span>[<span class="cm-string">"*"</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">allow_headers</span><span class="cm-operator">=</span>[<span class="cm-string">"*"</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 4. 初始化核心管理器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># history_manager 在每次请求时动态实例化</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">mcp_manager</span> <span class="cm-operator">=</span> <span class="cm-variable">MCPManager</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-string">f"🚀 Server 初始化完成"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-string">f"📂 历史记录路径: </span>{<span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">abspath</span>(<span class="cm-string">'chat_history'</span>)}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-string">f"🛠️ MCP 配置文件: </span>{<span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">abspath</span>(<span class="cm-string">'mcp_config.json'</span>)}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp;  Pydantic 数据模型定义</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- 聊天相关 ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">ChatRequest</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">query</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">session_id</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">RenameRequest</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">title</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">SessionItem</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">id</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">title</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">updated_at</span>: <span class="cm-builtin">int</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- MCP 管理相关 ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">MCPSearchRequest</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">query</span>: <span class="cm-builtin">str</span> &nbsp;<span class="cm-comment"># 用户输入的自然语言需求</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">MCPInstallRequest</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""用于安装或修改单个 MCP 工具"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">name</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">description</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">type</span>: <span class="cm-builtin">str</span> &nbsp; &nbsp; &nbsp; <span class="cm-comment"># "stdio" 或 "sse"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">config</span>: <span class="cm-builtin">dict</span> &nbsp; &nbsp;<span class="cm-comment"># 包含 command, args, url, headers 等</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">MCPBatchInstallRequest</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""用于批量安装 (AI推荐列表勾选后一键安装)"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">tools</span>: <span class="cm-variable">List</span>[<span class="cm-variable">MCPInstallRequest</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">MCPToggleRequest</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">active</span>: <span class="cm-builtin">bool</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">MCPTestRequest</span>(<span class="cm-variable">BaseModel</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""用于连接测试"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">name</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">type</span>: <span class="cm-builtin">str</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">config</span>: <span class="cm-builtin">dict</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; API 模块 1: 会话管理</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ==========================================</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">get</span>(<span class="cm-string">"/sessions"</span>, <span class="cm-variable">response_model</span><span class="cm-operator">=</span><span class="cm-variable">List</span>[<span class="cm-variable">SessionItem</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">get_sessions</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""获取会话列表"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">HistoryManager</span>.<span class="cm-property">get_all_sessions</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@app</span>.<span class="cm-property">post</span>(<span class="cm-string">"/sessions"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">async</span> <span class="cm-keyword">def</span> <span class="cm-def">create_session</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""创建新会话"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">import</span> <span class="cm-variable">uuid</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">import</span> <span class="cm-variable">time</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"id"</span>: <span class="cm-builtin">str</span>(<span class="cm-variable">uuid</span>.<span class="cm-property">uuid4</span>()),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"title"</span>: <span class="cm-string">"新对话"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"updated_at"</span>: <span class="cm-builtin">int</span>(<span class="cm-variable">time</span>.<span class="cm-property">time</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">......</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 2641px;"></div><div class="CodeMirror-gutters" style="display: none; height: 2641px;"></div></div></div></pre><p><strong><span>1. 关于“单例模式”与“工厂模式”的抉择</span></strong></p><ul><li><p><strong><span>MVP 阶段（单例）</span></strong><span>：我们在程序启动时创建了一个全局 </span><code>agent</code><span> 对象。这样做的好处是响应快（不需要每次都初始化），坏处是</span><strong><span>“僵化”</span></strong><span>——配置改了，Agent 不知道。</span></p></li><li><p><strong><span>Pro 阶段（工厂）</span></strong><span>：我们在每次请求时 </span><code>await build_dynamic_agent()</code><span>。</span></p><ul><li><p><strong><span>质疑</span></strong><span>：这样不会慢吗？</span></p></li><li><p><strong><span>回答</span></strong><span>：</span><strong><span>会，但值得。</span></strong><span> MCP 的连接建立通常在毫秒级（本地）或百毫秒级（SSE）。对于一个对话系统来说，用户发出消息后等待 0.5 秒再开始生成，完全在可接受范围内。换来的是</span><strong><span>极致的灵活性</span></strong><span>——这在企业级架构中被称为“可配置性优先（Configurability First）”。</span></p></li></ul></li></ul><p><strong><span>2. 异常处理的艺术</span></strong></p><ul><li><p><span>注意看我们在 </span><code>chat_stream</code><span> 里加的 </span><code>try...except</code><span>。</span></p></li><li><p><span>在微服务架构中，</span><strong><span>依赖服务（MCP 工具）的故障不能导致主服务（Chat）的崩溃</span></strong><span>。如果 12306 的接口挂了，Agent 应该报错说“我连不上购票系统”，而不是整个网页白屏。这就是我们在代码中极力保证的</span><strong><span>鲁棒性（Robustness）</span></strong><span>。</span></p></li></ul><h3 id='5-全链路联调与验收-integration-testing'><span>5. 全链路联调与验收 (Integration Testing)</span></h3><blockquote><p><span>实战任务：代码写完了，现在我们要像真正的 QA（测试工程师）一样，验证我们的系统是否达标。</span></p></blockquote><p><strong><span>验证清单：</span></strong></p><ol><li><p><strong><span>场景一：本地能力闭环</span></strong></p><ul><li><p><span>操作：在前端“应用商店”搜索“时间”，点击安装。</span></p></li><li><p><span>验证：发送“现在几点了”。</span></p></li><li><p><span>预期：Agent 准确报出当前时间（精确到秒），且日志显示调用了 </span><code>get_current_time</code><span>。</span></p></li></ul></li><li><p><strong><span>场景二：跨网络能力集成</span></strong></p><ul><li><p><span>操作：手动添加“高德地图”工具（SSE 类型），填入 Key。</span></p></li><li><p><span>验证：点击“测试连接”，看到绿色的成功提示。</span></p></li><li><p><span>验证：发送“查一下西湖周边的咖啡馆”。</span></p></li><li><p><span>预期：Agent 返回真实的地理位置信息列表。</span></p></li></ul></li><li><p><strong><span>场景三：热插拔测试</span></strong></p><ul><li><p><span>操作：在对话中途，去列表里把“时间工具”的开关关掉。</span></p></li><li><p><span>验证：再次问“现在几点了”。</span></p></li><li><p><span>预期：Agent 回复“抱歉，我没有查询时间的工具...”（因为它真的失去了这个能力）。这一刻，你将深刻体会到什么是</span><strong><span>“动态 Agent”</span></strong><span>。</span></p></li></ul></li></ol><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><hr /><ul><li><p><span>体验课内容节选自</span><a href='https://ix9mq.xetslk.com/s/3qeesJ'><span>《2025大模型Agent智能体开发实战》(12月班)</span></a><span>完整版付费课程</span></p></li></ul><p>&emsp;&emsp;<span>体验课时间有限，若想深度学习大模型技术，欢迎大家报名由我主讲的</span><a href='https://ix9mq.xetslk.com/s/3qeesJ'><span>《2025大模型Agent智能体开发实战》(12月班)</span></a></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/ac4f2a592e0453c3089da3643ee3404a.png" alt="b3a518f1a9821408a79363cf694f5172" style="zoom:50%;" /></p><p><strong><a href='https://ix9mq.xetslk.com/s/3qeesJ'><span>《2025大模型Agent智能体开发实战》(12月班)</span></a><span>为【100+小时】体系大课，总共20大模块精讲精析，零基础直达大模型企业级应用！</span></strong></p><h3 id='课程完整介绍'><span>课程完整介绍</span></h3><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202506172010074.png" alt="a55d48e952ed59f8d93e050594843bc" style="zoom:50%;" /></p><h3 id='12月新班新增内容'><span>12月新班新增内容</span></h3><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/6ee2fbee6b72608bee2888620fac1932.png" alt="4d219626fc8186add0dd2d39602c7475" style="zoom: 50%;" /></p><h3 id='部分课程成果演示'><span>部分课程成果演示</span></h3><ul><li><p><span>Dify+DeepSeek搭建智能客服</span></p></li></ul><video src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/2f1b47f42c65fd59e8d3a83e6cb9f13b_raw.mp4"></video><ul><li><p><span>Coze自动图文视频创作流程</span></p></li></ul><video src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/Coze%E5%8A%A8%E6%80%81%E8%A7%86%E9%A2%91%E7%94%9F%E6%88%90%E5%AE%9E%E4%BE%8B.mp4"></video><ul><li><p><span>可视化数据分析Multi-Agent</span></p></li></ul><video src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/%E5%8F%AF%E8%A7%86%E5%8C%96%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90Multi-Agent%E6%95%88%E6%9E%9C%E6%BC%94%E7%A4%BA%E6%95%88%E6%9E%9C.mp4"></video><ul><li><p><span>Ollama 自动化并发请求测试与动态资源监控</span></p></li></ul><video src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/3.Ollama%20%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B9%B6%E5%8F%91%E8%AF%B7%E6%B1%82%E6%B5%8B%E8%AF%95%E4%B8%8E%E5%8A%A8%E6%80%81%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7.mp4"></video><ul><li><p><span>Neo4j并行多线程导入百万级文本方法与实践</span></p></li></ul><video src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/2.Neo4j%E5%B9%B6%E8%A1%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AF%BC%E5%85%A5%E7%99%BE%E4%B8%87%E7%BA%A7%E6%96%87%E6%9C%AC%E6%96%B9%E6%B3%95%E4%B8%8E%E5%AE%9E%E6%88%98%E6%BC%94%E7%A4%BA.mp4"></video><ul><li><p><span>高效微调全自动数据集创建</span></p></li></ul><video src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/easy_daset_yanshi.mp4"></video><ul><li><p><span>MateGen Pro 项目功能演示</span></p></li></ul><video src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/MG%E6%BC%94%E7%A4%BA%E8%A7%86%E9%A2%91.mp4"></video><ul><li><p><span>智能客服项目展示</span></p></li></ul><video src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/%E6%99%BA%E8%83%BD%E5%AE%A2%E6%9C%8D%E6%A1%88%E4%BE%8B%E8%A7%86%E9%A2%91.mp4"></video><ul><li><p><strong><span>GraphRAG+多模态文档检索</span></strong></p></li></ul><video src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/7%E6%9C%8817%E6%97%A5%281%29%20%E8%BF%9B%E5%BA%A6%E6%9D%A1.mp4"></video><p><span>此外，若是对大模型底层原理感兴趣，也欢迎报名由我和菜菜老师共同主讲的</span><a href='https://ix9mq.xetslk.com/s/16asFh'><span>《2025大模型原理与实战课程》(秋季班)</span></a></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/a9c8776df826a9ee8e9fb8e31c72b180.png" alt="a9c8776df826a9ee8e9fb8e31c72b180" style="zoom: 20%;" /></p><p><strong><span>大模型双十一特惠进行时，直播间享五折特价+全套SVIP新班特定福利，合购还有更多优惠哦</span></strong><span>~</span></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/3.png" alt="0232543d2ca04768bfd5d9ea86961737" style="zoom:50%;" /></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512102014091.jpg" alt="282126fbd48fc7124eaaa5ce9761443e" style="zoom:33%;" /></p><p><strong><span style="color:red;"><span>详细信息扫码添加助教，回复“大模型”，即可领取课程大纲&amp;查看课程详情👇</span></span></strong></p><p><img src="https://ml2022.oss-cn-hangzhou.aliyuncs.com/img/202512091835408.png" alt="a76e6238d7b180153150578da261689d" style="zoom:50%;" /></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p></div></div>
</body>
</html>